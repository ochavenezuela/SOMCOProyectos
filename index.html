<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyectos Humanitarios Zulia y Falcón - OCHA</title>
    <link rel="icon" type="image/png" href="https://images4.imagebam.com/f2/74/67/MEZQJH3_o.PNG">
    
    <!-- External Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            /* OCHA Color Palette */
            --ocha-blue: #007DBC;
            --ocha-dark-blue: #005A8A;
            --ocha-light-blue: #E8F4F8;
            --ocha-orange: #ECA154;
            --ocha-dark-orange: #D2691E;
            --ocha-gray: #5A5A5A;
            --ocha-light-gray: #F5F5F5;
            --ocha-dark-gray: #3A3A3A;
            --ocha-white: #FFFFFF;
            --ocha-red: #CD3A1F;
            --ocha-green: #7DBA00;
            --ocha-purple: #5B92E5;
            
            /* Humanitarian Sector Colors */
            --sector-salud: #EF5350;
            --sector-proteccion: #9575CD;
            --sector-wash: #4FC3F7;
            --sector-educacion: #81C784;
            --sector-nutricion: #FFB74D;
            --sector-seguridad-alimentaria: #AED581;
            --sector-medios-vida: #A1887F;
            --sector-alojamiento: #78909C;
            --sector-vbg: #F06292;
            --sector-coordinacion: #90A4AE;
            
            /* Shadows and Effects */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --border-radius: 12px;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }

        body {
            font-family: 'Roboto Condensed', Arial, sans-serif;
            background-color: var(--ocha-light-gray);
            color: var(--ocha-dark-gray);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1020;
            border-top: 4px solid var(--ocha-blue);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-brand { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
        }
        
        .header-logo { 
            height: 60px; 
        }
        
        .header-title h1 { 
            font-family: 'Roboto Slab', serif; 
            font-size: 1.6rem; 
            color: var(--ocha-blue); 
            margin: 0; 
        }
        
        .header-subtitle { 
            font-size: 0.9rem; 
            color: var(--ocha-gray); 
            margin-top: 0.25rem; 
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Main Container */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
            flex: 1;
            width: 100%;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            height: fit-content;
            position: sticky;
            top: 100px;
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }

        /* Date Filter Section */
        .date-filter-section {
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: var(--ocha-light-blue);
            border-radius: 8px;
        }

        .date-filter-title {
            font-size: 1rem;
            color: var(--ocha-dark-gray);
            margin-bottom: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-inputs {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .date-input-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--ocha-dark-gray);
        }

        .date-input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
            transition: border-color 0.3s;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--ocha-blue);
        }

        .date-slider-container {
            margin-top: 0.5rem;
        }

        .date-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            margin: 0.5rem 0;
        }

        .date-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--ocha-blue);
            cursor: pointer;
            transition: all 0.3s;
        }

        .date-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--ocha-blue);
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .date-slider::-webkit-slider-thumb:hover {
            background: var(--ocha-dark-blue);
            transform: scale(1.2);
        }

        .date-slider::-moz-range-thumb:hover {
            background: var(--ocha-dark-blue);
            transform: scale(1.2);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--ocha-gray);
            margin-top: 0.25rem;
        }

        /* Filter Section */
        .filter-section { 
            margin-bottom: 1.5rem; 
        }
        
        .filter-title {
            font-size: 1rem;
            color: var(--ocha-dark-gray);
            margin-bottom: 1rem;
            font-weight: 700;
            border-bottom: 2px solid var(--ocha-light-blue);
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .filter-title i { 
            color: var(--ocha-blue); 
        }

        .filter-select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            margin-bottom: 0.75rem;
        }

        /* Multi-select styles */
        .multi-select-container {
            position: relative;
            width: 100%;
            margin-bottom: 0.75rem;
        }

        .multi-select-display {
            width: 100%;
            padding: 0.7rem 0.8rem;
            border: 2px solid var(--ocha-light-blue);
            border-radius: 8px;
            font-size: 0.9rem;
            background: linear-gradient(135deg, rgba(232, 244, 248, 0.5) 0%, white 100%);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--ocha-dark-gray);
            box-shadow: 0 2px 4px rgba(0, 125, 188, 0.08);
        }

        .multi-select-display:hover {
            border-color: var(--ocha-blue);
            background: linear-gradient(135deg, var(--ocha-light-blue) 0%, white 100%);
            box-shadow: 0 4px 8px rgba(0, 125, 188, 0.15);
            transform: translateY(-1px);
        }

        .multi-select-display i {
            color: var(--ocha-blue);
            transition: transform 0.3s ease;
        }

        .multi-select-display.open i {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--ocha-blue);
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 16px rgba(0, 125, 188, 0.2);
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .multi-select-dropdown.open {
            display: block;
        }

        .multi-select-option {
            padding: 0.65rem 0.8rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s ease;
        }

        .multi-select-option:last-child {
            border-bottom: none;
        }

        .multi-select-option:hover {
            background: var(--ocha-light-blue);
        }

        .multi-select-option input {
            margin-right: 0.75rem;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--ocha-blue);
        }

        .multi-select-option label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            font-size: 0.85rem;
            color: var(--ocha-dark-gray);
        }

        .multi-select-option #all-municipios {
            accent-color: var(--ocha-dark-blue);
        }

        /* Parish filter panel - shown only when 1 municipality is selected */
        #parroquiaFilterSection {
            display: none;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(0, 125, 188, 0.2);
        }
        #parroquiaFilterSection.visible { display: block; }
        .parroquia-filter-label {
            display: block; font-weight: 600; color: #5a5a5a;
            margin-bottom: 0.5rem; font-size: 0.9rem;
        }
        #parroquiaDropdown { max-height: 200px; overflow-y: auto; }

        /* Form parish multi-select */
        .form-parroquia-multi {
            width: 100%; border: 1px solid #ddd; border-radius: 6px;
            max-height: 160px; overflow-y: auto; padding: 0.4rem; background: white;
            box-sizing: border-box;
        }
        .form-parroquia-multi .parroquia-option {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.35rem 0.4rem; cursor: pointer; border-radius: 4px; font-size: 0.88rem;
        }
        .form-parroquia-multi .parroquia-option:hover { background: var(--ocha-light-blue); }
        .form-parroquia-fallback {
            width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;
            box-sizing: border-box; font-size: 0.95rem;
        }

        .multi-select-option:first-child {
            border-bottom: 2px solid var(--ocha-light-blue);
            background-color: rgba(0, 125, 188, 0.03);
            font-weight: 600;
        }

        /* Humanitarian Sector Icons Grid */
        .sector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
            max-height: 350px;
            overflow-y: auto;
            padding: 0.25rem;
        }

        .sector-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 0.75rem 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            background: var(--ocha-light-gray);
            min-height: 80px;
            justify-content: center;
        }

        .sector-item:hover { 
            background-color: var(--ocha-light-blue); 
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
        }
        
        .sector-item.active { 
            background-color: var(--ocha-blue); 
            color: white; 
            border-color: var(--ocha-dark-blue);
        }
        
        .sector-item.active .sector-icon { 
            color: white; 
        }

        .sector-icon {
            width: 32px;
            height: 32px;
            margin-bottom: 0.25rem;
            transition: opacity 0.3s;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .sector-item.active .sector-icon {
            filter: brightness(0) invert(1);
        }

        .sector-name { 
            font-size: 0.7rem; 
            font-weight: 600;
            line-height: 1.2;
        }

        /* Sector-specific colors */
        .sector-item[data-sector="salud"] .sector-icon { color: var(--sector-salud); }
        .sector-item[data-sector="proteccion"] .sector-icon { color: var(--sector-proteccion); }
        .sector-item[data-sector="wash"] .sector-icon { color: var(--sector-wash); }
        .sector-item[data-sector="educacion"] .sector-icon { color: var(--sector-educacion); }
        .sector-item[data-sector="nutricion"] .sector-icon { color: var(--sector-nutricion); }
        .sector-item[data-sector="seguridad-alimentaria"] .sector-icon { color: var(--sector-seguridad-alimentaria); }
        .sector-item[data-sector="medios-vida"] .sector-icon { color: var(--sector-medios-vida); }
        .sector-item[data-sector="alojamiento"] .sector-icon { color: var(--sector-alojamiento); }
        .sector-item[data-sector="vbg"] .sector-icon { color: var(--sector-vbg); }
        .sector-item[data-sector="coordinacion"] .sector-icon { color: var(--sector-coordinacion); }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-primary { 
            background-color: var(--ocha-blue); 
            color: white; 
        }
        .btn-primary:hover { 
            background-color: var(--ocha-dark-blue); 
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success { 
            background-color: var(--ocha-green); 
            color: white; 
        }
        .btn-success:hover { 
            background-color: #649600; 
        }
        
        .btn-secondary { 
            background-color: var(--ocha-gray); 
            color: white; 
        }
        .btn-secondary:hover { 
            background-color: var(--ocha-dark-gray); 
        }
        
        .btn-block { 
            width: 100%; 
            justify-content: center; 
        }

        /* Main Content */
        .main-content { 
            display: flex; 
            flex-direction: column; 
            gap: 1.5rem; 
        }

        /* KPI Section */
        .kpi-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .kpi-card {
            background: var(--ocha-light-blue);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border-left: 5px solid var(--ocha-blue);
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .kpi-icon {
            font-size: 2rem;
            color: var(--ocha-blue);
            margin-bottom: 0.5rem;
            opacity: 0.8;
        }

        .kpi-value { 
            font-size: 2.5rem; 
            font-weight: 700; 
            color: var(--ocha-blue); 
        }
        
        .kpi-label { 
            font-size: 0.9rem; 
            color: var(--ocha-gray); 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Map and Charts Container */
        .map-charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Map Section */
        .map-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 0;
            box-shadow: var(--shadow-sm);
            height: 600px;
            position: relative;
            overflow: hidden;
        }

        /* Charts Section */
        .charts-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            height: 285px;
        }

        .chart-title {
            font-family: 'Roboto Slab', serif;
            color: var(--ocha-blue);
            font-size: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .chart-container canvas {
            max-height: 220px;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: var(--border-radius);
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 0.85rem;
            max-width: 200px;
        }

        .map-disclaimer {
            position: absolute;
            bottom: 40px;
            left: 10px;
            right: 220px;
            background: rgba(255, 255, 255, 0.95);
            padding: 6px 10px;
            font-size: 0.7rem;
            color: #555;
            text-align: left;
            border-radius: 4px;
            z-index: 999;
            line-height: 1.3;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--ocha-blue);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #ccc;
        }

        /* Table Section */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-box { 
            position: relative; 
            flex-grow: 1; 
            max-width: 400px; 
        }
        
        .search-input { 
            width: 100%; 
            padding: 0.75rem 1rem 0.75rem 3rem; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 0.875rem; 
        }
        
        .search-icon { 
            position: absolute; 
            left: 1rem; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--ocha-gray); 
        }
        
        .table-actions { 
            display: flex; 
            gap: 0.5rem; 
            flex-wrap: wrap;
        }

        .table-wrapper { 
            overflow-x: auto; 
        }
        
        .projects-table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        
        .projects-table th { 
            background: var(--ocha-light-gray); 
            padding: 0.8rem; 
            text-align: left; 
            font-weight: 700; 
            color: var(--ocha-dark-gray); 
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: all 0.2s ease;
            padding: 0.8rem 1rem;
        }

        .sortable-header:hover {
            background: var(--ocha-blue-light);
            color: var(--ocha-blue);
        }

        .sort-indicator {
            margin-left: 8px;
            color: var(--ocha-blue);
            font-size: 0.9em;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }

        .sortable-header:hover .sort-indicator {
            opacity: 1;
        }

        .sort-indicator.asc {
            opacity: 1;
            color: var(--ocha-blue);
        }

        .sort-indicator.asc:before {
            content: "▲";
        }

        .sort-indicator.desc {
            opacity: 1;
            color: var(--ocha-blue);
        }

        .sort-indicator.desc:before {
            content: "▼";
        }
        
        .projects-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
        }
        
        .projects-table tr:hover {
            background: var(--ocha-light-blue);
        }
        
        .actions-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            color: var(--ocha-blue);
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 32px;
            height: 32px;
        }
        
        .action-btn:hover {
            background: var(--ocha-blue);
            color: white;
            border-color: var(--ocha-blue);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .action-btn.primary {
            background: var(--ocha-blue);
            color: white;
            border-color: var(--ocha-blue);
        }

        .action-btn.primary:hover {
            background: var(--ocha-dark-blue);
            border-color: var(--ocha-dark-blue);
        }

        .action-btn.success {
            background: var(--ocha-green);
            color: white;
            border-color: var(--ocha-green);
        }

        .action-btn.success:hover {
            background: #0f7b0f;
            border-color: #0f7b0f;
        }

        .action-btn.warning {
            background: var(--ocha-orange);
            color: white;
            border-color: var(--ocha-orange);
        }

        .action-btn.warning:hover {
            background: #cc7722;
            border-color: #cc7722;
        }

        .action-btn.secondary {
            background: var(--ocha-gray);
            color: white;
            border-color: var(--ocha-gray);
        }

        .action-btn.secondary:hover {
            background: var(--ocha-dark-gray);
            border-color: var(--ocha-dark-gray);
        }

        .action-btn.danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .action-btn.danger:hover {
            background: #c82333;
            border-color: #c82333;
        }

        .action-btn i {
            margin-right: 0.25rem;
            font-size: 0.85rem;
        }

        .action-btn.icon-only {
            padding: 0.5rem;
            min-width: 32px;
        }

        .action-btn.icon-only i {
            margin-right: 0;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center; 
            justify-content: center;
        }
        
        .modal.active { 
            display: flex; 
        }
        
        .modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: var(--border-radius);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--ocha-light-blue);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .modal-title {
            font-family: 'Roboto Slab', serif;
            color: var(--ocha-blue);
            margin: 0;
        }
        
        .modal-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
        }
        
        .modal-close:hover {
            color: var(--ocha-red);
        }
        
        .modal-body {
            padding: 1.5rem;
        }

        .modal-field {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-left: 3px solid var(--ocha-blue);
            background: var(--ocha-light-gray);
            border-radius: 0 6px 6px 0;
        }

        .modal-field strong {
            color: var(--ocha-dark-gray);
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--ocha-light-gray);
        }

        .modal-sector-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .modal-sector-badge {
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid var(--ocha-blue);
            border-radius: 20px;
            padding: 0.4rem 0.8rem;
            font-weight: 600;
            color: var(--ocha-blue);
            font-size: 0.85rem;
        }

        .modal-sector-badge img {
            margin-right: 0.4rem;
        }

        .modal-status-badge {
            background: white;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            border: 2px solid #dee2e6;
        }

        .modal-field-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .modal-field-full {
            grid-column: 1 / -1;
        }

        .modal-field strong {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-field span {
            font-weight: 500;
            color: var(--ocha-dark-gray);
        }

        .text-ocha {
            color: var(--ocha-blue);
        }

        .activity-description {
            margin-top: 0.5rem;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            border-left: 4px solid var(--ocha-blue);
            line-height: 1.6;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .modal-field-group {
                grid-template-columns: 1fr;
            }
            
            .modal-header-info {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Footer */
        .footer {
            background: var(--ocha-dark-gray);
            color: white;
            padding: 2rem 0;
            margin-top: auto;
        }
        
        .footer-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 2rem;
            align-items: start;
        }

        .footer-section h3 {
            color: var(--ocha-orange);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .footer-section p, 
        .footer-section li {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #ccc;
        }

        .footer-section ul {
            list-style: none;
        }

        .footer-section ul li {
            margin-bottom: 0.5rem;
        }

        .footer-section a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-section a:hover {
            color: var(--ocha-orange);
        }

        .footer-bottom {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #555;
            color: #999;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .sidebar {
                position: relative;
                top: 0;
                max-height: none;
            }

            .map-charts-container {
                grid-template-columns: 1fr;
            }

            .charts-section {
                flex-direction: row;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .main-container {
                padding: 1rem;
            }
            
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: none;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .charts-section {
                flex-direction: column;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--ocha-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status indicators */
        .status-en-proyecto { color: var(--ocha-orange); font-weight: 600; }
        .status-en-ejecución { color: var(--ocha-green); font-weight: 600; }
        .status-terminado { color: var(--ocha-blue); font-weight: 600; }

        /* Custom Leaflet marker styles */
        .leaflet-popup-content-wrapper {
            border-radius: var(--border-radius);
        }
        .leaflet-popup-content {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--ocha-gray);
        }
        .leaflet-popup-content h4 {
            font-family: 'Roboto Slab', serif;
            color: var(--ocha-blue);
            font-size: 1.1rem;
        }
        .leaflet-popup-content p {
            margin-bottom: 0.3rem;
        }
        .leaflet-popup-content strong {
            color: var(--ocha-dark-gray);
        }
        .leaflet-popup-close-button {
            background-color: var(--ocha-red);
            color: white;
            font-size: 1rem;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            margin-top: -12px;
            margin-right: -12px;
        }
        .leaflet-popup-close-button:hover {
            background-color: #a30000;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-brand">
                <img src="https://images4.imagebam.com/f2/74/67/MEZQJH3_o.PNG" alt="OCHA Logo" class="header-logo">
                <div class="header-title">
                    <h1>Registro de Proyectos Humanitarios <span id="stateTitle">Zulia y Falcón</span></h1>
                    <div class="header-subtitle">
                        <span id="headerSubtitle">Sub Oficina OCHA Maracaibo - Autoridades Regionales y Municipales</span>
                        <span id="filterIndicator" style="margin-left: 1rem; font-size: 0.9rem; opacity: 0.9;"></span>
                    </div>
                </div>
            </div>
            <div class="header-actions" style="display: flex; gap: 0.5rem;">
                <button id="importJsonBtn" class="btn btn-primary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                    <i class="fas fa-file-import"></i> JSON
                </button>
                <button id="importExcelBtn" class="btn btn-primary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                    <i class="fas fa-file-upload"></i> Excel
                </button>
                <button id="exportTemplateBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                    <i class="fas fa-file-excel"></i> Plantilla
                </button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar with Filters -->
        <aside class="sidebar">
            <!-- State Selector -->
            <div class="filter-section" style="background: var(--ocha-light-blue); border-radius: 8px; padding: 1rem;">
                <h3 class="filter-title">
                    <i class="fas fa-map"></i> Estado
                </h3>
                <div id="stateFilter" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="state" value="Zulia" checked> Zulia
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="state" value="Falcón"> Falcón
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="state" value="Lara"> Lara
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="state" value="Trujillo"> Trujillo
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="state" value="Todos"> Todos los Estados
                    </label>
                </div>
            </div>

            <!-- Traditional Filters -->
            <div class="filter-section">
                <h3 class="filter-title">
                    <i class="fas fa-filter"></i> Filtros Generales
                </h3>
                <select id="orgFilter" class="filter-select">
                    <option value="">Todas las Organizaciones</option>
                </select>
                <label style="display: block; font-weight: 600; color: #5a5a5a; margin-bottom: 0.5rem; font-size: 0.9rem;">Municipios</label>
                <div class="multi-select-container">
                    <div class="multi-select-display" id="municipioDisplay">
                        <span>Todos los Municipios</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="multi-select-dropdown" id="municipioDropdown">
                        <div class="multi-select-option">
                            <input type="checkbox" id="all-municipios" checked>
                            <label for="all-municipios">Todos los Municipios</label>
                        </div>
                    </div>
                </div>
                <!-- Filtro de Parroquias: visible solo cuando hay 1 municipio seleccionado -->
                <div id="parroquiaFilterSection">
                    <label class="parroquia-filter-label">
                        <i class="fas fa-map-marker-alt" style="color: var(--ocha-blue); margin-right: 0.3rem;"></i>
                        Parroquias
                    </label>
                    <div class="multi-select-container">
                        <div class="multi-select-display" id="parroquiaDisplay">
                            <span>Todas las Parroquias</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="multi-select-dropdown" id="parroquiaDropdown">
                            <div class="multi-select-option">
                                <input type="checkbox" id="all-parroquias" checked>
                                <label for="all-parroquias">Todas las Parroquias</label>
                            </div>
                        </div>
                    </div>
                </div>

                <select id="estatusFilter" class="filter-select">
                    <option value="">Todos los Estatus</option>
                </select>
                <button id="resetFilters" class="btn btn-secondary btn-block">
                    <i class="fas fa-refresh"></i> Limpiar Filtros
                </button>
            </div>

            <!-- Humanitarian Sectors -->
            <div class="filter-section">
                <h3 class="filter-title">
                    <i class="fas fa-hand-holding-heart"></i> Sectores Humanitarios
                </h3>
                <div id="sectorGrid" class="sector-grid"></div>
            </div>

            <!-- Date Filter Section -->
            <div class="date-filter-section">
                <h3 class="date-filter-title">
                    <i class="fas fa-calendar-alt"></i> Filtro por Fechas
                </h3>
                <div class="date-inputs">
                    <div class="date-input-group">
                        <label class="date-input-label">Fecha Inicio</label>
                        <input type="date" id="dateStart" class="date-input">
                    </div>
                    <div class="date-input-group">
                        <label class="date-input-label">Fecha Fin</label>
                        <input type="date" id="dateEnd" class="date-input">
                    </div>
                    <div class="date-slider-container">
                        <input type="range" id="dateRangeSlider" class="date-slider" min="0" max="365" value="30">
                        <div class="slider-labels">
                            <span id="sliderMinDate">Última semana</span>
                            <span id="sliderMaxDate">Último año</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- KPI Cards -->
            <section class="kpi-section">
                <div id="kpiContainer" class="kpi-grid"></div>
            </section>

            <!-- Map and Charts Section -->
            <section class="map-charts-container">
                <div class="map-section">
                    <div id="map"></div>
                    <div class="map-legend">
                        <div class="legend-title">Leyenda del Mapa</div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: var(--ocha-blue);"></div>
                            <span>En ejecución</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: var(--ocha-orange);"></div>
                            <span>En proyecto</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: var(--ocha-green);"></div>
                            <span>Terminado</span>
                        </div>
                    </div>
                </div>
                <div class="charts-section">
                    <div class="chart-container">
                        <h4 class="chart-title">Proyectos por Sector</h4>
                        <canvas id="sectorChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4 class="chart-title">Estatus de Proyectos</h4>
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>
            </section>
            
            <!-- Map Disclaimer moved closer to map -->
            <div style="font-size: 0.6rem; color: #777; text-align: left; margin-top: 0.25rem; padding: 0.2rem 0.4rem; background: rgba(255,255,255,0.9); border-radius: 3px; line-height: 1.2; max-width: 700px;">
                <strong>Disclaimer:</strong> Las denominaciones empleadas en este mapa y la forma en que aparecen presentados los datos que contienen no implican de parte de la Secretaría de Naciones Unidas juicio alguno sobre la condición jurídica de países, territorios, ciudades, zonas, o de sus autoridades, ni respecto a la delimitación de sus fronteras o límites.
            </div>

            <!-- Data Table -->
            <section class="table-container">
                <div class="table-header">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar proyectos, organizaciones, municipios...">
                    </div>
                    <div class="table-actions">
                        <button id="addProjectBtn" class="btn btn-success">
                            <i class="fas fa-plus"></i> Agregar Proyecto
                        </button>
                        <button id="exportFilteredExcel" class="btn btn-success">
                            <i class="fas fa-file-excel"></i> Exportar Filtrados
                        </button>
                        <div class="pdf-dropdown-wrap" style="position:relative; display:inline-block;">
                            <button id="exportPdfToggle" class="btn btn-primary" style="padding-right:10px;">
                                <i class="fas fa-file-pdf"></i> PDF <i class="fas fa-caret-down" style="margin-left:5px; font-size:0.8em;"></i>
                            </button>
                            <div id="pdfDropdownMenu" style="display:none; position:absolute; top:calc(100% + 4px); right:0; background:#fff; border:1px solid #d0d7de; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:1100; min-width:190px; overflow:hidden;">
                                <button id="exportPdfShort" style="display:flex; align-items:center; gap:9px; width:100%; padding:9px 14px; border:none; background:none; cursor:pointer; font-size:0.88rem; color:#24292f; white-space:nowrap;" onmouseover="this.style.background='#f6f8fa'" onmouseout="this.style.background='none'">
                                    <i class="fas fa-building" style="color:#005D92; width:14px;"></i>
                                    <span><strong>Por Municipio</strong><br><small style="color:#888; font-size:0.78rem;">Parroquias agrupadas</small></span>
                                </button>
                                <div style="height:1px; background:#eaecef; margin:0 10px;"></div>
                                <button id="exportPdfFull" style="display:flex; align-items:center; gap:9px; width:100%; padding:9px 14px; border:none; background:none; cursor:pointer; font-size:0.88rem; color:#24292f; white-space:nowrap;" onmouseover="this.style.background='#f6f8fa'" onmouseout="this.style.background='none'">
                                    <i class="fas fa-map-marker-alt" style="color:#005D92; width:14px;"></i>
                                    <span><strong>Por Parroquia</strong><br><small style="color:#888; font-size:0.78rem;">Un registro por parroquia</small></span>
                                </button>
                            </div>
                        </div>
                        <button id="deleteSelectedBtn" class="btn btn-danger" style="display: none; background: #dc3545; border-color: #dc3545; color: white;">
                            <i class="fas fa-trash-alt"></i> Eliminar Seleccionados (<span id="selectedCount">0</span>)
                        </button>
                        <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="projects-table">
                        <thead>
                            <tr id="tableHeaders"></tr>
                        </thead>
                        <tbody id="projectsTableBody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal for Project Details -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="modal-title">Detalles del Proyecto</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div id="modalBody" class="modal-body"></div>
        </div>
    </div>

    <!-- Modal for Add/Edit Project -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="editModalTitle" class="modal-title">Agregar Proyecto</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm" style="display: grid; gap: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Código del proyecto *</label>
                            <input type="text" id="formCodigo" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Estatus *</label>
                            <select id="formEstatus" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">Seleccionar...</option>
                                <option value="En proyecto">En proyecto</option>
                                <option value="En ejecución">En ejecución</option>
                                <option value="Terminado">Terminado</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Nombre del proyecto *</label>
                        <input type="text" id="formNombre" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Organización Líder *</label>
                            <input type="text" id="formOrgLider" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Organización Implementadora</label>
                            <input type="text" id="formOrgImpl" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                            Áreas de Intervención * <small style="color:#888; font-weight:400;">(seleccionar todas las que apliquen)</small>
                        </label>
                        <div id="formSectoresContainer" class="form-parroquia-multi" style="max-height: 200px;">
                            <!-- populated by initFormSectores() -->
                        </div>
                        <!-- Hidden inputs for backward compatibility -->
                        <input type="hidden" id="formArea" value="">
                        <input type="hidden" id="formSector" value="">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Estado *</label>
                            <select id="formEstado" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">Seleccionar Estado...</option>
                                <option value="Zulia">Zulia</option>
                                <option value="Falcón">Falcón</option>
                                <option value="Lara">Lara</option>
                                <option value="Trujillo">Trujillo</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Municipio *</label>
                            <select id="formMunicipio" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">Seleccionar Municipio...</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                                Parroquia *
                                <span style="font-weight:400; font-size:0.78rem; color:#c0392b; margin-left:6px;">
                                    Un registro por parroquia
                                </span>
                            </label>
                            <div id="formParroquiasContainer">
                                <input type="text" id="formParroquias" class="form-parroquia-fallback"
                                       placeholder="Seleccione un municipio primero">
                            </div>
                            <small id="formParroquiasHint" style="color: #888; font-size: 0.78rem; margin-top: 0.25rem; display: block;"></small>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Fecha de Inicio</label>
                            <input type="date" id="formFechaInicio" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Fecha de Finalización</label>
                            <input type="date" id="formFechaFin" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Descripción de la Actividad</label>
                        <textarea id="formActividad" rows="4" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar Proyecto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal for Import Options -->
    <div id="importModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Importar Datos desde Excel</h2>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: var(--ocha-gray);">
                    Selecciona cómo deseas importar los datos del archivo Excel:
                </p>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button onclick="handleImport('replace')" class="btn btn-primary btn-block">
                        <i class="fas fa-sync-alt"></i> Reemplazar todos los datos
                    </button>
                    <button onclick="handleImport('merge')" class="btn btn-success btn-block">
                        <i class="fas fa-plus-circle"></i> Hacer merge (agregar nuevos)
                    </button>
                    <button onclick="closeImportModal()" class="btn btn-secondary btn-block">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
                <p style="margin-top: 1.5rem; font-size: 0.85rem; color: #777;">
                    <strong>Nota:</strong> El archivo Excel debe tener la misma estructura que el archivo de datos original.
                </p>
            </div>
        </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h2>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: var(--ocha-gray); font-size: 1rem;">
                    ¿Está seguro de que desea eliminar este proyecto? Esta acción <strong>no se puede deshacer</strong>.
                </p>
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
                    <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> El proyecto será eliminado de la base de datos de Supabase.
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button onclick="closeDeleteModal()" class="btn btn-secondary btn-block">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button onclick="confirmDeleteProject()" class="btn btn-danger btn-block" style="background: #dc3545; border-color: #dc3545; color: white;">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Contact Information -->
    <div id="contactModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-address-book"></i> Contactar a OCHA</h2>
                <button class="modal-close" onclick="closeContactModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: var(--ocha-light-blue); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--ocha-blue); margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-map-marker-alt"></i> Sub Oficina OCHA Maracaibo
                    </h3>
                </div>

                <div style="background: white; border: 2px solid var(--ocha-blue); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                    <h4 style="color: var(--ocha-dark-gray); margin-bottom: 0.75rem; font-size: 1rem;">
                        <i class="fas fa-user-circle"></i> Jefa de Sub Oficina OCHA
                    </h4>
                    <p style="margin-bottom: 0.5rem; font-weight: 600; color: var(--ocha-blue); font-size: 1.1rem;">Laura Solórzano</p>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                        <a href="https://wa.me/584126173878" target="_blank" class="btn btn-success" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fab fa-whatsapp" style="font-size: 1.2rem;"></i> WhatsApp: +58 412 6173878
                        </a>
                        <a href="mailto:solorzano2@un.org" class="btn btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-envelope"></i> solorzano2@un.org
                        </a>
                    </div>
                </div>

                <div style="background: white; border: 2px solid var(--ocha-gray); border-radius: 8px; padding: 1.5rem;">
                    <h4 style="color: var(--ocha-dark-gray); margin-bottom: 0.75rem; font-size: 1rem;">
                        <i class="fas fa-code"></i> Desarrollado por
                    </h4>
                    <p style="margin-bottom: 0.5rem; font-weight: 600; color: var(--ocha-gray); font-size: 1.1rem;">Jhozman Camacho</p>
                    <p style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--ocha-gray);">IMA Sub Oficina OCHA</p>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                        <a href="mailto:jhozman.camacho@un.org" class="btn btn-secondary" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-envelope"></i> jhozman.camacho@un.org
                        </a>
                    </div>
                </div>

                <div style="margin-top: 1.5rem; text-align: center;">
                    <button onclick="closeContactModal()" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Acerca de Este Dashboard</h3>
                <p>Dashboard Humanitario desarrollado para las autoridades regionales y municipales en colaboración con la <strong>Sub Oficina OCHA Maracaibo</strong>. Facilita el seguimiento y coordinación de proyectos humanitarios en los estados Zulia, Falcón, Lara y Trujillo.</p>
            </div>
            <div class="footer-section">
                <h3>Enlaces Útiles</h3>
                <ul>
                    <li><a href="#" onclick="showAbout()">Acerca del Sistema</a></li>
                    <li><a href="#" onclick="showHelp()">Ayuda y Soporte</a></li>
                    <li><a href="#" onclick="showContact()">Contactar OCHA</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Información Técnica</h3>
                <ul>
                    <li>Última actualización: <span id="lastUpdate"></span></li>
                    <li>Total de registros: <span id="totalRecords"></span></li>
                    <li>Versión del sistema: 2.1.1</li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Agosto 2025 Sub Oficina OCHA Maracaibo. Desarrollado para fines humanitarios.</p>
        </div>
    </footer>

    <script>
        // Global Variables and Configuration
        let map = null;
        let markers = [];
        let projectsData = []; // Original data from JSON
        let expandedData = []; // Expanded data for filtering (each semicolon-separated value becomes a row)
        let filteredData = []; // Currently filtered data
        let sectorChart = null;
        let timeChart = null;
        let currentFilters = {
            org: '',
            municipio: [],
            estatus: '',
            search: '',
            sector: '',
            dateStart: '',
            dateEnd: '',
            parroquia: []
        };
        
        // Function to build expanded data for filtering
        // In the current model each record already has ONE municipality and ONE parish.
        // We create exactly one expanded row per record, preserving the original municipality
        // value as-is (no splitting, no normalization that could drop records).
        function expandProjectData(projects) {
            const expanded = [];

            projects.forEach((project, originalIndex) => {
                const municipio = (project['Municipio'] || '').trim();
                const areas = project['Área de intervención complementaria']
                    ? project['Área de intervención complementaria'].split(';').map(s => s.trim()).filter(s => s)
                    : [''];

                expanded.push({
                    ...project,
                    'Municipio': municipio,
                    '_originalIndex': originalIndex,
                    '_expandedMunicipality': municipio,
                    '_expandedAreas': areas,
                    '_isExpanded': true
                });
            });

            return expanded;
        }

        // Humanitarian Sectors Configuration with OCHA official icons
        const humanitarianSectors = [
            { id: 'agua-saneamiento', name: 'Agua, saneamiento e higiene', shortName: 'ASH', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzlkXC80MzY2OTIwXC83MWE1OTcyMzkyYTJkM2VlNDgxNmQ1ODU0MGNmNTliYS0xNTkxNzIxMTgyLnN2ZyJ9:frontify:MgH6UY5xqyfKx77ec3VRFtR1lOv93RJDs8MqbwFkJpM?width=64', keywords: ['agua', 'saneamiento', 'higiene', 'wash', 'potable'] },
            { id: 'alojamiento', name: 'Alojamiento, energia y enseres', shortName: 'AEE', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2NmXC80MzY2ODEyXC8xZTI5NzQzMzcyOTE0YjE2MDkxNTI0N2NkZGMwY2E3NC0xNTkxNzE4OTIxLnN2ZyJ9:frontify:FUBxqK8yAh-cPqjcmhGA4pR442WpMZP8wrc1C9PJZn8?width=64', keywords: ['alojamiento', 'vivienda', 'shelter', 'refugio', 'energia', 'enseres'] },
            { id: 'educacion', name: 'Educación', shortName: 'EDU', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzJjXC80MzY0NjkwXC8xYTIwZTMxZTMzOTEwY2U3YTA4Yjg5ODVhOGU5Mjg0My0xNTkxNjkzNjA1LnN2ZyJ9:frontify:90NzWxvX_2V0BDPOGueYpIZfuSZvJfOer4Pkvq4dHBA?width=64', keywords: ['educación', 'educacion', 'escuela', 'capacitación'] },
            { id: 'logistica', name: 'Logística', shortName: 'LOG', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2I1XC80MzY1NjU4XC9lYWMwZTAwYTliOTAzNzE5MTg5ODVlOGQzODYxZjRkZi0xNTkxNzA1NzA4LnN2ZyJ9:frontify:7PGcDsrr0gOGydKDD5v7Aia13DteuetjkK0j4oKUqZI?width=64', keywords: ['logística', 'logistica', 'suministros', 'transporte'] },
            { id: 'nutricion', name: 'Nutrición', shortName: 'NUT', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzQzXC80MzY1NzM1XC82ODU2MWExNDAzMzc0NzBjNDE5MGFmYWY5NTFkNzU4Yi0xNTkxNzA2NjI1LnN2ZyJ9:frontify:3rsyLJgQXbU3Y015aKrjd1ohrB4PI_KPd723_KhjCWA?width=64', keywords: ['nutrición', 'nutricion', 'alimentación', 'malnutrición'] },
            { id: 'proteccion', name: 'Protección (Incluidas las AdR de VbG y NNA)', shortName: 'PRO', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2EyXC80MzY1OTYwXC8zYjFiMDY2MTAzYjIyMWY0MTI4YTVkNzkxYmRjOTE3YS0xNTkxNzA4MzI2LnN2ZyJ9:frontify:7lTtjGE2P2Nbz_525sMoZikLkHSh9tegag19Prx_SZc?width=64', keywords: ['protección', 'proteccion', 'derechos', 'legal', 'vbg', 'violencia', 'género', 'niños'] },
            { id: 'salud', name: 'Salud', shortName: 'SAL', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzQwXC80MzY1MDA0XC9jNDk5OWE4ZDk2ZDE1YjZhNzIxMTQ5ZWU4YTFiMTkwMy0xNTkxNzAxMjUzLnN2ZyJ9:frontify:R0CU010gVeFON_MaMY38IILJz2LXMajqem4P1TiGwQk?width=64', keywords: ['salud', 'médico', 'hospital', 'clínica'] },
            { id: 'seguridad-alimentaria', name: 'Seguridad Alimentaria', shortName: 'SAMV', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2I0XC80MzY0Nzc1XC8xYjhhNmIxNzZlZTQ4MThjZjJjOGE5NDQyN2FjMjNjYi0xNTkxNjk0MjY5LnN2ZyJ9:frontify:tXhekXovZmafEC1xe1vMSYzRz4aiC23x9HTHlGsrz4U?width=64', keywords: ['alimentaria', 'alimentos', 'seguridad alimentaria'] },
            { id: 'coordinacion', name: 'Coordinación', shortName: 'COO', ochaIcon: 'https://images4.imagebam.com/e8/c9/d9/ME15B6OI_o.jpg', keywords: ['coordinación', 'coordinacion', 'gestión', 'administración'] }
        ];

        // Municipal coordinates for Zulia State (corrected coordinates)
const zuliaCoordinates = {
  // Official 21 municipalities with correct names (with tildes)
  'Almirante Padilla': [11.081389, -71.678611],
  'Baralt': [9.073056, -71.088056],
  'Cabimas': [10.397050, -71.382909],
  'Catatumbo': [8.932051, -72.212489],
  'Colón': [8.910424, -71.889130],
  'Francisco Javier Pulgar': [8.876724, -71.579093],
  'Indígena Bolivariano Guajira': [11.293893, -71.954533],
  'Jesús Enrique Lossada': [10.627971, -71.941754],
  'Jesús María Semprún': [9.065695, -72.575965],
  'La Cañada de Urdaneta': [10.386725, -71.914161],
  'Lagunillas': [10.204995, -71.205749],
  'Machiques de Perijá': [9.786057, -72.506373],
  'Mara': [10.881860, -71.957233],
  'Maracaibo': [10.665127, -71.656126],
  'Miranda': [10.720599, -71.378252],
  'Páez': [9.342778, -71.263611],
  'Rosario de Perijá': [10.188122, -72.296170],
  'San Francisco': [10.547222, -71.672908],
  'Santa Rita': [10.528048, -71.420883],
  'Simón Bolívar': [10.293099, -71.315466],
  'Sucre': [9.151367, -71.148344],
  'Valmore Rodríguez': [10.073581, -71.039030],
  // Alternative names and variations for compatibility
  'Guajira': [11.293893, -71.954533],
  'Ciudad Ojeda': [10.204995, -71.205749],
  'Colon': [8.910424, -71.889130],
  'Jesus Enrique Lossada': [10.627971, -71.941754],
  'Jesus María Semprun': [9.065695, -72.575965],
  'Jesus María Semprún': [9.065695, -72.575965],
  'La Canada de Urdaneta': [10.386725, -71.914161],
  'Machiques': [9.786057, -72.506373],
  'Machiques de Perija': [9.786057, -72.506373],
  'Rosario de Perija': [10.188122, -72.296170],
  'Valmore Rodriguez': [10.073581, -71.039030],
  'Simon Bolivar': [10.293099, -71.315466]
};

// Falcón State Coordinates (25 municipalities - Official coordinates)
const falconCoordinates = {
  'Acosta': [11.1738, -68.4099],                    // San Juan de los Cayos
  'Bolívar': [11.1057, -69.7145],                   // San Luis
  'Buchivacoa': [11.1718, -70.6204],                // Capatárida
  'Cacique Manaure': [10.9739, -68.5468],           // Yaracal
  'Carirubana': [11.7086, -70.0056],                // Punto Fijo
  'Colina': [11.4589, -69.5648],                    // La Vela de Coro
  'Dabajuro': [11.0239, -70.6776],                  // Dabajuro
  'Democracia': [11.0240, -70.1206],                // Pedregal
  'Falcón': [11.9479, -69.9231],                    // Pueblo Nuevo
  'Federación': [10.8129, -69.5410],                // Churuguara
  'Iturriza': [10.9333, -68.2772],                  // Chichiriviche
  'Jacura': [11.0739, -68.8564],                    // Jacura
  'Los Taques': [11.8226, -70.2557],                // Santa Cruz de Los Taques
  'Mauroa': [10.6802, -71.0345],                    // Mene de Mauroa
  'Miranda': [11.4045, -69.6734],                   // Santa Ana de Coro
  'Palmasola': [10.5918, -68.5410],                 // Palmasola
  'Petit': [11.1296, -69.6089],                     // Cabure
  'Píritu': [11.3378, -69.0493],                    // Píritu
  'San Francisco': [11.1618, -68.7240],             // Mirimire
  'Silva': [10.7906, -68.3258],                     // Tucacas
  'Sucre': [11.0607, -69.7138],                     // La Cruz de Taratara
  'Tocópero': [11.5013, -69.2584],                  // Tocópero
  'Unión': [10.8342, -69.2699],                     // Santa Cruz de Bucaral
  'Urumaco': [11.2000, -70.2500],                   // Urumaco
  'Zamora': [11.4864, -69.3503]                     // Puerto Cumarebo
};

// Lara State Coordinates (9 municipalities - Official coordinates)
const laraCoordinates = {
  'Andrés Eloy Blanco': [9.7439, -69.6512],                // Sanare
  'Crespo': [9.8531, -69.5914],                             // Duaca
  'Iribarren': [10.0677, -69.3474],                         // Barquisimeto
  'Jiménez': [9.9287, -69.6201],                            // Quíbor
  'Morán': [9.7871, -69.7929],                              // El Tocuyo
  'Palavecino': [10.0266, -69.2620],                        // Cabudare
  'Simón Planas': [9.7836, -69.1626],                       // Sarare
  'Torres': [10.1695, -70.0728],                            // Carora
  'Urdaneta': [10.5703, -69.7083],                          // Siquisique
  // Alternative names and variations for compatibility
  'Sanare': [9.7439, -69.6512],
  'Duaca': [9.8531, -69.5914],
  'Barquisimeto': [10.0677, -69.3474],
  'Quíbor': [9.9287, -69.6201],
  'El Tocuyo': [9.7871, -69.7929],
  'Cabudare': [10.0266, -69.2620],
  'Sarare': [9.7836, -69.1626],
  'Carora': [10.1695, -70.0728],
  'Siquisique': [10.5703, -69.7083],
  'Simon Planas': [9.7836, -69.1626],
  'Andres Eloy Blanco': [9.7439, -69.6512]
};

// Trujillo State Coordinates (20 municipalities - Official coordinates)
const trujilloCoordinates = {
  'Andrés Bello': [9.6345, -70.8100],                       // Santa Isabel
  'Boconó': [9.2534, -70.2498],                             // Boconó
  'Bolívar': [9.7038, -70.5243],                            // Sabana Grande
  'Candelaria': [9.6219, -70.3522],                         // Chejendé
  'Carache': [9.7072, -70.1932],                            // Carache
  'Carvajal': [9.4006, -70.5622],                           // Carvajal (San Rafael de Carvajal)
  'Campo Elías': [9.5050, -70.4183],                        // Campo Elías
  'Escuque': [9.3053, -70.6729],                            // Escuque
  'La Ceiba': [9.4780, -71.0142],                           // Santa Apolonia
  'Márquez Cañizales': [9.7750, -70.6063],                  // El Paradero (José Felipe Márquez Cañizales)
  'Miranda': [9.4817, -70.7298],                            // El Dividive
  'Monte Carmelo': [9.1876, -70.8130],                      // Monte Carmelo
  'Motatán': [9.3931, -70.5934],                            // Motatán
  'Pampán': [9.4512, -70.4759],                             // Pampán
  'Pampanito': [9.4115, -70.4982],                          // Pampanito
  'Rangel': [9.3798, -70.7332],                             // Betijoque (Rafael Rangel)
  'Sucre': [9.4388, -70.7704],                              // Sabana de Mendoza
  'Trujillo': [9.3658, -70.4369],                           // Trujillo
  'Urdaneta': [9.1533, -70.5783],                           // La Quebrada
  'Valera': [9.3178, -70.6036],                             // Valera
  // Alternative names and variations for compatibility
  'Santa Isabel': [9.6345, -70.8100],
  'Sabana Grande': [9.7038, -70.5243],
  'Chejendé': [9.6219, -70.3522],
  'Santa Apolonia': [9.4780, -71.0142],
  'El Paradero': [9.7750, -70.6063],
  'El Dividive': [9.4817, -70.7298],
  'Betijoque': [9.3798, -70.7332],
  'Sabana de Mendoza': [9.4388, -70.7704],
  'La Quebrada': [9.1533, -70.5783],
  'San Rafael de Carvajal': [9.4006, -70.5622],
  'Rafael Rangel': [9.3798, -70.7332],
  'Jose Felipe Marquez Canizales': [9.7750, -70.6063],
  'Marquez Canizales': [9.7750, -70.6063],
  'Juan Vicente Campo Elias': [9.5050, -70.4183],
  'Andres Bello': [9.6345, -70.8100]
};

        // ============================================
        // PARROQUIAS DATA - Coordenadas y listados por municipio
        // Extraído de Admin Maestro.xlsx (VE23=Zulia, VE11=Falcón, VE13=Lara, VE21=Trujillo)
        // ============================================
        const PARROQUIAS_DATA = {
            'Zulia': {
                'Almirante Padilla': [
                    {name: 'Isla De Toas', code: 'VE230101', lat: 10.95677688, lon: -71.65515541},
                    {name: 'Monagas', code: 'VE230102', lat: 11.02235263, lon: -71.69791358}
                ],
                'Baralt': [
                    {name: 'San Timoteo', code: 'VE230201', lat: 9.82610992, lon: -71.0444318},
                    {name: 'General Urdaneta', code: 'VE230202', lat: 9.67283433, lon: -70.97426941},
                    {name: 'Libertador', code: 'VE230203', lat: 9.77819587, lon: -70.83251857},
                    {name: 'Manuel Guanipa Matos', code: 'VE230204', lat: 10.11326396, lon: -70.85481154},
                    {name: 'Marcelino Briceño', code: 'VE230205', lat: 9.65865385, lon: -70.85542054},
                    {name: 'Pueblo Nuevo', code: 'VE230206', lat: 9.87575103, lon: -70.86854573}
                ],
                'Cabimas': [
                    {name: 'Ambrosio', code: 'VE230301', lat: 10.40730708, lon: -71.46426992},
                    {name: 'Carmen Herrera', code: 'VE230302', lat: 10.39205535, lon: -71.45596568},
                    {name: 'Germán Ríos Linares', code: 'VE230303', lat: 10.42877197, lon: -71.43429215},
                    {name: 'La Rosa', code: 'VE230304', lat: 10.37722076, lon: -71.44335776},
                    {name: 'Jorge Hernández', code: 'VE230305', lat: 10.37730405, lon: -71.39205003},
                    {name: 'Rómulo Betancourt', code: 'VE230306', lat: 10.40155188, lon: -71.40298947},
                    {name: 'San Benito', code: 'VE230307', lat: 10.42788393, lon: -71.35898203},
                    {name: 'Arístides Calvani', code: 'VE230308', lat: 10.4153429, lon: -71.14081185},
                    {name: 'Punta Gorda', code: 'VE230309', lat: 10.34338091, lon: -71.35601896}
                ],
                'Catatumbo': [
                    {name: 'Encontrados', code: 'VE230401', lat: 9.25135288, lon: -72.11840551},
                    {name: 'Udon Perez', code: 'VE230402', lat: 8.61289937, lon: -72.30642868}
                ],
                'Colón': [
                    {name: 'San Carlos Del Zulia', code: 'VE230501', lat: 9.07247223, lon: -71.97588937},
                    {name: 'Moralito', code: 'VE230502', lat: 8.77375991, lon: -71.8494445},
                    {name: 'Santa Barbará', code: 'VE230503', lat: 9.03615547, lon: -71.84266996},
                    {name: 'Santa Cruz Del Zulia', code: 'VE230504', lat: 8.71410071, lon: -72.06642588},
                    {name: 'Urribarri', code: 'VE230505', lat: 8.95760467, lon: -71.72354234}
                ],
                'Francisco Javier Pulgar': [
                    {name: 'Simón Rodríguez', code: 'VE230601', lat: 8.97942975, lon: -71.54102839},
                    {name: 'Carlos Quevedo', code: 'VE230602', lat: 8.87455088, lon: -71.55982485},
                    {name: 'Francisco Javier Pulgar', code: 'VE230603', lat: 8.7761912, lon: -71.63642466}
                ],
                'Indígena Bolivariano Guajira': [
                    {name: 'Sinamaica', code: 'VE231501', lat: 11.10207225, lon: -71.856977},
                    {name: 'Alta Guajira', code: 'VE231502', lat: 11.65954796, lon: -71.73231225},
                    {name: 'Elías Sánchez Rubio', code: 'VE231503', lat: 11.1085186, lon: -72.1801979},
                    {name: 'Guajira', code: 'VE231504', lat: 11.27691222, lon: -72.05228619}
                ],
                'Jesús Enrique Lossada': [
                    {name: 'La Concepción', code: 'VE230701', lat: 10.62076533, lon: -71.88437041},
                    {name: 'José Ramón Yepez', code: 'VE230702', lat: 10.62567377, lon: -72.4048419},
                    {name: 'Mariano Parra León', code: 'VE230703', lat: 10.54561804, lon: -71.90063794},
                    {name: 'San José', code: 'VE230704', lat: 10.70755965, lon: -71.84573068}
                ],
                'Jesús María Semprún': [
                    {name: 'Jesús María Semprum', code: 'VE230801', lat: 8.86605613, lon: -72.54016179},
                    {name: 'Bari', code: 'VE230802', lat: 9.27535351, lon: -72.82093249}
                ],
                'La Cañada de Urdaneta': [
                    {name: 'Concepción', code: 'VE230901', lat: 10.41905757, lon: -71.81480657},
                    {name: 'Andrés Bello', code: 'VE230902', lat: 10.43855889, lon: -72.11024542},
                    {name: 'Chiquinquira', code: 'VE230903', lat: 10.47452338, lon: -71.78205476},
                    {name: 'El Carmelo', code: 'VE230904', lat: 10.36272185, lon: -71.91153555},
                    {name: 'Potreritos', code: 'VE230905', lat: 10.23876184, lon: -71.95216404}
                ],
                'Lagunillas': [
                    {name: 'Alonso De Ojeda', code: 'VE231001', lat: 10.19826876, lon: -71.29637316},
                    {name: 'Libertad', code: 'VE231002', lat: 10.23400969, lon: -71.30343356},
                    {name: 'Campo Lara', code: 'VE231003', lat: 10.16551269, lon: -71.11022584},
                    {name: 'Eleazar López Contreras', code: 'VE231004', lat: 10.31494235, lon: -71.07529209},
                    {name: 'Venezuela', code: 'VE231005', lat: 10.1083748, lon: -71.21396965},
                    {name: 'El Danto', code: 'VE231006', lat: 10.20885978, lon: -71.23520202}
                ],
                'Machiques de Perijá': [
                    {name: 'Libertad', code: 'VE231101', lat: 9.91526924, lon: -72.78148833},
                    {name: 'Bartolomé De Las Casas', code: 'VE231102', lat: 9.79297587, lon: -72.29469166},
                    {name: 'Rio Negro', code: 'VE231103', lat: 9.529503, lon: -72.58514808},
                    {name: 'San José De Perija', code: 'VE231104', lat: 9.92167614, lon: -72.29234104}
                ],
                'Mara': [
                    {name: 'San Rafael', code: 'VE231201', lat: 10.91548573, lon: -71.76621068},
                    {name: 'La Sierrita', code: 'VE231202', lat: 10.81977671, lon: -71.94374544},
                    {name: 'Las Parcelas', code: 'VE231203', lat: 10.94475232, lon: -71.90120858},
                    {name: 'Luis De Vicente', code: 'VE231204', lat: 10.99519412, lon: -72.23509391},
                    {name: 'Monseñor Marcos Sergio Godoy', code: 'VE231205', lat: 10.84214387, lon: -72.37365091},
                    {name: 'Ricaurte', code: 'VE231206', lat: 10.80074047, lon: -71.7389154},
                    {name: 'Tamare', code: 'VE231207', lat: 10.85493449, lon: -71.7452422}
                ],
                'Maracaibo': [
                    {name: 'Antonio Borjas Romero', code: 'VE231301', lat: 10.68921099, lon: -71.7217935},
                    {name: 'Bolívar', code: 'VE231302', lat: 10.64993628, lon: -71.61014671},
                    {name: 'Cacique Mara', code: 'VE231303', lat: 10.65155726, lon: -71.64391442},
                    {name: 'Caracciolo Parra Perez', code: 'VE231304', lat: 10.68653395, lon: -71.66086001},
                    {name: 'Cecilio Acosta', code: 'VE231305', lat: 10.63493621, lon: -71.65006865},
                    {name: 'Cristo De Aranza', code: 'VE231306', lat: 10.61724349, lon: -71.62294489},
                    {name: 'Coquivacoa', code: 'VE231307', lat: 10.70701172, lon: -71.60963791},
                    {name: 'Chiquinquira', code: 'VE231308', lat: 10.6663643, lon: -71.63146903},
                    {name: 'Francisco Eugenio Bustamante', code: 'VE231309', lat: 10.63164734, lon: -71.69654468},
                    {name: 'Idelfonso Vásquez', code: 'VE231310', lat: 10.73330932, lon: -71.66245439},
                    {name: 'Juana De Ávila', code: 'VE231311', lat: 10.70405498, lon: -71.62969405},
                    {name: 'Luis Hurtado Higuera', code: 'VE231312', lat: 10.5972916, lon: -71.6715812},
                    {name: 'Manuel Dagnino', code: 'VE231313', lat: 10.61103918, lon: -71.64518953},
                    {name: 'Olegario Villalobos', code: 'VE231314', lat: 10.67794309, lon: -71.60736521},
                    {name: 'Raúl Leoni', code: 'VE231315', lat: 10.67106579, lon: -71.66885018},
                    {name: 'Santa Lucia', code: 'VE231316', lat: 10.65750772, lon: -71.6005269},
                    {name: 'Venancio Pulgar', code: 'VE231317', lat: 10.73314532, lon: -71.72780101},
                    {name: 'San Isidro', code: 'VE231318', lat: 10.65045544, lon: -71.75451948}
                ],
                'Miranda': [
                    {name: 'Altagracia', code: 'VE231401', lat: 10.72593479, lon: -71.48584982},
                    {name: 'Ana María Campos', code: 'VE231402', lat: 10.70564966, lon: -71.32920131},
                    {name: 'Faria', code: 'VE231403', lat: 10.85193329, lon: -71.29581697},
                    {name: 'San Antonio', code: 'VE231404', lat: 10.56638599, lon: -71.14302954},
                    {name: 'San José', code: 'VE231405', lat: 10.77814544, lon: -71.50809928},
                    {name: 'José Antonio Chaves', code: 'VE231406', lat: 10.65774112, lon: -71.50448207}
                ],
                'Páez': [
                    {name: 'Urribarri', code: 'VE232201', lat: 10.33, lon: -71.57},
                    {name: 'Monseñor Pulido Méndez', code: 'VE232202', lat: 10.29, lon: -71.50}
                ],
                'Rosario de Perijá': [
                    {name: 'El Rosario', code: 'VE231601', lat: 10.35743497, lon: -72.41655873},
                    {name: 'Donaldo García', code: 'VE231602', lat: 10.00513588, lon: -72.12848811},
                    {name: 'Sixto Zambrano', code: 'VE231603', lat: 10.14589646, lon: -72.31592139}
                ],
                'San Francisco': [
                    {name: 'San Francisco', code: 'VE231701', lat: 10.5567605, lon: -71.63324955},
                    {name: 'El Bajo', code: 'VE231702', lat: 10.52186181, lon: -71.64125825},
                    {name: 'Domitila Flores', code: 'VE231703', lat: 10.54552653, lon: -71.66217684},
                    {name: 'Francisco Ochoa', code: 'VE231704', lat: 10.58567588, lon: -71.62989209},
                    {name: 'Los Cortijos', code: 'VE231705', lat: 10.52508318, lon: -71.73738724},
                    {name: 'Marcial Hernández', code: 'VE231706', lat: 10.56962721, lon: -71.72834731},
                    {name: 'José Domingo Rus', code: 'VE231707', lat: 10.52677327, lon: -71.68292507}
                ],
                'Santa Rita': [
                    {name: 'Santa Rita', code: 'VE231801', lat: 10.53671595, lon: -71.461998},
                    {name: 'El Mene', code: 'VE231802', lat: 10.47243982, lon: -71.43165444},
                    {name: 'José Cenovio Urribarri', code: 'VE231803', lat: 10.58711117, lon: -71.47635157},
                    {name: 'Pedro Lucas Urribarri', code: 'VE231804', lat: 10.51592606, lon: -71.31352876}
                ],
                'Simón Bolívar': [
                    {name: 'Manuel Manrique', code: 'VE231901', lat: 10.25938252, lon: -71.33698613},
                    {name: 'Rafael María Baralt', code: 'VE231902', lat: 10.29980634, lon: -71.36549712},
                    {name: 'Rafael Urdaneta', code: 'VE231903', lat: 10.32010704, lon: -71.24391472}
                ],
                'Sucre': [
                    {name: 'Bobures', code: 'VE232001', lat: 9.21127513, lon: -71.16619758},
                    {name: 'El Batey', code: 'VE232002', lat: 9.17517246, lon: -71.12356352},
                    {name: 'Gibraltar', code: 'VE232003', lat: 9.26689968, lon: -71.05465628},
                    {name: 'Heras', code: 'VE232004', lat: 9.0559997, lon: -71.20943579},
                    {name: 'Monseñor Arturo Celestino Álvarez', code: 'VE232005', lat: 9.00712309, lon: -71.34801627},
                    {name: 'Rómulo Gallegos', code: 'VE232006', lat: 9.19173083, lon: -70.98819216}
                ],
                'Valmore Rodríguez': [
                    {name: 'La Victoria', code: 'VE232101', lat: 9.94805921, lon: -71.06304024},
                    {name: 'Rafael Urdaneta', code: 'VE232102', lat: 10.02133325, lon: -71.12825529},
                    {name: 'Raúl Cuenca', code: 'VE232103', lat: 10.25135019, lon: -70.92579509}
                ]
            },
            'Falcón': {
                'Acosta': [
                    {name: 'San Juan De Los Cayos', code: 'VE110101', lat: 11.11958179, lon: -68.43776904},
                    {name: 'Capadare', code: 'VE110102', lat: 11.12839694, lon: -68.5668909},
                    {name: 'La Pastora', code: 'VE110103', lat: 11.25373248, lon: -68.64769535},
                    {name: 'Libertador', code: 'VE110104', lat: 11.03439017, lon: -68.4610218}
                ],
                'Bolívar': [
                    {name: 'San Luis', code: 'VE110201', lat: 11.10477092, lon: -69.66637322},
                    {name: 'Aracua', code: 'VE110202', lat: 10.98470846, lon: -69.65214642},
                    {name: 'La Peña', code: 'VE110203', lat: 11.15198487, lon: -69.77106732}
                ],
                'Buchivacoa': [
                    {name: 'Capatarida', code: 'VE110301', lat: 10.8809039, lon: -70.54637133},
                    {name: 'Bariro', code: 'VE110302', lat: 10.7276783, lon: -70.75393381},
                    {name: 'Borojo', code: 'VE110303', lat: 11.05663316, lon: -70.80909157},
                    {name: 'Guajiro', code: 'VE110304', lat: 10.49593928, lon: -70.73041618},
                    {name: 'Seque', code: 'VE110305', lat: 10.92004235, lon: -70.8242768},
                    {name: 'Zazarida', code: 'VE110306', lat: 11.14562733, lon: -70.43668207}
                ],
                'Cacique Manaure': [
                    {name: 'Cacique Manaure', code: 'VE110401', lat: 10.98324426, lon: -68.5492186}
                ],
                'Carirubana': [
                    {name: 'Carirubana', code: 'VE110501', lat: 11.70800214, lon: -70.17704781},
                    {name: 'Norte', code: 'VE110502', lat: 11.72300672, lon: -70.1848683},
                    {name: 'Punta Cardón', code: 'VE110503', lat: 11.68273997, lon: -70.10911622},
                    {name: 'Santa Ana', code: 'VE110504', lat: 11.7417384, lon: -69.92657822}
                ],
                'Colina': [
                    {name: 'La Vela De Coro', code: 'VE110601', lat: 11.4500542, lon: -69.52397847},
                    {name: 'Acurigua', code: 'VE110602', lat: 11.28831308, lon: -69.49053253},
                    {name: 'Guaibacoa', code: 'VE110603', lat: 11.399895, lon: -69.45788124},
                    {name: 'Las Calderas', code: 'VE110604', lat: 11.40104443, lon: -69.59439601},
                    {name: 'Macoruca', code: 'VE110605', lat: 11.21806535, lon: -69.43744817}
                ],
                'Dabajuro': [
                    {name: 'Dabajuro', code: 'VE110701', lat: 10.71471638, lon: -70.62736998}
                ],
                'Democracia': [
                    {name: 'Pedregal', code: 'VE110801', lat: 10.97000583, lon: -70.17015703},
                    {name: 'Agua Clara', code: 'VE110802', lat: 11.14909988, lon: -69.97330562},
                    {name: 'Avaria', code: 'VE110803', lat: 10.70743323, lon: -70.37390265},
                    {name: 'Piedra Grande', code: 'VE110804', lat: 10.79659042, lon: -69.93979763},
                    {name: 'Purureche', code: 'VE110805', lat: 10.74597896, lon: -70.15041157}
                ],
                'Falcón': [
                    {name: 'Pueblo Nuevo', code: 'VE110901', lat: 11.9761321, lon: -69.94726674},
                    {name: 'Adicora', code: 'VE110902', lat: 12.00778415, lon: -69.85400189},
                    {name: 'Baraived', code: 'VE110903', lat: 11.73564892, lon: -69.79759081},
                    {name: 'Buena Vista', code: 'VE110904', lat: 11.87951099, lon: -69.92392711},
                    {name: 'Jadacaquiva', code: 'VE110905', lat: 11.97432721, lon: -70.12687692},
                    {name: 'Moruy', code: 'VE110906', lat: 11.81590984, lon: -70.03644753},
                    {name: 'Adaure', code: 'VE110907', lat: 11.89323983, lon: -69.99223891},
                    {name: 'El Hato', code: 'VE110908', lat: 11.94675168, lon: -69.85344885},
                    {name: 'El Vinculo', code: 'VE110909', lat: 12.10398171, lon: -69.97837865}
                ],
                'Federación': [
                    {name: 'Churuguara', code: 'VE111001', lat: 10.83359155, lon: -69.53256139},
                    {name: 'Agua Larga', code: 'VE111002', lat: 10.87537064, lon: -69.74504984},
                    {name: 'El Paují', code: 'VE111003', lat: 10.78777135, lon: -69.65896754},
                    {name: 'Independencia', code: 'VE111004', lat: 10.75618967, lon: -69.76570208},
                    {name: 'Maparari', code: 'VE111005', lat: 10.78940583, lon: -69.39898656}
                ],
                'Iturriza': [
                    {name: 'Chichiriviche', code: 'VE111501', lat: 10.92339778, lon: -68.31984791},
                    {name: 'Boca De Tocuyo', code: 'VE111502', lat: 11.03076388, lon: -68.34155124},
                    {name: 'Tocuyo De La Costa', code: 'VE111503', lat: 10.8318917, lon: -68.65525681}
                ],
                'Jacura': [
                    {name: 'Jacura', code: 'VE111101', lat: 11.07251923, lon: -68.87049143},
                    {name: 'Agua Linda', code: 'VE111102', lat: 11.00489884, lon: -69.06509329},
                    {name: 'Araurima', code: 'VE111103', lat: 10.91352425, lon: -68.75880756}
                ],
                'Los Taques': [
                    {name: 'Los Taques', code: 'VE111201', lat: 11.84549364, lon: -70.22999773},
                    {name: 'Judibana', code: 'VE111202', lat: 11.77965584, lon: -70.15224719}
                ],
                'Mauroa': [
                    {name: 'Mene De Mauroa', code: 'VE111301', lat: 10.58616368, lon: -70.93908986},
                    {name: 'Casigua', code: 'VE111302', lat: 10.88137402, lon: -70.97342666},
                    {name: 'San Félix', code: 'VE111303', lat: 10.87293513, lon: -71.14177264}
                ],
                'Miranda': [
                    {name: 'San Antonio', code: 'VE111401', lat: 11.32876197, lon: -69.77166326},
                    {name: 'San Gabriel', code: 'VE111402', lat: 11.46930807, lon: -69.67113515},
                    {name: 'Santa Ana', code: 'VE111403', lat: 11.40197964, lon: -69.78558082},
                    {name: 'Guzmán Guillermo', code: 'VE111404', lat: 11.282723, lon: -69.65977178},
                    {name: 'Mitare', code: 'VE111405', lat: 11.39166569, lon: -70.02851841},
                    {name: 'Rio Seco', code: 'VE111406', lat: 11.29896909, lon: -70.18768099},
                    {name: 'Sabaneta', code: 'VE111407', lat: 11.23181048, lon: -70.00472221}
                ],
                'Palmasola': [
                    {name: 'Palmasola', code: 'VE111601', lat: 10.67682228, lon: -68.56365561}
                ],
                'Petit': [
                    {name: 'Cabure', code: 'VE111701', lat: 11.04100763, lon: -69.44420492},
                    {name: 'Colina', code: 'VE111702', lat: 11.1324348, lon: -69.40033938},
                    {name: 'Curimagua', code: 'VE111703', lat: 11.18187153, lon: -69.66416927}
                ],
                'Píritu': [
                    {name: 'Piritu', code: 'VE111801', lat: 11.32151139, lon: -69.09518999},
                    {name: 'San José De La Costa', code: 'VE111802', lat: 11.3482799, lon: -68.87488353}
                ],
                'San Francisco': [
                    {name: 'San Francisco', code: 'VE111901', lat: 11.13600451, lon: -68.71278797}
                ],
                'Silva': [
                    {name: 'Tucacas', code: 'VE112001', lat: 10.80123111, lon: -68.45141089},
                    {name: 'Boca De Aroa', code: 'VE112002', lat: 10.64940653, lon: -68.37900929}
                ],
                'Sucre': [
                    {name: 'Sucre', code: 'VE112101', lat: 11.04202683, lon: -69.7438609},
                    {name: 'Pecaya', code: 'VE112102', lat: 11.00330059, lon: -69.92490702}
                ],
                'Tocópero': [
                    {name: 'Tocopero', code: 'VE112201', lat: 11.48894209, lon: -69.233147}
                ],
                'Unión': [
                    {name: 'Santa Cruz De Bucaral', code: 'VE112301', lat: 10.8332294, lon: -69.27158513},
                    {name: 'El Charal', code: 'VE112302', lat: 10.9092948, lon: -69.19982363},
                    {name: 'Las Vegas Deltuy', code: 'VE112303', lat: 10.75359836, lon: -69.06949238}
                ],
                'Urumaco': [
                    {name: 'Urumaco', code: 'VE112401', lat: 11.20296812, lon: -70.24416981},
                    {name: 'Bruzual', code: 'VE112402', lat: 11.00972272, lon: -70.33166994}
                ],
                'Zamora': [
                    {name: 'Puerto Cumarebo', code: 'VE112501', lat: 11.4015088, lon: -69.37212241},
                    {name: 'La Ciénaga', code: 'VE112502', lat: 11.45652246, lon: -69.35552471},
                    {name: 'La Soledad', code: 'VE112503', lat: 11.41730855, lon: -69.39129029},
                    {name: 'Pueblo Cumarebo', code: 'VE112504', lat: 11.42026937, lon: -69.27318417},
                    {name: 'Zazarida', code: 'VE112505', lat: 11.24278665, lon: -69.30867761}
                ]
            },
            'Lara': {
                'Andrés Eloy Blanco': [
                    {name: 'Pio Tamayo', code: 'VE130101', lat: 9.67828302, lon: -69.62995324},
                    {name: 'Quebrada Honda De Guache', code: 'VE130102', lat: 9.59018399, lon: -69.48768461},
                    {name: 'Yacambu', code: 'VE130103', lat: 9.70245754, lon: -69.45871387}
                ],
                'Crespo': [
                    {name: 'Freitez', code: 'VE130201', lat: 10.31526712, lon: -69.10789116},
                    {name: 'José María Blanco', code: 'VE130202', lat: 10.34603488, lon: -69.22763191}
                ],
                'Iribarren': [
                    {name: 'Catedral', code: 'VE130301', lat: 10.09649186, lon: -69.29135222},
                    {name: 'Concepción', code: 'VE130302', lat: 10.05506446, lon: -69.33301511},
                    {name: 'El Cují', code: 'VE130303', lat: 10.18640708, lon: -69.35835532},
                    {name: 'Juan De Villegas', code: 'VE130304', lat: 10.03197771, lon: -69.45899923},
                    {name: 'Santa Rosa', code: 'VE130305', lat: 10.10574998, lon: -69.2401626},
                    {name: 'Tamaca', code: 'VE130306', lat: 10.24544264, lon: -69.27677288},
                    {name: 'Unión', code: 'VE130307', lat: 10.12635374, lon: -69.3928566},
                    {name: 'Aguedo Felipe Alvarado', code: 'VE130308', lat: 10.33061695, lon: -69.47908661},
                    {name: 'Buena Vista', code: 'VE130309', lat: 9.83819975, lon: -69.43081789},
                    {name: 'Juárez', code: 'VE130310', lat: 9.87253181, lon: -69.34321909}
                ],
                'Jiménez': [
                    {name: 'Juan Bautista Rodríguez', code: 'VE130401', lat: 9.98086183, lon: -69.68019183},
                    {name: 'Cuara', code: 'VE130402', lat: 9.86866032, lon: -69.60043793},
                    {name: 'Diego De Lozada', code: 'VE130403', lat: 9.79152775, lon: -69.56697152},
                    {name: 'Paraíso De San José', code: 'VE130404', lat: 9.79920161, lon: -69.50820943},
                    {name: 'San Miguel', code: 'VE130405', lat: 9.86131583, lon: -69.5173355},
                    {name: 'Tintorero', code: 'VE130406', lat: 10.02821664, lon: -69.5897456},
                    {name: 'Cabo José Dorante', code: 'VE130407', lat: 9.88224512, lon: -69.68425194},
                    {name: 'Coronel Mariano Peraza', code: 'VE130408', lat: 9.98113561, lon: -69.62207757}
                ],
                'Morán': [
                    {name: 'Bolívar', code: 'VE130501', lat: 9.82351904, lon: -69.80727837},
                    {name: 'Anzoátegui', code: 'VE130502', lat: 9.60890229, lon: -69.88498006},
                    {name: 'Guárico', code: 'VE130503', lat: 9.59148419, lon: -69.7453833},
                    {name: 'Hilario Luna Y Luna', code: 'VE130504', lat: 9.46845975, lon: -69.75842021},
                    {name: 'Humocaro Alto', code: 'VE130505', lat: 9.57110221, lon: -70.03841633},
                    {name: 'Humocaro Bajo', code: 'VE130506', lat: 9.68841285, lon: -69.97708399},
                    {name: 'La Candelaria', code: 'VE130507', lat: 9.45504152, lon: -70.0450954},
                    {name: 'Moran', code: 'VE130508', lat: 9.82017507, lon: -69.98877793}
                ],
                'Palavecino': [
                    {name: 'Cabudare', code: 'VE130601', lat: 10.03537569, lon: -69.24943579},
                    {name: 'José Gregorio Bastidas', code: 'VE130602', lat: 9.97606442, lon: -69.21350106},
                    {name: 'Agua Viva', code: 'VE130603', lat: 9.97243387, lon: -69.2961193}
                ],
                'Simón Planas': [
                    {name: 'Sarare', code: 'VE130701', lat: 9.81740667, lon: -69.14621444},
                    {name: 'Buria', code: 'VE130702', lat: 9.89965902, lon: -69.01991248},
                    {name: 'Gustavo Vegas León', code: 'VE130703', lat: 9.74185913, lon: -69.21557363}
                ],
                'Torres': [
                    {name: 'Trinidad Samuel', code: 'VE130801', lat: 10.13133837, lon: -70.1196252},
                    {name: 'Antonio Díaz', code: 'VE130802', lat: 9.9851882, lon: -69.93674577},
                    {name: 'Reyes Vargas', code: 'VE130803', lat: 10.3537167, lon: -69.79520694},
                    {name: 'Castañeda', code: 'VE130804', lat: 10.11578459, lon: -69.75757686},
                    {name: 'Cecilio Zubillaga', code: 'VE130805', lat: 9.8562293, lon: -70.17089919},
                    {name: 'Chiquinquira', code: 'VE130806', lat: 10.3069911, lon: -70.03358279},
                    {name: 'El Blanco', code: 'VE130807', lat: 10.29703967, lon: -70.51006936},
                    {name: 'Espinoza De Los Monteros', code: 'VE130808', lat: 10.16881631, lon: -69.88636696},
                    {name: 'Lara', code: 'VE130809', lat: 9.90320218, lon: -70.06885658},
                    {name: 'Las Mercedes', code: 'VE130810', lat: 10.0700142, lon: -70.40534767},
                    {name: 'Manuel Morillo', code: 'VE130811', lat: 9.91401255, lon: -70.27284843},
                    {name: 'Montaña Verde', code: 'VE130812', lat: 10.08293383, lon: -70.7130866},
                    {name: 'Montes De Oca', code: 'VE130813', lat: 10.341279, lon: -70.35737295},
                    {name: 'Torres', code: 'VE130814', lat: 9.79852107, lon: -70.12146488},
                    {name: 'Camacaro', code: 'VE130816', lat: 10.28157537, lon: -69.93329084},
                    {name: 'Altagracia', code: 'VE130817', lat: 10.42821644, lon: -70.24134306}
                ],
                'Urdaneta': [
                    {name: 'Siquisique', code: 'VE130901', lat: 10.579766, lon: -69.70561694},
                    {name: 'Moroturo', code: 'VE130902', lat: 10.59452778, lon: -69.13246802},
                    {name: 'San Miguel', code: 'VE130903', lat: 10.58226917, lon: -69.43275043},
                    {name: 'Xaguas', code: 'VE130904', lat: 10.5764818, lon: -70.03484248}
                ]
            },
            'Trujillo': {
                'Andrés Bello': [
                    {name: 'Santa Isabel', code: 'VE210101', lat: 9.63473675, lon: -70.79678204},
                    {name: 'Araguaney', code: 'VE210102', lat: 9.59534955, lon: -70.69138568},
                    {name: 'El Jaguito', code: 'VE210103', lat: 9.5894967, lon: -70.76641451},
                    {name: 'La Esperanza', code: 'VE210104', lat: 9.68368815, lon: -70.7042042}
                ],
                'Boconó': [
                    {name: 'Bocono', code: 'VE210201', lat: 9.23094352, lon: -70.29624743},
                    {name: 'El Carmen', code: 'VE210202', lat: 9.25813534, lon: -70.23347729},
                    {name: 'Mosquey', code: 'VE210203', lat: 9.28885602, lon: -70.18718061},
                    {name: 'Ayacucho', code: 'VE210204', lat: 9.32692099, lon: -70.13288858},
                    {name: 'Burbusay', code: 'VE210205', lat: 9.42682152, lon: -70.27335928},
                    {name: 'General Rivas', code: 'VE210206', lat: 9.04616842, lon: -70.49426142},
                    {name: 'Guaramacal', code: 'VE210207', lat: 9.14741708, lon: -70.16444964},
                    {name: 'Vega De Guaramacal', code: 'VE210208', lat: 9.25584252, lon: -70.11947088},
                    {name: 'Monseñor Jáuregui', code: 'VE210209', lat: 9.09323534, lon: -70.34786432},
                    {name: 'Rafael Rangel', code: 'VE210210', lat: 9.33975516, lon: -70.26820786},
                    {name: 'San Miguel', code: 'VE210211', lat: 9.40660169, lon: -70.17044203},
                    {name: 'San José', code: 'VE210212', lat: 9.18473068, lon: -70.3746637}
                ],
                'Bolívar': [
                    {name: 'Sabana Grande', code: 'VE210301', lat: 9.4261077, lon: -70.81895564},
                    {name: 'Cheregue', code: 'VE210302', lat: 9.3395, lon: -70.83911563},
                    {name: 'Granados', code: 'VE210303', lat: 9.39330321, lon: -70.8409197}
                ],
                'Campo Elías': [
                    {name: 'Campo Elías', code: 'VE210801', lat: 9.42658756, lon: -70.07784448},
                    {name: 'Arnoldo Gabaldon', code: 'VE210802', lat: 9.37444236, lon: -70.0942854}
                ],
                'Candelaria': [
                    {name: 'Chejende', code: 'VE210401', lat: 9.69956074, lon: -70.42811053},
                    {name: 'Arnoldo Gabaldon', code: 'VE210402', lat: 9.62280549, lon: -70.49211025},
                    {name: 'Bolivia', code: 'VE210403', lat: 9.55892836, lon: -70.34745396},
                    {name: 'Carrillo', code: 'VE210404', lat: 9.57352847, lon: -70.39918203},
                    {name: 'Cegarra', code: 'VE210405', lat: 9.57075394, lon: -70.35259827},
                    {name: 'Manuel Salvador Ulloa', code: 'VE210406', lat: 9.71094956, lon: -70.5245357},
                    {name: 'San José', code: 'VE210407', lat: 9.63677967, lon: -70.45437385}
                ],
                'Carache': [
                    {name: 'Carache', code: 'VE210501', lat: 9.61657051, lon: -70.19915077},
                    {name: 'Cuicas', code: 'VE210502', lat: 9.73307748, lon: -70.30683181},
                    {name: 'La Concepción', code: 'VE210503', lat: 9.51225418, lon: -70.21428748},
                    {name: 'Panamericana', code: 'VE210504', lat: 9.73423642, lon: -70.38745246},
                    {name: 'Santa Cruz', code: 'VE210505', lat: 9.72513806, lon: -70.16240836}
                ],
                'Carvajal': [
                    {name: 'Carvajal', code: 'VE211601', lat: 9.30127172, lon: -70.58083425},
                    {name: 'Antonio Nicolás Briceño', code: 'VE211602', lat: 9.36874398, lon: -70.56973578},
                    {name: 'Campo Alegre', code: 'VE211603', lat: 9.3416974, lon: -70.57495823},
                    {name: 'José Leonardo Suarez', code: 'VE211604', lat: 9.41192721, lon: -70.56442131}
                ],
                'Escuque': [
                    {name: 'Escuque', code: 'VE210601', lat: 9.24959787, lon: -70.72784959},
                    {name: 'La Unión', code: 'VE210602', lat: 9.29285177, lon: -70.73540058},
                    {name: 'Sabana Libre', code: 'VE210603', lat: 9.34694748, lon: -70.64633651},
                    {name: 'Santa Rita', code: 'VE210604', lat: 9.3148462, lon: -70.65598541}
                ],
                'La Ceiba': [
                    {name: 'Santa Apolonia', code: 'VE210901', lat: 9.44859149, lon: -71.00892694},
                    {name: 'El Progreso', code: 'VE210902', lat: 9.42605689, lon: -70.94501304},
                    {name: 'La Ceiba', code: 'VE210903', lat: 9.50214887, lon: -71.04884375},
                    {name: 'Tres De Febrero', code: 'VE210904', lat: 9.55521209, lon: -70.95907876}
                ],
                'Miranda': [
                    {name: 'El Dividive', code: 'VE211001', lat: 9.46847877, lon: -70.71784853},
                    {name: 'Agua Santa', code: 'VE211002', lat: 9.48792819, lon: -70.65796393},
                    {name: 'Agua Caliente', code: 'VE211003', lat: 9.60934419, lon: -70.61109854},
                    {name: 'El Cenizo', code: 'VE211004', lat: 9.53655017, lon: -70.74590386},
                    {name: 'Valerita', code: 'VE211005', lat: 9.68172333, lon: -70.57894532}
                ],
                'Monte Carmelo': [
                    {name: 'Monte Carmelo', code: 'VE211101', lat: 9.17006965, lon: -70.82190883},
                    {name: 'Buena Vista', code: 'VE211102', lat: 9.28607658, lon: -70.87887043},
                    {name: 'Santa María Del Horcon', code: 'VE211103', lat: 9.33722078, lon: -70.97609003}
                ],
                'Motatán': [
                    {name: 'Motatan', code: 'VE211201', lat: 9.39158703, lon: -70.61065973},
                    {name: 'El Baño', code: 'VE211202', lat: 9.39743368, lon: -70.64053974},
                    {name: 'Jalisco', code: 'VE211203', lat: 9.48395755, lon: -70.60346039}
                ],
                'Márquez Cañizales': [
                    {name: 'El Socorro', code: 'VE210701', lat: 9.83086981, lon: -70.50343172},
                    {name: 'Antonio José De Sucre', code: 'VE210702', lat: 9.74884107, lon: -70.63562196},
                    {name: 'Los Caprichos', code: 'VE210703', lat: 9.92903467, lon: -70.63070552}
                ],
                'Pampanito': [
                    {name: 'Pampanito', code: 'VE211401', lat: 9.41629812, lon: -70.50151505},
                    {name: 'La Concepción', code: 'VE211402', lat: 9.42655705, lon: -70.47204228},
                    {name: 'Pampanito Ii', code: 'VE211403', lat: 9.42819456, lon: -70.53642459}
                ],
                'Pampán': [
                    {name: 'Pampan', code: 'VE211301', lat: 9.53013984, lon: -70.5333576},
                    {name: 'Flor De Patria', code: 'VE211302', lat: 9.51562706, lon: -70.47256108},
                    {name: 'La Paz', code: 'VE211303', lat: 9.54549332, lon: -70.45543314},
                    {name: 'Santa Ana', code: 'VE211304', lat: 9.47854691, lon: -70.35423753}
                ],
                'Rangel': [
                    {name: 'Betijoque', code: 'VE211501', lat: 9.32714321, lon: -70.76843577},
                    {name: 'La Pueblita', code: 'VE211502', lat: 9.39189664, lon: -70.73193618},
                    {name: 'Los Cedros', code: 'VE211503', lat: 9.33281975, lon: -70.73090508},
                    {name: 'José Gregorio Hernández', code: 'VE211504', lat: 9.36798976, lon: -70.69320861}
                ],
                'Sucre': [
                    {name: 'Sabana De Mendoza', code: 'VE211701', lat: 9.42111093, lon: -70.72548059},
                    {name: 'El Paraíso', code: 'VE211702', lat: 9.56164554, lon: -70.85954728},
                    {name: 'Junín', code: 'VE211703', lat: 9.49651371, lon: -70.86052059},
                    {name: 'Valmore Rodríguez', code: 'VE211704', lat: 9.46864517, lon: -70.78906382}
                ],
                'Trujillo': [
                    {name: 'Andrés Linares', code: 'VE211801', lat: 9.24583727, lon: -70.46522039},
                    {name: 'Chiquinquira', code: 'VE211802', lat: 9.33469002, lon: -70.51529993},
                    {name: 'Cristóbal Mendoza', code: 'VE211803', lat: 9.38280678, lon: -70.44297546},
                    {name: 'Cruz Carrillo', code: 'VE211804', lat: 9.39692635, lon: -70.3660351},
                    {name: 'Matriz', code: 'VE211805', lat: 9.34292484, lon: -70.36742354},
                    {name: 'Monseñor Carrillo', code: 'VE211806', lat: 9.29785115, lon: -70.41384959},
                    {name: 'Tres Esquinas', code: 'VE211807', lat: 9.41279458, lon: -70.45452216}
                ],
                'Urdaneta': [
                    {name: 'La Quebrada', code: 'VE211901', lat: 9.14984277, lon: -70.56544216},
                    {name: 'Cabimbu', code: 'VE211902', lat: 9.16680047, lon: -70.47757123},
                    {name: 'Jajo', code: 'VE211903', lat: 9.10327476, lon: -70.63883409},
                    {name: 'La Mesa', code: 'VE211904', lat: 9.03894884, lon: -70.69055477},
                    {name: 'Santiago', code: 'VE211905', lat: 9.22632094, lon: -70.53587904},
                    {name: 'Tuñame', code: 'VE211906', lat: 9.04406912, lon: -70.59732674}
                ],
                'Valera': [
                    {name: 'Juan Ignacio Montilla', code: 'VE212001', lat: 9.30712777, lon: -70.60644154},
                    {name: 'La Beatriz', code: 'VE212002', lat: 9.25043575, lon: -70.60160074},
                    {name: 'Mercedes Díaz', code: 'VE212003', lat: 9.30239911, lon: -70.62878613},
                    {name: 'San Luis', code: 'VE212004', lat: 9.34144884, lon: -70.61273719},
                    {name: 'La Puerta', code: 'VE212005', lat: 9.11507228, lon: -70.72539679},
                    {name: 'Mendoza', code: 'VE212006', lat: 9.20717343, lon: -70.66771827}
                ]
            }
        };

// Current state variable
let currentState = 'Zulia';

// Centers for maps
const ZULIA_CENTER = [10.0, -72.0];
const FALCON_CENTER = [11.3, -69.2];
const LARA_CENTER = [10.0, -69.6];
const TRUJILLO_CENTER = [9.4, -70.5];
const ALL_STATES_CENTER = [9.9, -70.3];

// Function to get active coordinates based on selected state
function getActiveCoordinates() {
  if (currentState === 'Falcón') return falconCoordinates;
  if (currentState === 'Lara') return laraCoordinates;
  if (currentState === 'Trujillo') return trujilloCoordinates;
  if (currentState === 'Todos') return { ...zuliaCoordinates, ...falconCoordinates, ...laraCoordinates, ...trujilloCoordinates };
  return zuliaCoordinates;
}

// Function to get active municipalities list
function getActiveMunicipalities() {
  const coords = getActiveCoordinates();
  return Object.keys(coords).filter(m => !m.includes('Alternative') && !m.includes('Colon') && !m.includes('Simon') && !m.includes('Jesus') && !m.includes('Valmore') && !m.includes('Machiques') && !m.includes('Rosario') && !m.includes('La') && !m.includes('Guajira') && !m.includes('Ciudad'));
}

// Get official municipalities only
function getOfficialMunicipalities(state) {
  // If state is provided as parameter, use it; otherwise use currentState
  const activeState = state || currentState;

  // Return municipalities based on current state
  if (activeState === 'Falcón') {
    return [
      'Acosta', 'Bolívar', 'Buchivacoa', 'Cacique Manaure', 'Carirubana',
      'Colina', 'Dabajuro', 'Democracia', 'Falcón', 'Federación',
      'Iturriza', 'Jacura', 'Los Taques', 'Mauroa', 'Miranda',
      'Palmasola', 'Petit', 'Píritu', 'San Francisco', 'Silva',
      'Sucre', 'Tocópero', 'Unión', 'Urumaco', 'Zamora'
    ];
  }

  if (activeState === 'Lara') {
    return [
      'Andrés Eloy Blanco', 'Crespo', 'Iribarren', 'Jiménez', 'Morán',
      'Palavecino', 'Simón Planas', 'Torres', 'Urdaneta'
    ];
  }

  if (activeState === 'Trujillo') {
    return [
      'Andrés Bello', 'Boconó', 'Bolívar', 'Candelaria', 'Carache',
      'Carvajal', 'Campo Elías', 'Escuque', 'La Ceiba', 'Márquez Cañizales',
      'Miranda', 'Monte Carmelo', 'Motatán', 'Pampán', 'Pampanito',
      'Rangel', 'Sucre', 'Trujillo', 'Urdaneta', 'Valera'
    ];
  }

  if (activeState === 'Todos') {
    return [
      // Zulia (22 municipios)
      'Almirante Padilla', 'Baralt', 'Cabimas', 'Catatumbo', 'Colón',
      'Francisco Javier Pulgar', 'Indígena Bolivariano Guajira',
      'Jesús Enrique Lossada', 'Jesús María Semprún',
      'La Cañada de Urdaneta', 'Lagunillas', 'Machiques de Perijá',
      'Mara', 'Maracaibo', 'Miranda', 'Páez', 'Rosario de Perijá',
      'San Francisco', 'Santa Rita', 'Simón Bolívar', 'Sucre',
      'Valmore Rodríguez',
      // Falcón (25 municipios)
      'Acosta', 'Bolívar', 'Buchivacoa', 'Cacique Manaure', 'Carirubana',
      'Colina', 'Dabajuro', 'Democracia', 'Falcón', 'Federación',
      'Iturriza', 'Jacura', 'Los Taques', 'Mauroa', 'Miranda',
      'Palmasola', 'Petit', 'Píritu', 'San Francisco', 'Silva',
      'Sucre', 'Tocópero', 'Unión', 'Urumaco', 'Zamora',
      // Lara (9 municipios)
      'Andrés Eloy Blanco', 'Crespo', 'Iribarren', 'Jiménez', 'Morán',
      'Palavecino', 'Simón Planas', 'Torres', 'Urdaneta',
      // Trujillo (20 municipios)
      'Andrés Bello', 'Boconó', 'Bolívar', 'Candelaria', 'Carache',
      'Carvajal', 'Campo Elías', 'Escuque', 'La Ceiba', 'Márquez Cañizales',
      'Miranda', 'Monte Carmelo', 'Motatán', 'Pampán', 'Pampanito',
      'Rangel', 'Sucre', 'Trujillo', 'Urdaneta', 'Valera'
    ];
  }

  // Default: Zulia (22 municipios)
  return [
    'Almirante Padilla', 'Baralt', 'Cabimas', 'Catatumbo', 'Colón',
    'Francisco Javier Pulgar', 'Indígena Bolivariano Guajira',
    'Jesús Enrique Lossada', 'Jesús María Semprún',
    'La Cañada de Urdaneta', 'Lagunillas', 'Machiques de Perijá',
    'Mara', 'Maracaibo', 'Miranda', 'Páez', 'Rosario de Perijá',
    'San Francisco', 'Santa Rita', 'Simón Bolívar', 'Sucre',
    'Valmore Rodríguez'
  ];
}

// Update map center based on state
function getMapCenter() {
  if (currentState === 'Falcón') return FALCON_CENTER;
  if (currentState === 'Lara') return LARA_CENTER;
  if (currentState === 'Trujillo') return TRUJILLO_CENTER;
  if (currentState === 'Todos') return ALL_STATES_CENTER;
  return ZULIA_CENTER;
}

// Update map zoom based on state
function getMapZoom() {
  if (currentState === 'Todos') return 6;
  return 8;
}

        // Load data from external JSON
        let sampleProjectsData = [];

        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://mrptjbktrcxatnibuhvq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ycHRqYmt0cmN4YXRuaWJ1aHZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzI0OTksImV4cCI6MjA3NzE0ODQ5OX0.5NmNN3AeXs8pL-I_fWb6wgNdaoRbdBi1jvK_6XTvf3Y';

        // Initialize Supabase client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Function to load data from JSON file
        async function loadDataFromJSON() {
            try {
                const response = await fetch('proyectos-zulia-falcon.json');
                if (response.ok) {
                    sampleProjectsData = await response.json();
                    console.log('✓ Data loaded from JSON:', sampleProjectsData.length, 'projects');
                    return true;
                }
            } catch (e) {
                console.warn('Could not load JSON, using fallback...');
            }
            return false;
        }

        // Function to load data from Supabase
        async function loadDataFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('proyectos')
                    .select('*')
                    .in('Estado', ['Zulia', 'Falcón', 'Lara', 'Trujillo']);

                if (error) {
                    console.warn('Supabase error:', error);
                    return false;
                }

                if (data && data.length > 0) {
                    sampleProjectsData = data;
                    console.log('✓ Data loaded from Supabase:', sampleProjectsData.length, 'projects');
                    return true;
                }
            } catch (e) {
                console.warn('Supabase connection error:', e);
            }
            return false;
        }

        // Function to upsert projects into Supabase (insert or update by composite key)
        // Requires unique constraint: ("Código del proyecto", "Municipio", "Parroquias")
        async function insertProjectsToSupabase(projects) {
            try {
                if (!projects || projects.length === 0) {
                    console.warn('No projects to upsert');
                    return false;
                }

                // Remove id, created_at, updated_at — auto-managed by Supabase
                const projectsToUpsert = projects.map(p => {
                    const { id, created_at, updated_at, created_by, updated_by, ...rest } = p;
                    return rest;
                });

                const { data, error } = await supabaseClient
                    .from('proyectos')
                    .upsert(projectsToUpsert, {
                        onConflict: '"Código del proyecto","Municipio","Parroquias"',
                        ignoreDuplicates: false
                    })
                    .select();

                if (error) {
                    console.error('Supabase upsert error:', error);
                    alert('Error al guardar en Supabase: ' + error.message);
                    return false;
                }

                console.log('✓ Upserted', data.length, 'records to Supabase');
                return true;
            } catch (e) {
                console.error('Supabase upsert error:', e);
                return false;
            }
        }

        // Function to reload data from Supabase
        async function reloadDataFromSupabase() {
            const loaded = await loadDataFromSupabase();
            if (loaded) {
                projectsData = sampleProjectsData;
                expandedData = expandProjectData(projectsData);
                applyFilters();
                initializeCharts();
                updateTable();
                updateMapMarkers();
            }
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            // Try to load data from Supabase first, then fall back to JSON
            const supabaseLoaded = await loadDataFromSupabase();
            if (!supabaseLoaded) {
                await loadDataFromJSON();
            }

            // If no data loaded, show message
            if (sampleProjectsData.length === 0) {
                console.warn('⚠️  No data loaded. Using fallback...');
                // Add fallback data here if needed
            }

            projectsData = sampleProjectsData;

            // Expand data for proper filtering
            expandedData = expandProjectData(projectsData);
            console.log('✓ Loaded', projectsData.length, 'original projects');
            console.log('✓ Expanded to', expandedData.length, 'filterable rows');

            // Setup state selector listeners
            setupStateListeners();

            // Initialize dashboard
            initializeDashboard();
        });

        // Function to setup state radio button listeners
        function setupStateListeners() {
            document.querySelectorAll('input[name="state"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentState = e.target.value;

                    // Update title
                    const stateNames = {
                        'Zulia': 'Zulia',
                        'Falcón': 'Falcón',
                        'Lara': 'Lara',
                        'Trujillo': 'Trujillo',
                        'Todos': 'Zulia, Falcón, Lara y Trujillo'
                    };
                    document.getElementById('stateTitle').textContent = stateNames[currentState];

                    // Update filter indicator in header
                    updateHeaderFilterIndicator();

                    // Update map center and zoom
                    if (map) {
                        map.setView(getMapCenter(), getMapZoom());
                    }

                    // Update municipality list
                    updateMunicipalityList();

                    // Filter data by state and apply other filters
                    filterDataByState();

                    console.log('✓ State changed to:', currentState);
                });
            });
        }

        // Function to update header filter indicator
        function updateHeaderFilterIndicator() {
            const indicator = document.getElementById('filterIndicator');
            const municipios = getSelectedMunicipalities();

            let indicatorText = '';

            if (municipios.length > 0) {
                if (municipios.length === 1) {
                    indicatorText = `📍 ${municipios[0]}`;
                } else {
                    indicatorText = `📍 ${municipios.length} municipios seleccionados`;
                }
            }

            indicator.textContent = indicatorText;
        }

        // Function to filter data by current state
        function filterDataByState() {
            // Just call applyFilters which now handles state filtering
            applyFilters();
        }

        // ============================================
        // PARROQUIA FILTER FUNCTIONS
        // ============================================

        // Helper: find parish data for a municipality (searches all states if needed)
        function getParroquiasForMunicipio(municipio, estado) {
            if (!municipio) return [];
            const searchStates = (estado && estado !== 'Todos')
                ? [estado]
                : ['Zulia', 'Falcón', 'Lara', 'Trujillo'];
            for (const st of searchStates) {
                if (PARROQUIAS_DATA[st] && PARROQUIAS_DATA[st][municipio]) {
                    return PARROQUIAS_DATA[st][municipio];
                }
            }
            return [];
        }

        // Update/populate the sidebar parish filter based on current municipality selection
        function updateParroquiaFilter() {
            const section = document.getElementById('parroquiaFilterSection');
            const dropdown = document.getElementById('parroquiaDropdown');
            if (!section || !dropdown) return;

            const selectedMunicipios = getSelectedMunicipalities();

            // Show when at least 1 municipality is selected
            if (selectedMunicipios.length === 0) {
                section.classList.remove('visible');
                currentFilters.parroquia = [];
                return;
            }

            // Collect parishes for ALL selected municipalities
            const hasAny = selectedMunicipios.some(m => getParroquiasForMunicipio(m, currentState).length > 0);
            if (!hasAny) {
                section.classList.remove('visible');
                return;
            }

            // Populate dropdown — group by municipality when multiple selected
            dropdown.innerHTML = `
                <div class="multi-select-option">
                    <input type="checkbox" id="all-parroquias" checked>
                    <label for="all-parroquias">Todas las Parroquias</label>
                </div>
            `;

            if (selectedMunicipios.length === 1) {
                // Single municipality — flat list
                const parroquias = getParroquiasForMunicipio(selectedMunicipios[0], currentState);
                parroquias.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'multi-select-option';
                    div.innerHTML = `
                        <input type="checkbox" class="parroquia-checkbox" value="${p.name}" checked>
                        <label style="cursor:pointer">${p.name}</label>
                    `;
                    dropdown.appendChild(div);
                });
            } else {
                // Multiple municipalities — grouped with headers
                selectedMunicipios.forEach(municipio => {
                    const parroquias = getParroquiasForMunicipio(municipio, currentState);
                    if (parroquias.length === 0) return;
                    const header = document.createElement('div');
                    header.style.cssText = 'padding:3px 8px; font-size:0.72rem; font-weight:700; color:#005D92; background:#eef5fb; border-top:1px solid #c8dce8; margin-top:2px; text-transform:uppercase; letter-spacing:0.03em;';
                    header.textContent = municipio;
                    dropdown.appendChild(header);
                    parroquias.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'multi-select-option';
                        div.innerHTML = `
                            <input type="checkbox" class="parroquia-checkbox" value="${p.name}" checked>
                            <label style="cursor:pointer">${p.name}</label>
                        `;
                        dropdown.appendChild(div);
                    });
                });
            }

            section.classList.add('visible');
            setupParroquiaEventListeners();
        }

        // Setup event listeners for the parish filter dropdown
        function setupParroquiaEventListeners() {
            const dropdown = document.getElementById('parroquiaDropdown');
            const display = document.getElementById('parroquiaDisplay');
            if (!dropdown || !display) return;

            const allCheck = dropdown.querySelector('#all-parroquias');
            if (!allCheck) return;

            // Clone display to remove old listeners
            const newDisplay = display.cloneNode(true);
            display.parentNode.replaceChild(newDisplay, display);

            newDisplay.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('open');
                newDisplay.classList.toggle('open');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#parroquiaFilterSection')) {
                    dropdown.classList.remove('open');
                    newDisplay.classList.remove('open');
                }
            }, { once: false });

            allCheck.addEventListener('change', () => {
                const allBoxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#all-parroquias)');
                allBoxes.forEach(cb => { cb.checked = allCheck.checked; });
                updateParroquiaDisplay();
                applyFilters();
                zoomToSelectedParroquias();
            });

            dropdown.addEventListener('change', (e) => {
                if (e.target.classList.contains('parroquia-checkbox')) {
                    const allBoxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#all-parroquias)');
                    const checkedBoxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#all-parroquias):checked');
                    if (checkedBoxes.length === 0) {
                        allCheck.checked = false;
                        allCheck.indeterminate = false;
                    } else if (checkedBoxes.length === allBoxes.length) {
                        allCheck.checked = true;
                        allCheck.indeterminate = false;
                    } else {
                        allCheck.checked = false;
                        allCheck.indeterminate = true;
                    }
                    updateParroquiaDisplay();
                    applyFilters();
                    zoomToSelectedParroquias();
                }
            });
        }

        // Update the parish display text
        function updateParroquiaDisplay() {
            const display = document.getElementById('parroquiaDisplay');
            if (!display) return;
            const span = display.querySelector('span');
            const allCheck = document.getElementById('all-parroquias');
            const checked = document.querySelectorAll('#parroquiaDropdown input[type="checkbox"]:not(#all-parroquias):checked');
            if (!allCheck || allCheck.checked || checked.length === 0) {
                if (span) span.textContent = 'Todas las Parroquias';
            } else {
                if (span) span.textContent = checked.length === 1
                    ? checked[0].value
                    : `${checked.length} parroquias seleccionadas`;
            }
        }

        // Get currently selected parishes from the filter
        function getSelectedParroquias() {
            const allCheck = document.getElementById('all-parroquias');
            if (!allCheck || allCheck.checked) return [];
            const checks = document.querySelectorAll('#parroquiaDropdown input[type="checkbox"]:not(#all-parroquias):checked');
            return Array.from(checks).map(cb => cb.value);
        }

        // Zoom map to selected parishes
        function zoomToSelectedParroquias() {
            const parroquias = getSelectedParroquias();
            if (parroquias.length === 0) return;

            const selectedMunicipios = getSelectedMunicipalities();
            if (selectedMunicipios.length !== 1) return;

            const allData = getParroquiasForMunicipio(selectedMunicipios[0], currentState);
            const coords = allData
                .filter(p => parroquias.includes(p.name))
                .map(p => [p.lat, p.lon])
                .filter(c => c[0] !== 0 && c[1] !== 0);

            if (coords.length === 1) {
                map.setView(coords[0], 13);
            } else if (coords.length > 1) {
                map.fitBounds(L.latLngBounds(coords), { padding: [30, 30] });
            }
        }

        // Update the form's parish field based on selected municipality and state
        function updateFormParroquias(municipio, estado) {
            const container = document.getElementById('formParroquiasContainer');
            const hint = document.getElementById('formParroquiasHint');
            if (!container) return;

            const parroquias = getParroquiasForMunicipio(municipio, estado);

            if (parroquias.length === 0) {
                container.innerHTML = `<input type="text" id="formParroquias" class="form-parroquia-fallback"
                    placeholder="Una sola parroquia por registro">`;
                if (hint) hint.textContent = '⚠ Cada registro corresponde a UNA parroquia.';
                return;
            }

            // Build single-select (radio) list
            const uid = Date.now(); // unique name per rebuild
            let html = `<div class="form-parroquia-multi" id="formParroquiasMulti" style="max-height:200px;">`;
            // "Cobertura Municipal" first
            html += `<label class="parroquia-option" style="border-bottom:1px solid #dde; margin-bottom:4px; padding-bottom:4px;">
                <input type="radio" name="parroquia_sel_${uid}" class="form-parroquia-radio" value="Cobertura Municipal">
                <span style="font-style:italic; color:#666;">Cobertura Municipal (todo el municipio)</span>
            </label>`;
            parroquias.forEach(p => {
                html += `<label class="parroquia-option">
                    <input type="radio" name="parroquia_sel_${uid}" class="form-parroquia-radio" value="${p.name}">
                    ${p.name}
                </label>`;
            });
            html += `</div><input type="hidden" id="formParroquias" value="">`;
            container.innerHTML = html;

            if (hint) hint.textContent = `📌 Seleccione UNA parroquia. Para múltiples, cree un registro por parroquia.`;

            // Sync hidden input on radio change
            const multi = container.querySelector('#formParroquiasMulti');
            if (multi) {
                multi.addEventListener('change', () => {
                    const sel = container.querySelector('.form-parroquia-radio:checked');
                    const hidden = document.getElementById('formParroquias');
                    if (hidden) hidden.value = sel ? sel.value : '';
                });
            }
        }

        // Initialize sector multi-select in the form
        function initFormSectores() {
            const container = document.getElementById('formSectoresContainer');
            if (!container) return;
            container.innerHTML = humanitarianSectors.map(s => `
                <label class="parroquia-option">
                    <input type="checkbox" class="form-sector-check" value="${s.name}">
                    <span><strong>${s.shortName}</strong> — ${s.name}</span>
                </label>
            `).join('');
            // Remove previous listener by replacing the element
            const newContainer = container.cloneNode(true);
            container.parentNode.replaceChild(newContainer, container);
            newContainer.addEventListener('change', () => {
                const vals = Array.from(newContainer.querySelectorAll('.form-sector-check:checked'))
                                  .map(cb => cb.value);
                const areaInput = document.getElementById('formArea');
                const sectorInput = document.getElementById('formSector');
                if (areaInput) areaInput.value = vals.join('; ');
                if (sectorInput) sectorInput.value = vals[0] || '';
            });
        }

        // Export Excel template for partner data collection (with Listas sheet)
        function exportExcelTemplate() {
            // Plantilla con filtros en cascada: Estado → Municipio → Parroquia
            // Generada con generar_plantilla.py + Admin Maestro.xlsx (342 parroquias)
            const b64 = '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';
            const bin = atob(b64);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
            const blob = new Blob([bytes], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'plantilla_proyectos_ocha.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Function to update municipality list based on state
        function updateMunicipalityList() {
            const municipiosContainer = document.getElementById('municipioDropdown');
            const municipalities = getOfficialMunicipalities();

            municipiosContainer.innerHTML = `
                <div class="multi-select-option">
                    <input type="checkbox" id="all-municipios" checked>
                    <label for="all-municipios">Todos los Municipios</label>
                </div>
            `;

            municipalities.forEach(municipio => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';
                optionDiv.innerHTML = `
                    <input type="checkbox" class="municipio-checkbox" value="${municipio}" checked>
                    <label style="cursor: pointer;">${municipio}</label>
                `;
                municipiosContainer.appendChild(optionDiv);
            });

            console.log('✓ Municipality list updated with', municipalities.length, 'municipalities');

            // Reset parish filter when municipality list changes (state change)
            const parSection = document.getElementById('parroquiaFilterSection');
            if (parSection) parSection.classList.remove('visible');
            currentFilters.parroquia = [];

            // Reinitialize event listeners after DOM is updated
            setTimeout(() => {
                setupMunicipalityEventListeners();
            }, 50);
        }

        function setupMunicipalityEventListeners() {
            const dropdown = document.getElementById('municipioDropdown');
            const display = document.getElementById('municipioDisplay');
            const allCheckbox = dropdown.querySelector('#all-municipios');

            if (!display || !dropdown || !allCheckbox) return;

            // Toggle dropdown visibility
            display.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('open');
                display.classList.toggle('open');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.multi-select-container')) {
                    dropdown.classList.remove('open');
                    display.classList.remove('open');
                }
            });

            // Handle "Todos" checkbox - event delegation
            allCheckbox.addEventListener('change', () => {
                const allCheckboxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#all-municipios)');
                allCheckboxes.forEach(cb => {
                    cb.checked = allCheckbox.checked;
                });
                updateMunicipioDisplay();
                applyFilters();
                zoomToSelectedMunicipalities();
                updateParroquiaFilter();
            });

            // Handle individual municipality checkboxes - event delegation via dropdown container
            dropdown.addEventListener('change', (e) => {
                if (e.target.classList.contains('municipio-checkbox')) {
                    const allCheckboxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#all-municipios)');
                    const checkedBoxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#all-municipios):checked');

                    // Update "Todos" state based on selections
                    if (checkedBoxes.length === 0) {
                        allCheckbox.checked = false;
                        allCheckbox.indeterminate = false;
                    } else if (checkedBoxes.length === allCheckboxes.length) {
                        allCheckbox.checked = true;
                        allCheckbox.indeterminate = false;
                    } else {
                        allCheckbox.checked = false;
                        allCheckbox.indeterminate = true;
                    }

                    updateMunicipioDisplay();
                    applyFilters();
                    zoomToSelectedMunicipalities();
                    updateParroquiaFilter();
                }
            });

            console.log('✓ Municipality event listeners initialized');
        }

        function initializeDashboard() {
            console.log('Inicializando dashboard...');

            // Initialize components FIRST
            initializeMap();
            populateFilters();
            createSectorGrid();
            initializeCharts();
            setupEventListeners();

            // Filter by current state (default is Zulia) AFTER components are ready
            filterDataByState();

            // Update displays
            updateKPIs();
            updateTable();
            updateMapMarkers();
            updateCharts();
            updateFooterInfo();

            console.log('Dashboard inicializado correctamente');
        }

        function initializeMap() {
            // Initialize Leaflet map
            map = L.map('map').setView(ZULIA_CENTER, 8);
            
            // Add Mapbox tile layer with OCHA style
            L.tileLayer('https://api.mapbox.com/styles/v1/escenarios/cmd9kqnmv008d01s2fuc4dqe4/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXNjZW5hcmlvcyIsImEiOiJjbWQ5Z2hvOWswODduMmxxMGZvYmV0eXMyIn0.1mIaAW55j4IePp400vyyRA', {
                attribution: '&copy; <a href="https://www.mapbox.com/">Mapbox</a> | &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> | OCHA',
                tileSize: 512,
                zoomOffset: -1
            }).addTo(map);

            // Add a control to recenter map
            const recenterControl = L.Control.extend({
                options: {
                    position: 'topright'
                },
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                    container.style.backgroundColor = 'white';
                    container.style.width = '30px';
                    container.style.height = '30px';
                    container.style.cursor = 'pointer';
                    container.innerHTML = '<i class="fas fa-crosshairs" style="line-height: 30px; text-align: center; display: block; color: #005a8a;"></i>';
                    container.onclick = function() {
                        map.setView(ZULIA_CENTER, 8);
                    };
                    return container;
                }
            });
            
            map.addControl(new recenterControl());
        }

        function initializeCharts() {
            // Initialize Sector Chart (Vertical Bar Chart)
            const sectorCtx = document.getElementById('sectorChart').getContext('2d');
            sectorChart = new Chart(sectorCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Número de Proyectos',
                        data: [],
                        backgroundColor: '#007DBC',
                        borderColor: '#005A8A',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Changed to 'y' for vertical bars
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: { // Changed from y to x for horizontal bars
                            beginAtZero: true,
                            display: false, // Hide horizontal axis completely
                            grid: {
                                display: false
                            }
                        },
                        y: { // Changed from x to y for horizontal bars
                            ticks: {
                                color: '#5A5A5A',
                                maxRotation: 45,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Initialize Time Chart (Doughnut Chart)
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            timeChart = new Chart(timeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['En proyecto', 'En ejecución', 'Terminado'],
                    datasets: [{
                        label: 'Estatus de Proyectos',
                        data: [],
                        backgroundColor: [
                            '#ECA154',    // En proyecto (naranja OCHA)
                            '#007DBC',    // En ejecución (azul OCHA)
                            '#7DBA00'     // Terminado (verde OCHA)
                        ],
                        borderColor: [
                            '#ECA154',
                            '#007DBC', 
                            '#7DBA00'
                        ],
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#5A5A5A',
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return `${context.label}: ${context.parsed} proyectos (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function populateFilters() {
            const orgFilter = document.getElementById('orgFilter');
            const estatusFilter = document.getElementById('estatusFilter');

            // Get unique normalized organization values
            const organizations = [...new Set(
                projectsData.map(p => normalizeOrganizationName(p['Organización Líder']))
                    .filter(Boolean)
            )].sort();

            const statuses = [...new Set(projectsData.map(p => p['Estatus']))].filter(Boolean);

            // Populate organization dropdown
            organizations.sort().forEach(org => {
                const option = document.createElement('option');
                option.value = org;
                option.textContent = org;
                orgFilter.appendChild(option);
            });

            // NOTE: Municipality filter is handled by updateMunicipalityList()
            // which is called when state changes and during dashboard initialization

            // Use normalized status values consistently
            const estatus = ['En proyecto', 'En ejecución', 'Terminado'];
            estatus.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                estatusFilter.appendChild(option);
            });

            // Update municipality list for current state (this will also initialize the multi-select)
            updateMunicipalityList();
        }

        
        function updateMunicipioDisplay() {
            const display = document.getElementById('municipioDisplay');
            const span = display.querySelector('span');
            const allCheckbox = document.getElementById('all-municipios');
            const checkboxes = document.querySelectorAll('#municipioDropdown input[type="checkbox"]:not(#all-municipios):checked');

            if (allCheckbox.checked || checkboxes.length === 0) {
                span.textContent = 'Todos los Municipios';
            } else if (checkboxes.length === 1) {
                span.textContent = checkboxes[0].value;
            } else {
                span.textContent = `${checkboxes.length} municipios seleccionados`;
            }

            // Also update the header filter indicator
            updateHeaderFilterIndicator();
        }
        
        function getSelectedMunicipalities() {
            const allCheckbox = document.getElementById('all-municipios');
            if (allCheckbox.checked) return [];
            
            const checkboxes = document.querySelectorAll('#municipioDropdown input[type="checkbox"]:not(#all-municipios):checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function zoomToSelectedMunicipalities() {
            const selectedMunicipalities = getSelectedMunicipalities();
            
            if (selectedMunicipalities.length === 0) {
                // If no specific municipalities selected, zoom to full state
                map.setView(ZULIA_CENTER, 8);
                return;
            }
            
            // Get coordinates of selected municipalities
            const activeCoords = getActiveCoordinates();
            const validCoordinates = selectedMunicipalities
                .map(municipio => activeCoords[municipio])
                .filter(coords => coords);
            
            if (validCoordinates.length === 0) {
                map.setView(ZULIA_CENTER, 8);
                return;
            }
            
            if (validCoordinates.length === 1) {
                // Zoom to single municipality
                map.setView(validCoordinates[0], 11);
            } else {
                // Fit bounds to all selected municipalities
                const bounds = L.latLngBounds(validCoordinates);
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        function normalizeStatus(status) {
            if (!status || status === 'nan' || status === '' || status === 'NaN') return 'En proyecto';
            
            const statusLower = status.toLowerCase().trim();
            
            // Map to "En ejecución" - including common variations from data
            if (statusLower.includes('ejecución') || statusLower === 'activo' || statusLower.includes('activo') ||
                statusLower.includes('proceso') || statusLower.includes('desarrollo') ||
                statusLower.includes('implementación') || statusLower.includes('iniciando') ||
                statusLower.includes('ejecución') || statusLower.includes('en ejecucion') ||
                statusLower.includes('en ejecución')) {
                return 'En ejecución';
            }
            
            // Map to "Terminado" 
            if (statusLower.includes('finalizando') || statusLower.includes('cierre') ||
                statusLower.includes('terminado') || statusLower.includes('finalizado') ||
                statusLower.includes('completado') || statusLower.includes('próximos al cierre') ||
                statusLower.includes('completado')) {
                return 'Terminado';
            }
            
            // Map to "En proyecto" - including planificado, preparacion, etc.
            if (statusLower.includes('proyecto') || statusLower.includes('planificado') ||
                statusLower.includes('preparación') || statusLower.includes('preparacion') ||
                statusLower.includes('iniciación') || statusLower.includes('iniciacion') ||
                statusLower.includes('diseño') || statusLower.includes('fase de iniciación') ||
                statusLower.includes('planificado')) {
                return 'En proyecto';
            }
            
            // Log unmapped statuses for debugging
            console.log('Unmapped status:', status);
            
            // Default to "En proyecto"
            return 'En proyecto';
        }

        function createSectorGrid() {
            const sectorGrid = document.getElementById('sectorGrid');
            
            humanitarianSectors.forEach(sector => {
                const sectorItem = document.createElement('div');
                sectorItem.className = 'sector-item';
                sectorItem.dataset.sector = sector.id;
                
                sectorItem.innerHTML = `
                    <div class="sector-icon" style="background-image: url('${sector.ochaIcon}');"></div>
                    <div class="sector-name">${sector.name}</div>
                `;
                
                sectorItem.addEventListener('click', () => toggleSectorFilter(sector.id));
                sectorGrid.appendChild(sectorItem);
            });
        }

        function toggleSectorFilter(sectorId) {
            const sectorItem = document.querySelector(`.sector-item[data-sector="${sectorId}"]`);
            
            if (currentFilters.sector === sectorId) {
                // Deselect current sector
                currentFilters.sector = '';
                sectorItem.classList.remove('active');
            } else {
                // Select new sector
                document.querySelectorAll('.sector-item.active').forEach(item => 
                    item.classList.remove('active')
                );
                currentFilters.sector = sectorId;
                sectorItem.classList.add('active');
            }
            
            applyFilters();
        }

        function matchesSector(project, sectorId) {
            if (!sectorId) return true;
            
            const sector = humanitarianSectors.find(s => s.id === sectorId);
            if (!sector) return false;

            const searchText = (
                (project['Área de intervención complementaria'] || '') + ' ' +
                (project['Actividad'] || '') + ' ' +
                (project['Nombre del proyecto'] || '')
            ).toLowerCase();

            // More precise sector matching with exact word boundaries
            return sector.keywords.some(keyword => {
                const keywordLower = keyword.toLowerCase();
                const regex = new RegExp('\\b' + keywordLower + '\\b', 'i');
                return regex.test(searchText);
            });
        }

        function setupEventListeners() {
            const orgFilter = document.getElementById('orgFilter');
            const estatusFilter = document.getElementById('estatusFilter');
            const searchInput = document.getElementById('searchInput');
            const resetFiltersBtn = document.getElementById('resetFilters');
            const dateStart = document.getElementById('dateStart');
            const dateEnd = document.getElementById('dateEnd');
            const modal = document.getElementById('detailModal');
            const modalClose = document.querySelector('.modal-close');

            // Filter event listeners
            [orgFilter, estatusFilter].forEach(filter =>
                filter.addEventListener('change', applyFilters)
            );

            searchInput.addEventListener('input', applyFilters);
            dateStart.addEventListener('change', applyFilters);
            dateEnd.addEventListener('change', applyFilters);

            // Date range slider functionality
            const dateRangeSlider = document.getElementById('dateRangeSlider');
            const sliderMinDate = document.getElementById('sliderMinDate');
            const sliderMaxDate = document.getElementById('sliderMaxDate');

            dateRangeSlider.addEventListener('input', function() {
                const days = parseInt(this.value);
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - days);

                dateStart.value = startDate.toISOString().split('T')[0];
                dateEnd.value = endDate.toISOString().split('T')[0];

                // Update slider labels
                if (days <= 7) {
                    sliderMinDate.textContent = 'Última semana';
                } else if (days <= 30) {
                    sliderMinDate.textContent = 'Último mes';
                } else if (days <= 90) {
                    sliderMinDate.textContent = 'Últimos 3 meses';
                } else if (days <= 180) {
                    sliderMinDate.textContent = 'Últimos 6 meses';
                } else {
                    sliderMinDate.textContent = 'Último año';
                }

                applyFilters();
            });

            // Re-apply filters when municipality filter changes to handle zoom

            // Reset filters
            resetFiltersBtn.addEventListener('click', () => {
                orgFilter.value = '';
                // Reset municipality multi-select
                const allCheckbox = document.getElementById('all-municipios');
                const municipioCheckboxes = document.querySelectorAll('#municipioDropdown input[type="checkbox"]:not(#all-municipios)');
                allCheckbox.checked = true;
                municipioCheckboxes.forEach(cb => cb.checked = false);
                updateMunicipioDisplay();
                estatusFilter.value = '';
                searchInput.value = '';
                dateStart.value = '';
                dateEnd.value = '';
                currentFilters = {
                    org: '', municipio: [], estatus: '', search: '',
                    sector: '', dateStart: '', dateEnd: '', parroquia: []
                };
                // Reset parish filter
                const parSection = document.getElementById('parroquiaFilterSection');
                if (parSection) parSection.classList.remove('visible');
                const allParroquias = document.getElementById('all-parroquias');
                if (allParroquias) {
                    allParroquias.checked = true;
                    allParroquias.indeterminate = false;
                    document.querySelectorAll('#parroquiaDropdown input[type="checkbox"]:not(#all-parroquias)')
                        .forEach(cb => { cb.checked = true; });
                }
                document.querySelectorAll('.sector-item.active').forEach(item =>
                    item.classList.remove('active')
                );
                applyFilters();
                map.setView(ZULIA_CENTER, 8); // Reset map view on filter reset
            });

            // Export functionality (only filtered exports since header buttons were removed)
            document.getElementById('exportFilteredExcel').addEventListener('click', () => exportToExcel(filteredData, 'proyectos_filtrados'));
            // PDF dropdown toggle
            const pdfToggleBtn = document.getElementById('exportPdfToggle');
            const pdfMenu = document.getElementById('pdfDropdownMenu');
            pdfToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = pdfMenu.style.display !== 'none';
                pdfMenu.style.display = isOpen ? 'none' : 'block';
            });
            document.addEventListener('click', () => { pdfMenu.style.display = 'none'; });
            document.getElementById('exportPdfShort').addEventListener('click', () => {
                pdfMenu.style.display = 'none';
                exportToPDF(filteredData, 'proyectos_municipios', 'short');
            });
            document.getElementById('exportPdfFull').addEventListener('click', () => {
                pdfMenu.style.display = 'none';
                exportToPDF(filteredData, 'proyectos_parroquias', 'full');
            });

            // Modal close
            modalClose.addEventListener('click', () => modal.classList.remove('active'));
            window.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('active');
            });
        }

        function applyFilters() {
            // Update filter values
            currentFilters.org = document.getElementById('orgFilter').value;
            currentFilters.municipio = getSelectedMunicipalities();
            currentFilters.estatus = document.getElementById('estatusFilter').value;
            currentFilters.search = document.getElementById('searchInput').value.toLowerCase();
            currentFilters.dateStart = document.getElementById('dateStart').value;
            currentFilters.dateEnd = document.getElementById('dateEnd').value;


            // Filter expanded data, respecting state filter
            let dataToFilter = expandedData;

            // First filter by state if not "Todos" (Todos means all states)
            if (currentState !== 'Todos') {
                dataToFilter = expandedData.filter(p => p['Estado'] === currentState);
            }

            // Then apply other filters
            filteredData = dataToFilter.filter(project => {
                // Organization filter - use normalized names
                if (currentFilters.org) {
                    const normalizedOrgLeader = normalizeOrganizationName(project['Organización Líder']);
                    if (normalizedOrgLeader !== currentFilters.org) {
                        return false;
                    }
                }

                // Municipality filter - exact match only to distinguish "Mara" from "Maracaibo"
                if (currentFilters.municipio && currentFilters.municipio.length > 0) {
                    const projectMunicipality = project['Municipio'];

                    // Check if project municipality matches any selected municipality
                    const hasMatch = currentFilters.municipio.some(filterMunicipio => {
                        // Exact match first
                        if (projectMunicipality === filterMunicipio) {
                            return true;
                        }
                        // Case-insensitive fallback
                        if (projectMunicipality && filterMunicipio &&
                            projectMunicipality.toLowerCase().trim() === filterMunicipio.toLowerCase().trim()) {
                            return true;
                        }
                        return false;
                    });

                    if (!hasMatch) {
                        return false;
                    }
                }

                // Parish filter - substring match on semicolon-separated Parroquias field
                currentFilters.parroquia = getSelectedParroquias();
                if (currentFilters.parroquia && currentFilters.parroquia.length > 0) {
                    const parroquiaText = (project['Parroquias'] || '').toLowerCase();
                    const hasParroquia = currentFilters.parroquia.some(p =>
                        parroquiaText.includes(p.toLowerCase())
                    );
                    if (!hasParroquia) return false;
                }

                // Status filter
                if (currentFilters.estatus && normalizeStatus(project['Estatus']) !== currentFilters.estatus) {
                    return false;
                }

                // Search filter - comprehensive and intelligent
                if (currentFilters.search) {
                    const searchableText = (
                        (project['Organización Líder'] || '') + ' ' +
                        (project['Organización implementadora'] || '') + ' ' +
                        (project['Nombre del proyecto'] || '') + ' ' +
                        (project['Área de intervención complementaria'] || '') + ' ' +
                        (project['Actividad'] || '') + ' ' +
                        (project['Municipio'] || '') + ' ' +
                        (project['Parroquias'] || '') + ' ' +
                        normalizeStatus(project['Estatus'] || '')
                    ).toLowerCase();
                    
                    // Split search terms and check if all terms are present
                    const searchTerms = currentFilters.search.split(/\s+/).filter(term => term.length > 0);
                    const allTermsMatch = searchTerms.every(term => 
                        searchableText.includes(term.toLowerCase())
                    );
                    
                    if (!allTermsMatch) {
                        return false;
                    }
                }

                // Sector filter - works with expanded areas
                if (currentFilters.sector) {
                    const areas = project._expandedAreas || [project['Área de intervención complementaria']];
                    const matchesAnySector = areas.some(area => {
                        if (!area) return false;
                        const sector = humanitarianSectors.find(s => s.id === currentFilters.sector);
                        if (!sector) return false;
                        return sector.keywords.some(keyword => {
                            const regex = new RegExp('\\b' + keyword + '\\b', 'i');
                            return regex.test(area.toLowerCase());
                        });
                    });
                    if (!matchesAnySector) return false;
                }

                // Date filters
                if (currentFilters.dateStart || currentFilters.dateEnd) {
                    const projectStart = new Date(project['Fecha de Inicio']);
                    const projectEnd = new Date(project['Fecha Prevista de Finalización']);
                    const filterStart = currentFilters.dateStart ? new Date(currentFilters.dateStart) : null;
                    const filterEnd = currentFilters.dateEnd ? new Date(currentFilters.dateEnd) : null;

                    if (filterStart && projectEnd < filterStart) return false;
                    if (filterEnd && projectStart > filterEnd) return false;
                }

                return true;
            });


            // Update components
            updateKPIs();
            updateTable();
            updateMapMarkers();
            updateCharts();
        }

        // Helper function to extract and normalize municipality names
        function extractAndNormalizeMunicipalities(municipioString) {
            if (!municipioString || typeof municipioString !== 'string') {
                return [];
            }

            // Official list of municipalities in Zulia (22) and Falcón (17)
            const officialMunicipalities = [
                // Zulia (22)
                'Almirante Padilla', 'Baralt', 'Cabimas', 'Catatumbo', 'Colón',
                'Francisco Javier Pulgar', 'Indígena Bolivariano Guajira',
                'Jesús Enrique Lossada', 'Jesús María Semprún', 'La Cañada de Urdaneta',
                'Lagunillas', 'Machiques de Perijá', 'Mara', 'Maracaibo', 'Miranda',
                'Páez', 'Rosario de Perijá', 'San Francisco', 'Santa Rita',
                'Simón Bolívar', 'Sucre', 'Valmore Rodríguez',
                // Falcón (17)
                'Acosta', 'Cacique Manaure', 'Carirubana', 'Colina', 'Democracia',
                'Falcón', 'Iturriza', 'Mauroa', 'Palmasola', 'Píritu',
                'Silva', 'Tocópero', 'Urumaco', 'Zamora'
            ];

            // Comprehensive mapping with variations
            const municipalityMapping = {
                'almirante padilla': 'Almirante Padilla',
                'baralt': 'Baralt',
                'cabimas': 'Cabimas',
                'catatumbo': 'Catatumbo',
                'colon': 'Colón',
                'colón': 'Colón',
                'francisco javier pulgar': 'Francisco Javier Pulgar',
                'indígena bolivariano guajira': 'Indígena Bolivariano Guajira',
                'indigena bolivariano guajira': 'Indígena Bolivariano Guajira',
                'guajira': 'Indígena Bolivariano Guajira',
                'jesus enrique lossada': 'Jesús Enrique Lossada',
                'jesús enrique lossada': 'Jesús Enrique Lossada',
                'jesus maría semprun': 'Jesús María Semprún',
                'jesús maría semprún': 'Jesús María Semprún',
                'jesus maría semprún': 'Jesús María Semprún',
                'jesus maria semprun': 'Jesús María Semprún',
                'la cañada de urdaneta': 'La Cañada de Urdaneta',
                'la canada de urdaneta': 'La Cañada de Urdaneta',
                'lagunillas': 'Lagunillas',
                'ciudad ojeda': 'Lagunillas',
                'machiques de perijá': 'Machiques de Perijá',
                'machiques de perija': 'Machiques de Perijá',
                'machiques': 'Machiques de Perijá',
                'mara': 'Mara',
                'maracaibo': 'Maracaibo',
                'miranda': 'Miranda',
                'paez': 'Páez',
                'páez': 'Páez',
                'rosario de perijá': 'Rosario de Perijá',
                'rosario de perija': 'Rosario de Perijá',
                'san francisco': 'San Francisco',
                'santa rita': 'Santa Rita',
                'simon bolivar': 'Simón Bolívar',
                'simón bolivar': 'Simón Bolívar',
                'sucre': 'Sucre',
                'valmore rodriguez': 'Valmore Rodríguez',
                'valmore rodríguez': 'Valmore Rodríguez',
                // Falcón municipalities
                'acosta': 'Acosta',
                'cacique manaure': 'Cacique Manaure',
                'carirubana': 'Carirubana',
                'colina': 'Colina',
                'democracia': 'Democracia',
                'falcón': 'Falcón',
                'falcon': 'Falcón',
                'iturriza': 'Iturriza',
                'mauroa': 'Mauroa',
                'palmasola': 'Palmasola',
                'píritu': 'Píritu',
                'piritu': 'Píritu',
                'silva': 'Silva',
                'tocópero': 'Tocópero',
                'tocopero': 'Tocópero',
                'urumaco': 'Urumaco',
                'zamora': 'Zamora'
            };

            // Split by semicolon and clean
            let municipalities = municipioString.split(';')
                .map(m => m.trim())
                .filter(m => m && m.length > 2); // Filter out very short strings

            // Normalize each municipality
            const normalized = [];
            const seen = new Set();

            municipalities.forEach(m => {
                let name = m.toLowerCase().trim();

                // Filter out invalid municipalities
                if (name === 'sin definir' || name === 'no especificado' || name === 'n/a' || name === 'nan') {
                    return; // Skip invalid municipalities
                }

                // Remove prefixes
                name = name.replace(/^municipio\s+/i, '');
                name = name.replace(/^bolivariano\s+/i, '');

                // Try to match with mapping
                const mapped = municipalityMapping[name];
                if (mapped && !seen.has(mapped)) {
                    normalized.push(mapped);
                    seen.add(mapped);
                } else if (!mapped) {
                    // Check if it's in the official list (case-insensitive)
                    const officialMatch = officialMunicipalities.find(
                        om => om.toLowerCase() === name
                    );
                    if (officialMatch && !seen.has(officialMatch)) {
                        normalized.push(officialMatch);
                        seen.add(officialMatch);
                    }
                }
            });

            return normalized;
        }

        // Helper function to normalize organization names
        function normalizeOrganizationName(orgName) {
            if (!orgName || typeof orgName !== 'string') {
                return null;
            }
            
            let name = orgName.trim();
            
            // Handle empty or invalid organization names
            if (name === '' || name.toLowerCase() === 'nan' || name === 'No especificado') {
                return null;
            }
            
            // Mapping based on CSV data analysis for common variations
            const organizationMapping = {
                // Leading organizations from CSV
                'A. C Concentroccidente': 'CONCENTROCCIDENTE',
                'ACEAM': 'ACEAM',
                'ACNUR': 'ACNUR',
                'ASONACOP': 'ASONACOP',
                'ASociacion civil ATRAVEZANDO': 'ATRAVEZANDO',
                'AZUL POSITIVO': 'AZUL POSITIVO',
                'Acción Campesina': 'ACCIÓN CAMPESINA',
                'Acción contra el Hambre': 'ACCIÓN CONTRA EL HAMBRE',
                'Asociacion civil ATRAVEZANDO': 'ATRAVEZANDO',
                'CARITAS VENEZUELA': 'CÁRITAS VENEZUELA',
                'CESVI': 'CESVI',
                'CIR': 'CIR',
                'CIR VENEZUELA': 'CIR',
                'CIR Venezuela': 'CIR',
                'Consejo Noruego para Refugiados': 'NRC',
                'DRC': 'DRC',
                'ECHO': 'ECHO',
                'ECHO- Caritas Suiza': 'ECHO-CÁRITAS SUIZA',
                'FAO': 'FAO',
                'FUDEP': 'FUDEP',
                'Funvape': 'FUNVAPE',
                'Grupo Social Cesap': 'CESAP',
                'HIAS VENEZUELA': 'HIAS',
                'HIAS-ALIADAS': 'HIAS-ALIADAS',
                'Malteser': 'MALTESER',
                'NRC': 'NRC',
                'Nuevo Amanecer': 'NUEVO AMANECER',
                'OIM': 'OIM',
                'PALUZ': 'PALUZ',
                'PALUZ-ALIADAS': 'PALUZ-ALIADAS',
                'Save The Children': 'SAVE THE CHILDREN',
                'Save the Children': 'SAVE THE CHILDREN',
                'Save the Children Venezuela': 'SAVE THE CHILDREN',
                'Servicio Jesuita a Refugiados; Venezuela': 'SJR VENEZUELA',
                'UNFPA': 'UNFPA',
                'UNICEF': 'UNICEF',
                'UNICEF 2021': 'UNICEF'
            };
            
            return organizationMapping[name] || name;
        }

        function updateKPIs() {
            const kpiContainer = document.getElementById('kpiContainer');
            
            // Real data limits based on CSV analysis (actual unique counts from data)
            const REAL_DATA_LIMITS = {
                projects: 99, // From CSV: total project entries
                leaders: 19, // From CSV: actual unique leading organizations  
                municipalities: 19, // From CSV: actual unique municipalities
                implementers: 48 // From CSV: actual unique implementing organizations
            };
            
            // Calculate unique projects by extracting base code (without correlativo suffix)
            // Example: PRJ002-1, PRJ002-2 → PRJ002 (counts as 1 unique project)
            // This handles the correlativo structure used to avoid unique constraint violations
            const uniqueFilteredProjects = new Set(
                filteredData
                    .map(p => {
                        const code = p['Código del proyecto'];
                        if (!code || code.trim() === '') return null;

                        // Extract base code by removing correlativo suffix (-1, -2, -3, etc.)
                        // Matches pattern like PRJ002-1 and extracts PRJ002
                        const baseCode = code.replace(/-\d+$/, '');
                        return baseCode;
                    })
                    .filter(code => code !== null)
            );
            const totalProjects = uniqueFilteredProjects.size;

            // Calculate unique leader organizations from filtered unique projects with normalization
            const filteredLeaderOrgs = new Set();
            // Get unique projects by base code (without correlativo)
            const uniqueProjectsArray = filteredData.filter(p => {
                const code = p['Código del proyecto'];
                const baseCode = code ? code.replace(/-\d+$/, '') : '';
                return baseCode && uniqueFilteredProjects.has(baseCode);
            });
            // Use a Map to get one project per unique base code
            const projectsByCode = new Map();
            uniqueProjectsArray.forEach(p => {
                const code = p['Código del proyecto'];
                const baseCode = code ? code.replace(/-\d+$/, '') : '';
                if (!projectsByCode.has(baseCode)) {
                    projectsByCode.set(baseCode, p);
                }
            });
            const uniqueProjectsList = Array.from(projectsByCode.values());

            uniqueProjectsList.forEach(p => {
                const leader = p['Organización Líder'];
                const normalizedLeader = normalizeOrganizationName(leader);
                if (normalizedLeader) {
                    filteredLeaderOrgs.add(normalizedLeader);
                }
            });
            const totalOrganizations = filteredLeaderOrgs.size;

            // Calculate unique municipalities from filtered data with proper normalization
            const filteredMunicipalities = new Set();
            filteredData.forEach(p => {
                const municipio = p['Municipio'];
                if (municipio && municipio !== 'N/A' && municipio.trim() !== '' && municipio !== 'No especificado') {
                    filteredMunicipalities.add(municipio);
                }
            });
            const totalMunicipalities = filteredMunicipalities.size;

            // Calculate unique parishes from filtered data
            const filteredParroquias = new Set();
            filteredData.forEach(p => {
                const parroquia = (p['Parroquias'] || '').trim();
                if (parroquia && parroquia !== 'Cobertura Municipal' && parroquia.toLowerCase() !== 'nan') {
                    filteredParroquias.add(parroquia);
                }
            });
            const totalParroquias = filteredParroquias.size;

            // Calculate implementing organizations from filtered unique projects with normalization
            const filteredImplementingOrgs = new Set();
            uniqueProjectsList.forEach(p => {
                const implOrg = p['Organización implementadora'];
                if (implOrg && implOrg !== 'N/A' && implOrg !== '' && implOrg !== null && implOrg.toLowerCase() !== 'nan') {
                    // Handle multiple organizations separated by semicolon
                    if (implOrg.includes(';')) {
                        implOrg.split(';').forEach(org => {
                            const normalizedOrg = normalizeOrganizationName(org.trim());
                            if (normalizedOrg) {
                                filteredImplementingOrgs.add(normalizedOrg);
                            }
                        });
                    } else {
                        const normalizedOrg = normalizeOrganizationName(implOrg.trim());
                        if (normalizedOrg) {
                            filteredImplementingOrgs.add(normalizedOrg);
                        }
                    }
                }
            });
            const totalImplementingOrgs = filteredImplementingOrgs.size;

            kpiContainer.innerHTML = `
                <div class="kpi-card">
                    <i class="fas fa-project-diagram kpi-icon"></i>
                    <div class="kpi-value">${totalProjects}</div>
                    <div class="kpi-label">Proyectos</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-users kpi-icon"></i>
                    <div class="kpi-value">${totalOrganizations}</div>
                    <div class="kpi-label">Org. Líderes</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-map-marked-alt kpi-icon"></i>
                    <div class="kpi-value">${totalMunicipalities}</div>
                    <div class="kpi-label">Municipios</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-map-pin kpi-icon"></i>
                    <div class="kpi-value">${totalParroquias}</div>
                    <div class="kpi-label">Parroquias</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-handshake kpi-icon"></i>
                    <div class="kpi-value">${totalImplementingOrgs}</div>
                    <div class="kpi-label">Org. Implementadoras</div>
                </div>
            `;
        }

        function updateTable() {
            const tableHeaders = document.getElementById('tableHeaders');
            const tableBody = document.getElementById('projectsTableBody');

            // Clear existing content
            tableHeaders.innerHTML = '';
            tableBody.innerHTML = '';

            // Define headers
            const headers = [
                { key: 'select', text: '', type: 'checkbox' },
                { key: 'org', text: 'Organización Líder', type: 'text' }, 
                { key: 'project', text: 'Nombre del proyecto', type: 'text' }, 
                { key: 'municipality', text: 'Municipio', type: 'text' },
                { key: 'parroquia', text: 'Parroquia', type: 'text' },
                { key: 'status', text: 'Estatus', type: 'text' },
                { key: 'startDate', text: 'Fecha Inicio', type: 'text' },
                { key: 'endDate', text: 'Fecha Fin', type: 'text' },
                { key: 'actions', text: 'Acciones', type: 'text' }
            ];

            // Create header row
            headers.forEach(header => {
                const th = document.createElement('th');
                if (header.type === 'checkbox') {
                    th.innerHTML = `
                        <input type="checkbox" id="selectAll" style="cursor: pointer;">
                        <label for="selectAll" style="cursor: pointer; margin-left: 5px;">Todos</label>
                    `;
                } else if (header.key === 'actions') {
                    th.textContent = header.text;
                } else {
                    th.className = 'sortable-header';
                    th.innerHTML = `${header.text}<span class="sort-indicator" data-sort="${header.key}"></span>`;
                    th.addEventListener('click', () => toggleSort(header.key));
                }
                tableHeaders.appendChild(th);
            });

            // Get unique projects from filtered expanded data for table display
            const uniqueFilteredProjects = new Map();
            filteredData.forEach(expandedProject => {
                if (expandedProject._originalIndex !== undefined) {
                    const originalProject = projectsData[expandedProject._originalIndex];
                    // Collect all municipalities that match the filter for this project
                    if (!uniqueFilteredProjects.has(expandedProject._originalIndex)) {
                        uniqueFilteredProjects.set(expandedProject._originalIndex, {
                            ...originalProject,
                            _matchedMunicipalities: []
                        });
                    }
                    uniqueFilteredProjects.get(expandedProject._originalIndex)._matchedMunicipalities.push(expandedProject['Municipio']);
                }
            });
            
            const uniqueProjectsArray = Array.from(uniqueFilteredProjects.values());
            
            // Create data rows
            if (uniqueProjectsArray.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = headers.length;
                cell.style.textAlign = 'center';
                cell.style.padding = '2rem';
                cell.style.color = '#666';
                cell.innerHTML = '<i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>No se encontraron proyectos que coincidan con los filtros aplicados.';
                return;
            }

            uniqueProjectsArray.forEach((project, index) => {
                const row = tableBody.insertRow();
                row.dataset.projectIndex = index;
                
                // Checkbox
                const checkboxCell = row.insertCell();
                checkboxCell.innerHTML = `<input type="checkbox" class="project-checkbox" data-index="${index}" style="cursor: pointer;">`;
                
                // Organization
                const orgCell = row.insertCell();
                orgCell.textContent = project['Organización Líder'] || 'N/A';
                
                // Project name
                const nameCell = row.insertCell();
                nameCell.textContent = project['Nombre del proyecto'] || 'N/A';
                nameCell.style.maxWidth = '300px';
                nameCell.title = project['Nombre del proyecto'] || 'N/A';
                
                // Municipality — single value from the record (no concatenation)
                const munCell = row.insertCell();
                const displayMunicipalities = project['Municipio'] || 'N/A';
                munCell.textContent = displayMunicipalities;
                munCell.title = displayMunicipalities;

                // Parroquia
                const parroquiaCell = row.insertCell();
                const parroquiaVal = project['Parroquias'] || '';
                parroquiaCell.textContent = parroquiaVal || '—';
                if (parroquiaVal) parroquiaCell.title = parroquiaVal;

                // Status
                const statusCell = row.insertCell();
                const status = normalizeStatus(project['Estatus']) || 'N/A';
                statusCell.innerHTML = `<span class="status-${status.toLowerCase().replace(/\s+/g, '-')}">${status}</span>`;
                
                // Start date
                const dateCell = row.insertCell();
                const startDate = project['Fecha de Inicio'];
                dateCell.textContent = startDate ? new Date(startDate).toLocaleDateString('es-ES') : 'N/A';
                
                // End date
                const endDateCell = row.insertCell();
                const endDate = project['Fecha Prevista de Finalización'];
                endDateCell.textContent = endDate ? new Date(endDate).toLocaleDateString('es-ES') : 'N/A';
                
                // Actions
                const actionsCell = row.insertCell();
                let projectIndex;
                if (project._originalIndex !== undefined) {
                    projectIndex = project._originalIndex;
                } else {
                    // Find the project in the original data
                    projectIndex = projectsData.findIndex(p => 
                        p['Nombre del proyecto'] === project['Nombre del proyecto'] && 
                        p['Organización Líder'] === project['Organización Líder']
                    );
                }
                actionsCell.innerHTML = `
                    <div class="actions-container">
                        <button class="action-btn primary" onclick="showProjectDetails(${projectIndex})" title="Ver detalles del proyecto">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        <button class="action-btn secondary" onclick="editProject(${projectIndex})" title="Editar proyecto">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="action-btn danger" onclick="deleteProject(${projectIndex})" title="Eliminar proyecto">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                `;
            });

            // Add checkbox functionality
            initializeCheckboxFunctionality();
        }

        function initializeCheckboxFunctionality() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const projectCheckboxes = document.querySelectorAll('.project-checkbox');

            // Select All functionality
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    projectCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateCheckboxState();
                });
            }

            // Individual checkbox functionality
            projectCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateCheckboxState();
                });
            });
        }

        function updateCheckboxState() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const projectCheckboxes = document.querySelectorAll('.project-checkbox');
            const checkedBoxes = document.querySelectorAll('.project-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const selectedCount = document.getElementById('selectedCount');

            if (selectAllCheckbox) {
                if (checkedBoxes.length === 0) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = false;
                } else if (checkedBoxes.length === projectCheckboxes.length) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.indeterminate = true;
                    selectAllCheckbox.checked = false;
                }
            }

            // Show/hide delete button based on selection
            if (deleteBtn) {
                if (checkedBoxes.length > 0) {
                    deleteBtn.style.display = 'inline-flex';
                    selectedCount.textContent = checkedBoxes.length;
                } else {
                    deleteBtn.style.display = 'none';
                }
            }
        }

        function getSelectedProjects() {
            const checkedBoxes = document.querySelectorAll('.project-checkbox:checked');
            return Array.from(checkedBoxes).map(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                return filteredData[index];
            });
        }

        // Sorting state
        let currentSort = { key: null, direction: null };

        function toggleSort(sortKey) {
            // Update sort state
            if (currentSort.key === sortKey) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = sortKey;
                currentSort.direction = 'asc';
            }

            // Sort filteredData
            filteredData.sort((a, b) => {
                let aValue, bValue;
                
                switch(sortKey) {
                    case 'org':
                        aValue = (a['Organización Líder'] || '').toLowerCase();
                        bValue = (b['Organización Líder'] || '').toLowerCase();
                        break;
                    case 'project':
                        aValue = (a['Nombre del proyecto'] || '').toLowerCase();
                        bValue = (b['Nombre del proyecto'] || '').toLowerCase();
                        break;
                    case 'municipality':
                        aValue = (a['Municipio'] || '').toLowerCase();
                        bValue = (b['Municipio'] || '').toLowerCase();
                        break;
                    case 'parroquia':
                        aValue = (a['Parroquias'] || '').toLowerCase();
                        bValue = (b['Parroquias'] || '').toLowerCase();
                        break;
                    case 'status':
                        aValue = normalizeStatus(a['Estatus']).toLowerCase();
                        bValue = normalizeStatus(b['Estatus']).toLowerCase();
                        break;
                    case 'startDate':
                        aValue = a['Fecha de Inicio'] ? new Date(a['Fecha de Inicio']) : new Date(0);
                        bValue = b['Fecha de Inicio'] ? new Date(b['Fecha de Inicio']) : new Date(0);
                        break;
                    case 'endDate':
                        aValue = a['Fecha Prevista de Finalización'] ? new Date(a['Fecha Prevista de Finalización']) : new Date(0);
                        bValue = b['Fecha Prevista de Finalización'] ? new Date(b['Fecha Prevista de Finalización']) : new Date(0);
                        break;
                    default:
                        return 0;
                }

                if (aValue < bValue) {
                    return currentSort.direction === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return currentSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });

            // Update sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.className = 'sort-indicator';
            });
            
            const currentIndicator = document.querySelector(`[data-sort="${sortKey}"]`);
            if (currentIndicator) {
                currentIndicator.className = `sort-indicator ${currentSort.direction}`;
            }

            // Re-render table
            updateTable();
        }

        // Enhanced action functions
        function exportProjectToCSV(projectIndex) {
            const project = filteredData[projectIndex];
            if (!project) return;

            const csvData = [
                ['Campo', 'Valor'],
                ['Organización Líder', project['Organización Líder'] || ''],
                ['Organización implementadora', project['Organización implementadora'] || ''],
                ['Nombre del proyecto', project['Nombre del proyecto'] || ''],
                ['Área de intervención', project['Área de intervención complementaria'] || ''],
                ['Actividad', project['Actividad'] || ''],
                ['Municipio', project['Municipio'] || ''],
                ['Parroquias', project['Parroquias'] || ''],
                ['Estatus', normalizeStatus(project['Estatus']) || ''],
                ['Fecha de Inicio', project['Fecha de Inicio'] || ''],
                ['Fecha de Finalización', project['Fecha Prevista de Finalización'] || '']
            ];

            const csvContent = csvData.map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `proyecto_${(project['Nombre del proyecto'] || 'sin_nombre').replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
            link.click();
        }

        function copyProjectLink(projectIndex) {
            const project = filteredData[projectIndex];
            if (!project) return;

            const projectId = projectsData.indexOf(project);
            const currentUrl = window.location.href.split('#')[0];
            const projectLink = `${currentUrl}#proyecto=${projectId}`;

            navigator.clipboard.writeText(projectLink).then(() => {
                // Show success message
                showToast('Enlace copiado al portapapeles', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = projectLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Enlace copiado al portapapeles', 'success');
            });
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? 'var(--ocha-green)' : 'var(--ocha-blue)'};
                color: white;
                border-radius: 6px;
                z-index: 10000;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Add CSS animations for toast
        const toastStyle = document.createElement('style');
        toastStyle.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(toastStyle);

        // Get GPS coordinates for a parish within a municipality
        // Returns [lat, lon] or null if not found
        function getParroquiaCoords(municipio, parroquia, estado) {
            if (!parroquia || parroquia.trim() === '' || parroquia === 'Cobertura Municipal') return null;
            const normalize = s => s.toLowerCase()
                .normalize('NFD').replace(/\p{M}/gu, '')
                .replace(/[^a-z0-9\s]/g, '').trim();
            const normParroquia = normalize(parroquia);

            const allStates = ['Zulia', 'Falcón', 'Lara', 'Trujillo'];
            const searchOrder = estado
                ? [estado, ...allStates.filter(s => s !== estado)]
                : allStates;

            for (const st of searchOrder) {
                const pList = PARROQUIAS_DATA[st]?.[municipio];
                if (pList) {
                    const match = pList.find(p => {
                        const normP = normalize(p.name);
                        return normP === normParroquia
                            || normP.includes(normParroquia)
                            || normParroquia.includes(normP);
                    });
                    if (match) return [match.lat, match.lon];
                }
            }
            return null;
        }

        function updateMapMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const activeCoords = getActiveCoordinates();

            // Group by GPS coordinates: one entry per unique location
            // Key: "lat,lon" — handles multiple projects at same parish GPS point
            const byCoords = {};

            filteredData.forEach(expandedProject => {
                const municipio = expandedProject['Municipio'];
                const parroquia = (expandedProject['Parroquias'] || '').trim();
                const originalIndex = expandedProject._originalIndex;
                if (!municipio || originalIndex === undefined) return;

                const estado = expandedProject['Estado'];
                const parroquiaCoords = getParroquiaCoords(municipio, parroquia, estado);
                // Use state-specific coords for fallback to avoid cross-state confusion
                const stateCoords = estado === 'Falcón' ? falconCoordinates
                    : estado === 'Lara' ? laraCoordinates
                    : estado === 'Trujillo' ? trujilloCoordinates
                    : zuliaCoordinates;
                const coords = parroquiaCoords || stateCoords[municipio] || activeCoords[municipio];
                if (!coords) {
                    console.warn(`No coordinates for: "${municipio}" / "${parroquia}"`);
                    return;
                }

                const key = coords[0].toFixed(5) + ',' + coords[1].toFixed(5);
                if (!byCoords[key]) {
                    byCoords[key] = {
                        coords,
                        projects: [],
                        seenIndices: new Set(),
                        parroquia,
                        municipio,
                        isParroquia: !!parroquiaCoords
                    };
                }

                // Avoid duplicating the same original project record
                if (!byCoords[key].seenIndices.has(originalIndex)) {
                    byCoords[key].seenIndices.add(originalIndex);
                    byCoords[key].projects.push({ ...projectsData[originalIndex], _idx: originalIndex });
                }
            });

            Object.values(byCoords).forEach(({ coords, projects, parroquia, municipio, isParroquia }) => {
                if (projects.length === 0) return;

                const markerSize = Math.min(Math.max(6 + projects.length * 2, 6), 20);

                // Determine primary status (most common)
                const statusCounts = {};
                projects.forEach(p => {
                    const st = p['Estatus'] || 'N/A';
                    statusCounts[st] = (statusCounts[st] || 0) + 1;
                });
                const primaryStatus = Object.keys(statusCounts).reduce((a, b) =>
                    statusCounts[a] > statusCounts[b] ? a : b);

                let color = '#005a8a';
                const normalizedStatus = normalizeStatus(primaryStatus);
                switch (normalizedStatus.toLowerCase()) {
                    case 'en ejecución': case 'en ejecucion': color = '#007DBC'; break;
                    case 'en proyecto':  color = '#ECA154'; break;
                    case 'terminado':    color = '#7DBA00'; break;
                    default:             color = '#5A5A5A'; break;
                }

                const marker = L.circleMarker(coords, {
                    radius: markerSize,
                    fillColor: color,
                    color: '#fff',
                    weight: isParroquia ? 2 : 1.5,
                    opacity: 1,
                    fillOpacity: isParroquia ? 0.85 : 0.65
                }).addTo(map);

                const locationLabel = (isParroquia && parroquia && parroquia !== 'Cobertura Municipal')
                    ? `${parroquia} <span style="font-weight:400;font-size:0.85em;">· ${municipio}</span>`
                    : municipio;

                const organizations = [...new Set(projects.map(p => p['Organización Líder']))];

                const popupContent = `
                    <div style="max-width: 300px;">
                        <h4 style="color: var(--ocha-blue); margin-bottom: 0.25rem;">${locationLabel}</h4>
                        <p style="margin: 0 0 0.5rem; font-size: 0.78rem; color: #888;">
                            ${isParroquia ? '📍 Parroquia' : '🏛 Municipio (sin coord. de parroquia)'}
                        </p>
                        <p style="margin: 0 0 0.4rem;"><strong>Proyectos:</strong> ${projects.length} &nbsp;|&nbsp; <strong>Orgs:</strong> ${organizations.length}</p>
                        ${projects.slice(0, 3).map(p => `
                            <div style="margin-top: 0.4rem; padding: 0.4rem 0.5rem; background: #f8f9fa; border-radius: 4px; font-size: 0.82rem;">
                                <div style="display: flex; align-items: center; gap: 0.4rem;">
                                    <i class="fas fa-circle" style="font-size: 0.55rem; color: ${getStatusColor(p['Estatus'])};"></i>
                                    <strong>${p['Nombre del proyecto'] || 'Sin nombre'}</strong>
                                </div>
                                <div style="color:#666;">${p['Organización Líder'] || 'N/A'}</div>
                                <button class="btn btn-primary btn-sm" style="margin-top: 0.3rem; font-size: 0.7rem; padding: 0.2rem 0.4rem;" onclick="showProjectDetails(${p._idx})">Ver Detalles</button>
                            </div>
                        `).join('')}
                        ${projects.length > 3 ? `<p style="margin-top: 0.4rem; font-size: 0.8rem; font-style: italic;">y ${projects.length - 3} más...</p>` : ''}
                    </div>
                `;

                marker.bindPopup(popupContent);
                markers.push(marker);
            });
        }

        function updateCharts() {
            updateSectorChart();
            updateTimeChart();
        }

        function updateSectorChart() {
            // Count unique projects by sector from filtered data
            const sectorCounts = {};
            const uniqueProjects = new Map();

            // Get unique projects from filtered expanded data — deduplicate by base project code
            // (same project can appear N times in projectsData, once per parroquia, e.g. "PRJ002-1", "PRJ002-2")
            filteredData.forEach(expandedProject => {
                if (expandedProject._originalIndex !== undefined) {
                    const project = projectsData[expandedProject._originalIndex];
                    const code = project['Código del proyecto'];
                    const baseCode = code ? code.replace(/-\d+$/, '') : String(expandedProject._originalIndex);
                    uniqueProjects.set(baseCode, project);
                }
            });
            
            // Count sectors from unique projects
            uniqueProjects.forEach(project => {
                const areas = project['Área de intervención complementaria'] || 'Sin clasificar';
                const areaList = areas.includes(';') ? areas.split(';').map(a => a.trim()) : [areas];
                
                areaList.forEach(area => {
                    // Try to match to humanitarian sectors
                    let matchedSector = null;
                    for (const sector of humanitarianSectors) {
                        if (sector.keywords.some(keyword => 
                            area.toLowerCase().includes(keyword.toLowerCase())
                        )) {
                            matchedSector = sector;
                            break;
                        }
                    }
                    
                    const sectorKey = matchedSector ? matchedSector.id : 'sin-clasificar';
                    if (!sectorCounts[sectorKey]) {
                        sectorCounts[sectorKey] = {
                            count: 0,
                            sector: matchedSector || { 
                                id: 'sin-clasificar', 
                                name: 'Sin clasificar', 
                                shortName: 'Sin Clasificar',
                                ochaIcon: null 
                            }
                        };
                    }
                    sectorCounts[sectorKey].count++;
                });
            });

            // Sort sectors by count and take top 8
            const sortedSectors = Object.values(sectorCounts)
                .sort((a, b) => b.count - a.count)
                .slice(0, 8);

            // Update chart with abbreviated sector names
            sectorChart.data.labels = sortedSectors.map(item => item.sector.shortName || 'N/A');
            sectorChart.data.datasets[0].data = sortedSectors.map(item => item.count);
            
            sectorChart.update();
        }

        function updateTimeChart() {
            // Count unique projects by normalized status - must match filter options exactly
            const statusCounts = {
                'En proyecto': 0,
                'En ejecución': 0,
                'Terminado': 0
            };
            
            const uniqueProjects = new Map();

            // Get unique projects from filtered expanded data — deduplicate by base project code
            filteredData.forEach(expandedProject => {
                if (expandedProject._originalIndex !== undefined) {
                    const project = projectsData[expandedProject._originalIndex];
                    const code = project['Código del proyecto'];
                    const baseCode = code ? code.replace(/-\d+$/, '') : String(expandedProject._originalIndex);
                    uniqueProjects.set(baseCode, project);
                }
            });

            // Count status from unique projects
            uniqueProjects.forEach(project => {
                const normalizedStatus = normalizeStatus(project['Estatus']);
                // Ensure we're using exact same values as filter dropdown
                if (statusCounts.hasOwnProperty(normalizedStatus)) {
                    statusCounts[normalizedStatus]++;
                } else {
                    // Log for debugging and default to En proyecto
                    console.warn('Unmapped status in chart:', project['Estatus'], 'normalized to:', normalizedStatus);
                    statusCounts['En proyecto']++;
                }
            });

            const totalProjects = uniqueProjects.size;
            const data = Object.values(statusCounts);
            
            // Calculate percentages for tooltips
            const percentages = data.map(count => totalProjects > 0 ? ((count / totalProjects) * 100).toFixed(1) : 0);

            // Update chart with percentages in tooltips
            timeChart.data.datasets[0].data = data;
            timeChart.options.plugins.tooltip.callbacks.label = function(context) {
                const label = context.label || '';
                const value = context.parsed;
                const percentage = percentages[context.dataIndex];
                return `${label}: ${value} proyectos (${percentage}%)`;
            };
            timeChart.update();
        }

        function showProjectDetails(index) {
            console.log('showProjectDetails called with index:', index);
            
            if (!projectsData || index >= projectsData.length || index < 0) {
                console.error('Invalid project index:', index);
                alert('Error: No se puede mostrar el detalle del proyecto');
                return;
            }
            
            const project = projectsData[index];
            const modal = document.getElementById('detailModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            if (!modal || !modalTitle || !modalBody) {
                console.error('Modal elements not found');
                return;
            }

            modalTitle.textContent = project['Nombre del proyecto'] || 'Proyecto sin nombre';

            // Find ALL matching sectors based on keywords in the intervention area
            const area = project['Área de intervención complementaria'] || '';
            const matchedSectors = [];
            for (const sector of humanitarianSectors) {
                if (sector.keywords.some(keyword =>
                    area.toLowerCase().includes(keyword.toLowerCase())
                )) {
                    matchedSectors.push(sector);
                }
            }

            modalBody.innerHTML = `
                <div class="modal-header-info">
                    ${matchedSectors.length > 0 ? `
                        <div class="modal-sector-badges">
                            ${matchedSectors.map(sector => `
                                <div class="modal-sector-badge" title="${sector.name}">
                                    <img src="${sector.ochaIcon}" alt="${sector.name}" width="24" height="24">
                                    <span>${sector.shortName}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="modal-status-badge">
                        <span class="status-${normalizeStatus(project['Estatus']).toLowerCase().replace(/\s+/g, '-')}">${normalizeStatus(project['Estatus']).charAt(0).toUpperCase() + normalizeStatus(project['Estatus']).slice(1) || 'No especificado'}</span>
                    </div>
                </div>
                
                <div class="modal-field-group">
                    <div class="modal-field">
                        <strong><i class="fas fa-building text-ocha"></i> Organización Líder</strong>
                        <span>${project['Organización Líder'] || 'No especificado'}</span>
                    </div>
                    <div class="modal-field">
                        <strong><i class="fas fa-handshake text-ocha"></i> Organización Implementadora</strong>
                        <span>${project['Organización implementadora'] || 'No especificado'}</span>
                    </div>
                </div>

                <div class="modal-field">
                    <strong><i class="fas fa-crosshairs text-ocha"></i> Área de Intervención</strong>
                    <span>${project['Área de intervención complementaria'] || 'No especificado'}</span>
                </div>

                <div class="modal-field-group">
                    <div class="modal-field">
                        <strong><i class="fas fa-map-marker-alt text-ocha"></i> Municipio</strong>
                        <span>${project['Municipio'] || 'No especificado'}</span>
                    </div>
                    <div class="modal-field">
                        <strong><i class="fas fa-map-pin text-ocha"></i> Parroquias</strong>
                        <span>${project['Parroquias'] || 'No especificado'}</span>
                    </div>
                </div>

                <div class="modal-field-group">
                    <div class="modal-field">
                        <strong><i class="fas fa-calendar-alt text-ocha"></i> Fecha de Inicio</strong>
                        <span>${project['Fecha de Inicio'] ? new Date(project['Fecha de Inicio']).toLocaleDateString('es-ES') : 'No especificado'}</span>
                    </div>
                    <div class="modal-field">
                        <strong><i class="fas fa-calendar-check text-ocha"></i> Fecha de Finalización</strong>
                        <span>${project['Fecha Prevista de Finalización'] ? new Date(project['Fecha Prevista de Finalización']).toLocaleDateString('es-ES') : 'No especificado'}</span>
                    </div>
                </div>

                <div class="modal-field modal-field-full">
                    <strong><i class="fas fa-tasks text-ocha"></i> Descripción de la Actividad</strong>
                    <div class="activity-description">${project['Actividad'] || 'No especificado'}</div>
                </div>
            `;

            modal.classList.add('active');
        }

        function exportToExcel(data, filename) {
            if (data.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            // Get unique projects from expanded data to avoid duplicates
            const uniqueProjects = [];
            const seenProjectIndices = new Set();
            
            data.forEach(expandedProject => {
                const originalIndex = expandedProject._originalIndex;
                if (originalIndex !== undefined && !seenProjectIndices.has(originalIndex)) {
                    seenProjectIndices.add(originalIndex);
                    uniqueProjects.push(projectsData[originalIndex]);
                }
            });

            // If no expanded data available, use data directly but ensure unique projects
            const uniqueData = uniqueProjects.length > 0 ? uniqueProjects : 
                data.filter((project, index, self) => 
                    index === self.findIndex(p => p['Nombre del proyecto'] === project['Nombre del proyecto'] && 
                                                 p['Organización Líder'] === project['Organización Líder'])
                );

            // Prepare data for export — each record has a single municipality and parish
            const exportData = uniqueData.map(project => ({
                'Organización Líder': normalizeOrganizationName(project['Organización Líder']) || '',
                'Organización Implementadora': normalizeOrganizationName(project['Organización implementadora']) || '',
                'Nombre del Proyecto': project['Nombre del proyecto'] || '',
                'Área de Intervención': project['Área de intervención complementaria'] || '',
                'Actividad': project['Actividad'] || '',
                'Municipio': project['Municipio'] || '',
                'Parroquia': project['Parroquias'] || '',
                'Estatus': normalizeStatus(project['Estatus']) || '',
                'Fecha de Inicio': project['Fecha de Inicio'] || '',
                'Fecha de Finalización': project['Fecha Prevista de Finalización'] || ''
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Proyectos');

            const now = new Date();
            const timestamp = now.toISOString().split('T')[0];
            XLSX.writeFile(wb, `${filename}_${timestamp}.xlsx`);
        }

        // mode: 'short' = agrupado por municipio (parroquias en una celda)
        //       'full'  = un registro por parroquia
        function exportToPDF(data, filename, mode) {
            mode = mode || 'short';
            if (data.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            // ── Build table rows based on mode ──────────────────────────────
            // Helper: sector abbreviations for a project
            function getSectorText(project) {
                const area = project['Área de intervención complementaria'] || '';
                const matched = humanitarianSectors
                    .filter(s => s.keywords.some(k => area.toLowerCase().includes(k.toLowerCase())))
                    .map(s => s.shortName);
                return matched.length > 0 ? matched.join(', ') : (area ? area.substring(0, 20) : 'N/A');
            }

            function fmtDate(d) {
                if (!d) return '';
                try { return new Date(d).toLocaleDateString('es-ES'); } catch(e) { return d; }
            }

            let tableRows = [];
            let tableHead = [];

            if (mode === 'full') {
                // ── FULL MODE: one row per parish record ───────────────────
                tableHead = [['Sectores', 'Org. Líder', 'Org. Impl.', 'Proyecto', 'Municipio', 'Parroquia', 'Estatus', 'F. Inicio', 'F. Fin']];

                const seen = new Set();
                data.forEach(ep => {
                    const idx = ep._originalIndex;
                    if (idx === undefined) return;
                    const p = projectsData[idx];
                    if (seen.has(idx)) return;
                    seen.add(idx);

                    tableRows.push([
                        getSectorText(p),
                        normalizeOrganizationName(p['Organización Líder']) || '',
                        normalizeOrganizationName(p['Organización implementadora']) || '—',
                        p['Nombre del proyecto'] || '',
                        p['Municipio'] || '',
                        (p['Parroquias'] || '').trim() || '—',
                        normalizeStatus(p['Estatus']) || '',
                        fmtDate(p['Fecha de Inicio']),
                        fmtDate(p['Fecha Prevista de Finalización'])
                    ]);
                });
            } else {
                // ── SHORT MODE: group by (Código + Municipio), list parishes ─
                tableHead = [['Sectores', 'Org. Líder', 'Org. Impl.', 'Proyecto', 'Municipio', 'Parroquias', 'Estatus', 'F. Inicio', 'F. Fin']];

                const groups = new Map();
                data.forEach(ep => {
                    const idx = ep._originalIndex;
                    if (idx === undefined) return;
                    const p = projectsData[idx];
                    const key = (p['Código del proyecto'] || '') + '||' + (p['Municipio'] || '');
                    if (!groups.has(key)) {
                        groups.set(key, { base: p, parishes: [] });
                    }
                    const parroquia = (p['Parroquias'] || '').trim();
                    if (parroquia && parroquia !== '—' && !groups.get(key).parishes.includes(parroquia)) {
                        groups.get(key).parishes.push(parroquia);
                    }
                });

                groups.forEach(({ base, parishes }) => {
                    const parroquiasText = parishes.length > 0
                        ? parishes.join(', ')
                        : (base['Parroquias'] || '—');
                    tableRows.push([
                        getSectorText(base),
                        normalizeOrganizationName(base['Organización Líder']) || '',
                        normalizeOrganizationName(base['Organización implementadora']) || '—',
                        base['Nombre del proyecto'] || '',
                        base['Municipio'] || '',
                        parroquiasText,
                        normalizeStatus(base['Estatus']) || '',
                        fmtDate(base['Fecha de Inicio']),
                        fmtDate(base['Fecha Prevista de Finalización'])
                    ]);
                });
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

            const modeLabel = mode === 'full' ? 'Vista por Parroquias' : 'Vista por Municipios';

            // ── PDF Header ──────────────────────────────────────────────────
            const stateNames = {
                'Zulia': 'Zulia', 'Falcón': 'Falcón',
                'Lara': 'Lara', 'Trujillo': 'Trujillo',
                'Todos': 'Zulia, Falcón, Lara y Trujillo'
            };
            const selectedState = stateNames[currentState] || 'Zulia, Falcón, Lara y Trujillo';
            const municipios = getSelectedMunicipalities();

            let mainTitle = 'Registro de Proyectos Humanitarios';
            if (municipios.length === 1) {
                mainTitle += ` — Municipio ${municipios[0]}`;
            } else if (municipios.length > 1) {
                mainTitle += ` — ${municipios.length} Municipios`;
            } else {
                mainTitle += ` — ${selectedState}`;
            }

            doc.setFontSize(15);
            doc.setTextColor(0, 93, 146);
            doc.text(mainTitle, 15, 14);

            // Mode label (right-aligned)
            doc.setFontSize(8);
            doc.setTextColor(mode === 'full' ? 0 : 80, mode === 'full' ? 120 : 80, mode === 'full' ? 0 : 80);
            const pageW = doc.internal.pageSize.getWidth();
            doc.text(modeLabel, pageW - 6, 14, { align: 'right' });

            doc.setFontSize(10);
            doc.setTextColor(90, 90, 90);
            doc.text('Sub Oficina OCHA Maracaibo', 15, 21);

            // Filters summary
            const activeFilters = [];
            if (currentFilters.org) activeFilters.push(`Organización: ${currentFilters.org}`);
            if (currentFilters.municipio && currentFilters.municipio.length > 0) {
                activeFilters.push(currentFilters.municipio.length === 1
                    ? `Municipio: ${currentFilters.municipio[0]}`
                    : `Municipios (${currentFilters.municipio.length}): ${currentFilters.municipio.join(', ')}`);
            }
            if (currentFilters.parroquia && currentFilters.parroquia.length > 0) {
                activeFilters.push(`Parroquias: ${currentFilters.parroquia.join(', ')}`);
            }
            if (currentFilters.estatus) activeFilters.push(`Estatus: ${currentFilters.estatus}`);
            if (currentFilters.dateStart || currentFilters.dateEnd) {
                activeFilters.push(`Período: ${currentFilters.dateStart || 'N/A'} — ${currentFilters.dateEnd || 'N/A'}`);
            }

            let headerEndY = 24;
            if (activeFilters.length > 0) {
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                let yPos = 27;
                activeFilters.forEach(f => { doc.text(`• ${f}`, 15, yPos); yPos += 4; });
                headerEndY = yPos;
                doc.setTextColor(0, 0, 0);
            }

            // Record count
            doc.setFontSize(7.5);
            doc.setTextColor(60, 60, 60);
            doc.text(`Total registros: ${tableRows.length}`, 15, headerEndY + 3);

            // ── Column widths — 9 columns: Sectores|OrgLíder|OrgImpl|Proyecto|Municipio|Parroquia(s)|Estatus|F.Ini|F.Fin
            const pageWidth = doc.internal.pageSize.getWidth();
            const usableWidth = pageWidth - 12;
            const columnRatio = mode === 'full'
                ? [14, 18, 18, 48, 20, 24, 13, 12, 12]   // full: parroquia=24
                : [14, 18, 18, 44, 20, 36, 13, 12, 12];   // short: parroquias=36 (lista)
            const ratioSum = columnRatio.reduce((a, b) => a + b, 0);
            const columnWidths = columnRatio.map(r => (r / ratioSum) * usableWidth);

            doc.autoTable({
                head: tableHead,
                body: tableRows,
                startY: headerEndY + 6,
                styles: {
                    fontSize: 7,
                    cellPadding: 1.8,
                    overflow: 'linebreak',
                    cellWidth: 'wrap',
                    valign: 'middle',
                    halign: 'left',
                    lineColor: [220, 220, 220],
                    lineWidth: 0.1,
                    minCellHeight: 8
                },
                columnStyles: {
                    0: { cellWidth: columnWidths[0], fontSize: 6.5, halign: 'center' }, // Sectores
                    1: { cellWidth: columnWidths[1], fontStyle: 'bold', fontSize: 6.5 }, // Org. Líder
                    2: { cellWidth: columnWidths[2], fontSize: 6.5 },                   // Org. Impl.
                    3: { cellWidth: columnWidths[3] },                                   // Proyecto
                    4: { cellWidth: columnWidths[4] },                                   // Municipio
                    5: { cellWidth: columnWidths[5], fontSize: 6.5 },                   // Parroquia/Parroquias
                    6: { cellWidth: columnWidths[6], halign: 'center', fontSize: 6.5 }, // Estatus
                    7: { cellWidth: columnWidths[7], halign: 'center', fontSize: 6 },   // Fecha Inicio
                    8: { cellWidth: columnWidths[8], halign: 'center', fontSize: 6 }    // Fecha Fin
                },
                headStyles: {
                    fillColor: [0, 93, 146],
                    textColor: [255, 255, 255],
                    fontSize: 7.5,
                    fontStyle: 'bold',
                    halign: 'center',
                    valign: 'middle',
                    cellPadding: 2.2
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                },
                rowPageBreak: 'avoid',
                margin: { left: 6, right: 6, top: 10, bottom: 12 },
                tableWidth: usableWidth,
                didDrawPage: function(data) {
                    // Add page number footer
                    const pageCount = doc.internal.getNumberOfPages();
                    const pageSize = doc.internal.pageSize;
                    const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                    const pageWidth = pageSize.width ? pageSize.width : pageSize.getWidth();

                    doc.setFontSize(7);
                    doc.setTextColor(150);

                    // Page info
                    doc.text(
                        `Página ${data.pageNumber} de ${pageCount}`,
                        6,
                        pageHeight - 8
                    );

                    // Generation date and time
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('es-ES');
                    const timeStr = now.toLocaleTimeString('es-ES');
                    doc.text(
                        `Generado: ${dateStr} ${timeStr}`,
                        pageWidth - 60,
                        pageHeight - 8
                    );
                }
            });

            const now = new Date();
            const timestamp = now.toISOString().split('T')[0];
            doc.save(`${filename}_${timestamp}.pdf`);
        }

        function updateFooterInfo() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleDateString('es-ES') + ' ' + now.toLocaleTimeString('es-ES');
            document.getElementById('totalRecords').textContent = projectsData.length;
        }

        // Helper to get status color for map popups
        function getStatusColor(status) {
            switch (status?.toLowerCase()) {
                case 'activo': return '#7DBA00'; // Green
                case 'en desarrollo': return '#ECA154'; // Orange
                case 'completado': return '#007DBC'; // Blue
                case 'suspendido': return '#CD3A1F'; // Red
                default: return '#5A5A5A'; // Gray
            }
        }

        // Utility functions for footer links
        function showAbout() {
            alert('Proyectos Humanitarios en Zulia\n\nSistema desarrollado para facilitar el seguimiento y coordinación de proyectos humanitarios en los estados de cobertura de la Sub Oficina OCHA Maracaibo (Zulia, Falcón, Lara y Trujillo).');
        }

        function showHelp() {
            alert('Ayuda del Sistema\n\n1. Use los filtros del panel izquierdo para refinar los datos\n2. Haga clic en los sectores humanitarios para filtrar por área\n3. Use el filtro de fechas para ver proyectos en períodos específicos\n4. Haga clic en los marcadores del mapa para ver detalles\n5. Use los botones de exportación para descargar los datos');
        }

        function showContact() {
            document.getElementById('contactModal').classList.add('active');
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
        }

        // Global function to make it accessible from popup buttons
        window.showProjectDetails = showProjectDetails;

        // ========== NEW FUNCTIONALITY: ADD/EDIT PROJECTS AND IMPORT EXCEL ==========

        let editingProjectIndex = -1;
        let editingOriginalCode = '';
        let editingOriginalMunicipio = '';
        let importMode = null;

        // Function to update municipalities dropdown based on selected state
        function updateMunicipalitiesInForm(state) {
            const municipioSelect = document.getElementById('formMunicipio');
            const municipalities = getOfficialMunicipalities(state);

            // Clear existing options
            municipioSelect.innerHTML = '<option value="">Seleccionar Municipio...</option>';

            // Add municipalities as options
            municipalities.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio;
                option.textContent = municipio;
                municipioSelect.appendChild(option);
            });
        }

        // Function to detect which state a municipality belongs to
        function detectStateFromMunicipality(municipio) {
            if (!municipio) return 'Zulia'; // Default to Zulia

            const zuliaList = getOfficialMunicipalities('Zulia');
            const falconList = getOfficialMunicipalities('Falcón');
            const laraList = getOfficialMunicipalities('Lara');
            const trujilloList = getOfficialMunicipalities('Trujillo');

            if (zuliaList.includes(municipio)) return 'Zulia';
            if (falconList.includes(municipio)) return 'Falcón';
            if (laraList.includes(municipio)) return 'Lara';
            if (trujilloList.includes(municipio)) return 'Trujillo';

            return 'Zulia'; // Default fallback
        }

        // Setup event listener for state dropdown in form
        function setupFormStateListener() {
            const stateSelect = document.getElementById('formEstado');
            const municipioSelect = document.getElementById('formMunicipio');
            if (stateSelect) {
                stateSelect.addEventListener('change', (e) => {
                    updateMunicipalitiesInForm(e.target.value);
                    // Reset municipality and parish selection when state changes
                    if (municipioSelect) municipioSelect.value = '';
                    updateFormParroquias('', e.target.value);
                });
            }
            if (municipioSelect) {
                municipioSelect.addEventListener('change', (e) => {
                    const estado = stateSelect ? stateSelect.value : '';
                    updateFormParroquias(e.target.value, estado);
                });
            }
        }

        // Function to open add project modal
        function openAddProjectModal() {
            editingProjectIndex = -1;
            editingOriginalCode = '';
            editingOriginalMunicipio = '';
            document.getElementById('editModalTitle').textContent = 'Agregar Proyecto';
            document.getElementById('projectForm').reset();

            // Initialize state dropdown with Zulia as default
            const stateSelect = document.getElementById('formEstado');
            stateSelect.value = 'Zulia';
            updateMunicipalitiesInForm('Zulia');

            // Reset parish field to empty state
            updateFormParroquias('', 'Zulia');

            // Initialize sector multi-select (all unchecked)
            initFormSectores();

            // Setup event listener for state changes (includes municipio → parish update)
            setupFormStateListener();

            document.getElementById('editProjectModal').classList.add('active');
        }

        // Function to edit existing project
        function editProject(index) {
            if (!projectsData || index >= projectsData.length || index < 0) {
                console.error('Invalid project index:', index);
                alert('Error: No se puede editar el proyecto');
                return;
            }

            editingProjectIndex = index;
            const project = projectsData[index];

            // Store original key for delete-before-upsert on save
            editingOriginalCode = project['Código del proyecto'] || '';
            editingOriginalMunicipio = project['Municipio'] || '';

            document.getElementById('editModalTitle').textContent = 'Editar Proyecto';
            document.getElementById('formCodigo').value = project['Código del proyecto'] || '';
            document.getElementById('formNombre').value = project['Nombre del proyecto'] || '';
            document.getElementById('formOrgLider').value = project['Organización Líder'] || '';
            document.getElementById('formOrgImpl').value = project['Organización implementadora'] || '';

            // Initialize sector multi-select and pre-check saved sectors
            initFormSectores();
            const savedArea = project['Área de intervención complementaria'] || '';
            document.getElementById('formArea').value = savedArea;
            document.getElementById('formSector').value = savedArea.split(';')[0].trim();
            document.querySelectorAll('.form-sector-check').forEach(cb => {
                const sector = humanitarianSectors.find(s => s.name === cb.value);
                cb.checked = sector
                    ? sector.keywords.some(k => savedArea.toLowerCase().includes(k.toLowerCase()))
                    : savedArea.includes(cb.value);
            });

            // Determine state from municipality
            const municipio = project['Municipio'] || '';
            const state = detectStateFromMunicipality(municipio);
            const stateSelect = document.getElementById('formEstado');
            stateSelect.value = state;

            // Update municipalities dropdown based on detected state
            updateMunicipalitiesInForm(state);

            // Set municipality value
            document.getElementById('formMunicipio').value = municipio;

            // Populate parish multi-select for this municipality
            const savedParroquias = project['Parroquias'] || '';
            updateFormParroquias(municipio, state);
            // Restore saved parish selection after the DOM is built (single-select radio)
            setTimeout(() => {
                const savedVal = savedParroquias.trim();
                if (savedVal) {
                    const container = document.getElementById('formParroquiasContainer');
                    if (container) {
                        const radios = container.querySelectorAll('.form-parroquia-radio');
                        if (radios.length > 0) {
                            // Try exact match first, then case-insensitive
                            let matched = Array.from(radios).find(r => r.value === savedVal);
                            if (!matched) matched = Array.from(radios).find(r =>
                                r.value.toLowerCase() === savedVal.toLowerCase());
                            if (matched) {
                                matched.checked = true;
                                const hidden = document.getElementById('formParroquias');
                                if (hidden) hidden.value = matched.value;
                            }
                        } else {
                            const textInput = document.getElementById('formParroquias');
                            if (textInput) textInput.value = savedVal;
                        }
                    }
                }
            }, 50);

            document.getElementById('formEstatus').value = normalizeStatus(project['Estatus']) || '';
            document.getElementById('formFechaInicio').value = project['Fecha de Inicio'] || '';
            document.getElementById('formFechaFin').value = project['Fecha Prevista de Finalización'] || '';
            document.getElementById('formActividad').value = project['Actividad'] || '';

            // Setup event listener for state changes (includes municipio → parish update)
            setupFormStateListener();

            document.getElementById('editProjectModal').classList.add('active');
        }

        // Function to close edit modal
        function closeEditModal() {
            document.getElementById('editProjectModal').classList.remove('active');
            document.getElementById('projectForm').reset();
            editingProjectIndex = -1;
            editingOriginalCode = '';
            editingOriginalMunicipio = '';
        }

        // Variable to store the project index for deletion
        let projectToDeleteIndex = -1;

        // Function to delete project (show confirmation)
        function deleteProject(index) {
            if (!projectsData || index >= projectsData.length || index < 0) {
                console.error('Invalid project index:', index);
                alert('Error: No se puede eliminar el proyecto');
                return;
            }
            projectToDeleteIndex = index;
            document.getElementById('deleteModal').classList.add('active');
        }

        // Function to close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            projectToDeleteIndex = -1;
        }

        // Function to confirm and execute deletion
        async function confirmDeleteProject() {
            if (projectToDeleteIndex < 0) {
                alert('Error: Proyecto no encontrado');
                return;
            }

            const project = projectsData[projectToDeleteIndex];
            const projectCode = project['Código del proyecto'];

            try {
                // Delete from Supabase
                const { error } = await supabaseClient
                    .from('proyectos')
                    .delete()
                    .eq('Código del proyecto', projectCode);

                if (error) {
                    console.error('Supabase delete error:', error);
                    alert('Error al eliminar en Supabase: ' + error.message);
                    return;
                }

                // Remove from local data
                projectsData.splice(projectToDeleteIndex, 1);

                // Update UI
                expandedData = expandProjectData(projectsData);
                applyFilters();
                updateTable();
                updateMapMarkers();
                initializeCharts();

                alert('✓ Proyecto eliminado exitosamente de Supabase');
                closeDeleteModal();
            } catch (e) {
                console.error('Delete error:', e);
                alert('Error al eliminar el proyecto: ' + e.message);
            }
        }

        // Function to delete multiple selected projects
        async function deleteSelectedProjects() {
            const checkedBoxes = document.querySelectorAll('.project-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('Por favor, selecciona al menos un proyecto para eliminar');
                return;
            }

            const confirmDelete = confirm(
                `¿Está seguro de que desea eliminar ${checkedBoxes.length} proyectos seleccionados?\n\nEsta acción no se puede deshacer.`
            );

            if (!confirmDelete) return;

            try {
                let deleted = 0;
                let failed = 0;

                for (const checkbox of checkedBoxes) {
                    const index = parseInt(checkbox.dataset.index);
                    const project = projectsData[index];
                    const projectCode = project['Código del proyecto'];

                    try {
                        const { error } = await supabaseClient
                            .from('proyectos')
                            .delete()
                            .eq('Código del proyecto', projectCode);

                        if (error) {
                            console.error('Error deleting:', projectCode, error);
                            failed++;
                        } else {
                            deleted++;
                        }
                    } catch (e) {
                        console.error('Error deleting:', e);
                        failed++;
                    }
                }

                // Remove deleted projects from local data
                const indicesToRemove = Array.from(checkedBoxes)
                    .map(cb => parseInt(cb.dataset.index))
                    .sort((a, b) => b - a);

                indicesToRemove.forEach(index => {
                    projectsData.splice(index, 1);
                });

                // Update UI
                expandedData = expandProjectData(projectsData);
                applyFilters();
                updateTable();
                updateMapMarkers();
                initializeCharts();

                let message = `✓ Se eliminaron ${deleted} proyecto(s)`;
                if (failed > 0) {
                    message += ` (${failed} fallaron)`;
                }
                alert(message);

            } catch (e) {
                console.error('Bulk delete error:', e);
                alert('Error al eliminar proyectos: ' + e.message);
            }
        }

        // Function to handle form submission (async — saves to Supabase, one record per parish)
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validate Código del proyecto format (Supabase constraint: ^[A-Z0-9\-]{1,30}$)
            const formCodigo = document.getElementById('formCodigo').value.trim();
            const codigoPattern = /^[A-Z0-9\-]{1,30}$/;
            if (formCodigo && !codigoPattern.test(formCodigo)) {
                alert('El Código del proyecto debe contener solo MAYÚSCULAS, números y guiones (máx. 30 caracteres).\nEjemplo válido: ZUL-2025-001');
                document.getElementById('formCodigo').focus();
                return;
            }

            // Validate at least one sector is selected
            const selectedSectors = Array.from(
                document.querySelectorAll('.form-sector-check:checked')
            ).map(cb => cb.value);
            const fullArea = selectedSectors.length > 0
                ? selectedSectors.join('; ')
                : (document.getElementById('formArea').value.trim() || '');

            const municipio = document.getElementById('formMunicipio').value.trim();
            // Single parish value (radio button — one record per parish)
            const parroquiaVal = document.getElementById('formParroquias').value.trim();

            const recordsToSave = [{
                'Código del proyecto': formCodigo,
                'Nombre del proyecto': document.getElementById('formNombre').value.trim(),
                'Organización Líder': document.getElementById('formOrgLider').value.trim(),
                'Organización implementadora': document.getElementById('formOrgImpl').value.trim(),
                'Área de intervención complementaria': fullArea,
                'Estado': document.getElementById('formEstado').value,
                'Municipio': municipio,
                'Parroquias': parroquiaVal,
                'Estatus': document.getElementById('formEstatus').value,
                'Fecha de Inicio': document.getElementById('formFechaInicio').value,
                'Fecha Prevista de Finalización': document.getElementById('formFechaFin').value,
                'Actividad': document.getElementById('formActividad').value.trim()
            }];

            try {
                // If editing: delete all previous records for this project+municipality
                // (handles parish changes and municipality changes)
                if (editingProjectIndex >= 0 && editingOriginalCode) {
                    const { error: delError } = await supabaseClient
                        .from('proyectos')
                        .delete()
                        .eq('Código del proyecto', editingOriginalCode)
                        .eq('Municipio', editingOriginalMunicipio);
                    if (delError) {
                        console.warn('Delete old records warning:', delError.message);
                    }
                }

                // Upsert new records (one per parish)
                const saved = await insertProjectsToSupabase(recordsToSave);
                if (saved) {
                    const action = editingProjectIndex >= 0 ? 'actualizado' : 'guardado';
                    alert(`✓ Proyecto ${action} exitosamente.`);
                    await reloadDataFromSupabase();
                } else {
                    // Fallback: save only to local array
                    if (editingProjectIndex >= 0) {
                        projectsData[editingProjectIndex] = recordsToSave[0];
                    } else {
                        recordsToSave.forEach(r => projectsData.push(r));
                    }
                    expandedData = expandProjectData(projectsData);
                    applyFilters();
                    updateTable();
                    updateMapMarkers();
                    initializeCharts();
                }
            } catch (err) {
                console.error('Form save error:', err);
                alert('Error al guardar: ' + err.message);
            }

            closeEditModal();
        });

        // Function to open import modal
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        // Function to close import modal
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            importMode = null;
        }

        // Function to handle import option selection
        function handleImport(mode) {
            importMode = mode;
            closeImportModal();
            document.getElementById('excelFileInput').click();
        }

        // Function to process JSON file
        document.getElementById('jsonFileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);

                    if (!Array.isArray(jsonData)) {
                        alert('El archivo JSON debe contener un array de proyectos');
                        return;
                    }

                    if (jsonData.length === 0) {
                        alert('El archivo JSON está vacío');
                        return;
                    }

                    // Validate that JSON has the required fields
                    const requiredFields = ['Código del proyecto', 'Nombre del proyecto', 'Organización Líder'];
                    const firstRow = jsonData[0];
                    const hasRequiredFields = requiredFields.every(field => field in firstRow);

                    if (!hasRequiredFields) {
                        alert('El archivo JSON no tiene los campos requeridos. Debe incluir: ' + requiredFields.join(', '));
                        return;
                    }

                    // Insert to Supabase
                    const inserted = await insertProjectsToSupabase(jsonData);

                    if (inserted) {
                        alert(`✓ Datos cargados exitosamente en Supabase. Se importaron ${jsonData.length} proyectos desde JSON.`);
                        // Reload from Supabase to sync
                        await reloadDataFromSupabase();
                    } else {
                        alert('⚠️ Error al guardar en Supabase. Intenta de nuevo.');
                    }

                } catch (error) {
                    console.error('Error al procesar el archivo JSON:', error);
                    alert('Error al procesar el archivo JSON. Por favor, verifica que el archivo tenga un formato JSON válido.');
                }
            };

            reader.readAsText(file);

            // Reset file input
            e.target.value = '';
        });

        // Expand rows that have multiple parishes separated by ";" into individual rows
        function expandRowsByParroquia(rows) {
            const expanded = [];
            rows.forEach(row => {
                const raw = (row['Parroquias'] || '').toString().trim();
                const parts = raw.split(';').map(p => p.trim()).filter(Boolean);
                if (parts.length <= 1) {
                    expanded.push(row);
                } else {
                    parts.forEach(p => expanded.push({ ...row, 'Parroquias': p }));
                }
            });
            return expanded;
        }

        // Function to process Excel file
        document.getElementById('excelFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        alert('El archivo Excel está vacío o no tiene el formato correcto');
                        return;
                    }

                    // Validate that the Excel has the required columns
                    const requiredColumns = ['Código del proyecto', 'Nombre del proyecto', 'Organización Líder'];
                    const firstRow = jsonData[0];
                    const hasRequiredColumns = requiredColumns.every(col => col in firstRow);

                    if (!hasRequiredColumns) {
                        alert('El archivo Excel no tiene las columnas requeridas. Debe incluir: ' + requiredColumns.join(', '));
                        return;
                    }

                    // Expand rows with multiple parishes (;-separated) into individual rows
                    const expandedRows = expandRowsByParroquia(jsonData);
                    const originalCount = jsonData.length;
                    const expandedCount = expandedRows.length;

                    // Upsert to Supabase (inserts new, updates existing by composite key)
                    const inserted = await insertProjectsToSupabase(expandedRows);

                    if (inserted) {
                        const expandNote = expandedCount > originalCount
                            ? ` (${originalCount} filas expandidas a ${expandedCount} registros por parroquia)`
                            : '';
                        if (importMode === 'replace') {
                            alert(`✓ Datos importados. ${expandedCount} registros procesados${expandNote}.`);
                        } else if (importMode === 'merge') {
                            alert(`✓ Merge completado. ${expandedCount} registros procesados (insertados o actualizados)${expandNote}.`);
                        }

                        // Reload from Supabase to sync
                        await reloadDataFromSupabase();
                    } else {
                        alert('⚠️ Error al guardar en Supabase. Verifica el SQL del constraint único (ver CONTEXT.md).');
                    }

                } catch (error) {
                    console.error('Error al procesar el archivo Excel:', error);
                    alert('Error al procesar el archivo Excel. Por favor, verifica que el archivo tenga el formato correcto.');
                }
            };

            reader.readAsArrayBuffer(file);

            // Reset file input
            e.target.value = '';
        });

        // Add event listeners for new buttons
        document.getElementById('addProjectBtn').addEventListener('click', openAddProjectModal);
        document.getElementById('importExcelBtn').addEventListener('click', openImportModal);
        document.getElementById('exportTemplateBtn').addEventListener('click', exportExcelTemplate);
        document.getElementById('importJsonBtn').addEventListener('click', function() {
            document.getElementById('jsonFileInput').click();
        });
        document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedProjects);

        // Close modals when clicking outside
        document.getElementById('editProjectModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        document.getElementById('importModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImportModal();
            }
        });

        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        document.getElementById('contactModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeContactModal();
            }
        });

        // Make functions globally accessible
        window.editProject = editProject;
        window.deleteProject = deleteProject;
        window.deleteSelectedProjects = deleteSelectedProjects;
        window.closeEditModal = closeEditModal;
        window.closeDeleteModal = closeDeleteModal;
        window.confirmDeleteProject = confirmDeleteProject;
        window.closeImportModal = closeImportModal;
        window.closeContactModal = closeContactModal;
        window.handleImport = handleImport;

    </script>
</body>
</html>

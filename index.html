<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyectos Humanitarios Zulia y Falcón - OCHA</title>
    <link rel="icon" type="image/png" href="https://images4.imagebam.com/f2/74/67/MEZQJH3_o.PNG">
    
    <!-- External Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            /* OCHA Color Palette */
            --ocha-blue: #007DBC;
            --ocha-dark-blue: #005A8A;
            --ocha-light-blue: #E8F4F8;
            --ocha-orange: #ECA154;
            --ocha-dark-orange: #D2691E;
            --ocha-gray: #5A5A5A;
            --ocha-light-gray: #F5F5F5;
            --ocha-dark-gray: #3A3A3A;
            --ocha-white: #FFFFFF;
            --ocha-red: #CD3A1F;
            --ocha-green: #7DBA00;
            --ocha-purple: #5B92E5;
            
            /* Humanitarian Sector Colors */
            --sector-salud: #EF5350;
            --sector-proteccion: #9575CD;
            --sector-wash: #4FC3F7;
            --sector-educacion: #81C784;
            --sector-nutricion: #FFB74D;
            --sector-seguridad-alimentaria: #AED581;
            --sector-medios-vida: #A1887F;
            --sector-alojamiento: #78909C;
            --sector-vbg: #F06292;
            --sector-coordinacion: #90A4AE;
            
            /* Shadows and Effects */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --border-radius: 12px;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }

        body {
            font-family: 'Roboto Condensed', Arial, sans-serif;
            background-color: var(--ocha-light-gray);
            color: var(--ocha-dark-gray);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1020;
            border-top: 4px solid var(--ocha-blue);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-brand { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
        }
        
        .header-logo { 
            height: 60px; 
        }
        
        .header-title h1 { 
            font-family: 'Roboto Slab', serif; 
            font-size: 1.6rem; 
            color: var(--ocha-blue); 
            margin: 0; 
        }
        
        .header-subtitle { 
            font-size: 0.9rem; 
            color: var(--ocha-gray); 
            margin-top: 0.25rem; 
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Main Container */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
            flex: 1;
            width: 100%;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            height: fit-content;
            position: sticky;
            top: 100px;
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }

        /* Date Filter Section */
        .date-filter-section {
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: var(--ocha-light-blue);
            border-radius: 8px;
        }

        .date-filter-title {
            font-size: 1rem;
            color: var(--ocha-dark-gray);
            margin-bottom: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-inputs {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .date-input-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--ocha-dark-gray);
        }

        .date-input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
            transition: border-color 0.3s;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--ocha-blue);
        }

        .date-slider-container {
            margin-top: 0.5rem;
        }

        .date-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            margin: 0.5rem 0;
        }

        .date-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--ocha-blue);
            cursor: pointer;
            transition: all 0.3s;
        }

        .date-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--ocha-blue);
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .date-slider::-webkit-slider-thumb:hover {
            background: var(--ocha-dark-blue);
            transform: scale(1.2);
        }

        .date-slider::-moz-range-thumb:hover {
            background: var(--ocha-dark-blue);
            transform: scale(1.2);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--ocha-gray);
            margin-top: 0.25rem;
        }

        /* Filter Section */
        .filter-section { 
            margin-bottom: 1.5rem; 
        }
        
        .filter-title {
            font-size: 1rem;
            color: var(--ocha-dark-gray);
            margin-bottom: 1rem;
            font-weight: 700;
            border-bottom: 2px solid var(--ocha-light-blue);
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .filter-title i { 
            color: var(--ocha-blue); 
        }

        .filter-select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            margin-bottom: 0.75rem;
        }

        /* Multi-select styles */
        .multi-select-container {
            position: relative;
            width: 100%;
            margin-bottom: 0.75rem;
        }

        .multi-select-display {
            width: 100%;
            padding: 0.7rem 0.8rem;
            border: 2px solid var(--ocha-light-blue);
            border-radius: 8px;
            font-size: 0.9rem;
            background: linear-gradient(135deg, rgba(232, 244, 248, 0.5) 0%, white 100%);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--ocha-dark-gray);
            box-shadow: 0 2px 4px rgba(0, 125, 188, 0.08);
        }

        .multi-select-display:hover {
            border-color: var(--ocha-blue);
            background: linear-gradient(135deg, var(--ocha-light-blue) 0%, white 100%);
            box-shadow: 0 4px 8px rgba(0, 125, 188, 0.15);
            transform: translateY(-1px);
        }

        .multi-select-display i {
            color: var(--ocha-blue);
            transition: transform 0.3s ease;
        }

        .multi-select-display.open i {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--ocha-blue);
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 16px rgba(0, 125, 188, 0.2);
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .multi-select-dropdown.open {
            display: block;
        }

        .multi-select-option {
            padding: 0.65rem 0.8rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s ease;
        }

        .multi-select-option:last-child {
            border-bottom: none;
        }

        .multi-select-option:hover {
            background: var(--ocha-light-blue);
        }

        .multi-select-option input {
            margin-right: 0.75rem;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--ocha-blue);
        }

        .multi-select-option label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            font-size: 0.85rem;
            color: var(--ocha-dark-gray);
        }

        .multi-select-option #all-municipios {
            accent-color: var(--ocha-dark-blue);
        }

        .multi-select-option:first-child {
            border-bottom: 2px solid var(--ocha-light-blue);
            background-color: rgba(0, 125, 188, 0.03);
            font-weight: 600;
        }

        /* Humanitarian Sector Icons Grid */
        .sector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
            max-height: 350px;
            overflow-y: auto;
            padding: 0.25rem;
        }

        .sector-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 0.75rem 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            background: var(--ocha-light-gray);
            min-height: 80px;
            justify-content: center;
        }

        .sector-item:hover { 
            background-color: var(--ocha-light-blue); 
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
        }
        
        .sector-item.active { 
            background-color: var(--ocha-blue); 
            color: white; 
            border-color: var(--ocha-dark-blue);
        }
        
        .sector-item.active .sector-icon { 
            color: white; 
        }

        .sector-icon {
            width: 32px;
            height: 32px;
            margin-bottom: 0.25rem;
            transition: opacity 0.3s;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .sector-item.active .sector-icon {
            filter: brightness(0) invert(1);
        }

        .sector-name { 
            font-size: 0.7rem; 
            font-weight: 600;
            line-height: 1.2;
        }

        /* Sector-specific colors */
        .sector-item[data-sector="salud"] .sector-icon { color: var(--sector-salud); }
        .sector-item[data-sector="proteccion"] .sector-icon { color: var(--sector-proteccion); }
        .sector-item[data-sector="wash"] .sector-icon { color: var(--sector-wash); }
        .sector-item[data-sector="educacion"] .sector-icon { color: var(--sector-educacion); }
        .sector-item[data-sector="nutricion"] .sector-icon { color: var(--sector-nutricion); }
        .sector-item[data-sector="seguridad-alimentaria"] .sector-icon { color: var(--sector-seguridad-alimentaria); }
        .sector-item[data-sector="medios-vida"] .sector-icon { color: var(--sector-medios-vida); }
        .sector-item[data-sector="alojamiento"] .sector-icon { color: var(--sector-alojamiento); }
        .sector-item[data-sector="vbg"] .sector-icon { color: var(--sector-vbg); }
        .sector-item[data-sector="coordinacion"] .sector-icon { color: var(--sector-coordinacion); }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-primary { 
            background-color: var(--ocha-blue); 
            color: white; 
        }
        .btn-primary:hover { 
            background-color: var(--ocha-dark-blue); 
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success { 
            background-color: var(--ocha-green); 
            color: white; 
        }
        .btn-success:hover { 
            background-color: #649600; 
        }
        
        .btn-secondary { 
            background-color: var(--ocha-gray); 
            color: white; 
        }
        .btn-secondary:hover { 
            background-color: var(--ocha-dark-gray); 
        }
        
        .btn-block { 
            width: 100%; 
            justify-content: center; 
        }

        /* Main Content */
        .main-content { 
            display: flex; 
            flex-direction: column; 
            gap: 1.5rem; 
        }

        /* KPI Section */
        .kpi-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .kpi-card {
            background: var(--ocha-light-blue);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border-left: 5px solid var(--ocha-blue);
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .kpi-icon {
            font-size: 2rem;
            color: var(--ocha-blue);
            margin-bottom: 0.5rem;
            opacity: 0.8;
        }

        .kpi-value { 
            font-size: 2.5rem; 
            font-weight: 700; 
            color: var(--ocha-blue); 
        }
        
        .kpi-label { 
            font-size: 0.9rem; 
            color: var(--ocha-gray); 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Map and Charts Container */
        .map-charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Map Section */
        .map-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 0;
            box-shadow: var(--shadow-sm);
            height: 600px;
            position: relative;
            overflow: hidden;
        }

        /* Charts Section */
        .charts-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            height: 285px;
        }

        .chart-title {
            font-family: 'Roboto Slab', serif;
            color: var(--ocha-blue);
            font-size: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .chart-container canvas {
            max-height: 220px;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: var(--border-radius);
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 0.85rem;
            max-width: 200px;
        }

        .map-disclaimer {
            position: absolute;
            bottom: 40px;
            left: 10px;
            right: 220px;
            background: rgba(255, 255, 255, 0.95);
            padding: 6px 10px;
            font-size: 0.7rem;
            color: #555;
            text-align: left;
            border-radius: 4px;
            z-index: 999;
            line-height: 1.3;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--ocha-blue);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #ccc;
        }

        /* Table Section */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-box { 
            position: relative; 
            flex-grow: 1; 
            max-width: 400px; 
        }
        
        .search-input { 
            width: 100%; 
            padding: 0.75rem 1rem 0.75rem 3rem; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 0.875rem; 
        }
        
        .search-icon { 
            position: absolute; 
            left: 1rem; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--ocha-gray); 
        }
        
        .table-actions { 
            display: flex; 
            gap: 0.5rem; 
            flex-wrap: wrap;
        }

        .table-wrapper { 
            overflow-x: auto; 
        }
        
        .projects-table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        
        .projects-table th { 
            background: var(--ocha-light-gray); 
            padding: 0.8rem; 
            text-align: left; 
            font-weight: 700; 
            color: var(--ocha-dark-gray); 
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: all 0.2s ease;
            padding: 0.8rem 1rem;
        }

        .sortable-header:hover {
            background: var(--ocha-blue-light);
            color: var(--ocha-blue);
        }

        .sort-indicator {
            margin-left: 8px;
            color: var(--ocha-blue);
            font-size: 0.9em;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }

        .sortable-header:hover .sort-indicator {
            opacity: 1;
        }

        .sort-indicator.asc {
            opacity: 1;
            color: var(--ocha-blue);
        }

        .sort-indicator.asc:before {
            content: "▲";
        }

        .sort-indicator.desc {
            opacity: 1;
            color: var(--ocha-blue);
        }

        .sort-indicator.desc:before {
            content: "▼";
        }
        
        .projects-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
        }
        
        .projects-table tr:hover {
            background: var(--ocha-light-blue);
        }
        
        .actions-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            color: var(--ocha-blue);
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 32px;
            height: 32px;
        }
        
        .action-btn:hover {
            background: var(--ocha-blue);
            color: white;
            border-color: var(--ocha-blue);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .action-btn.primary {
            background: var(--ocha-blue);
            color: white;
            border-color: var(--ocha-blue);
        }

        .action-btn.primary:hover {
            background: var(--ocha-dark-blue);
            border-color: var(--ocha-dark-blue);
        }

        .action-btn.success {
            background: var(--ocha-green);
            color: white;
            border-color: var(--ocha-green);
        }

        .action-btn.success:hover {
            background: #0f7b0f;
            border-color: #0f7b0f;
        }

        .action-btn.warning {
            background: var(--ocha-orange);
            color: white;
            border-color: var(--ocha-orange);
        }

        .action-btn.warning:hover {
            background: #cc7722;
            border-color: #cc7722;
        }

        .action-btn.secondary {
            background: var(--ocha-gray);
            color: white;
            border-color: var(--ocha-gray);
        }

        .action-btn.secondary:hover {
            background: var(--ocha-dark-gray);
            border-color: var(--ocha-dark-gray);
        }

        .action-btn.danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .action-btn.danger:hover {
            background: #c82333;
            border-color: #c82333;
        }

        .action-btn i {
            margin-right: 0.25rem;
            font-size: 0.85rem;
        }

        .action-btn.icon-only {
            padding: 0.5rem;
            min-width: 32px;
        }

        .action-btn.icon-only i {
            margin-right: 0;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center; 
            justify-content: center;
        }
        
        .modal.active { 
            display: flex; 
        }
        
        .modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: var(--border-radius);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--ocha-light-blue);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .modal-title {
            font-family: 'Roboto Slab', serif;
            color: var(--ocha-blue);
            margin: 0;
        }
        
        .modal-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
        }
        
        .modal-close:hover {
            color: var(--ocha-red);
        }
        
        .modal-body {
            padding: 1.5rem;
        }

        .modal-field {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-left: 3px solid var(--ocha-blue);
            background: var(--ocha-light-gray);
            border-radius: 0 6px 6px 0;
        }

        .modal-field strong {
            color: var(--ocha-dark-gray);
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--ocha-light-gray);
        }

        .modal-sector-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .modal-sector-badge {
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid var(--ocha-blue);
            border-radius: 20px;
            padding: 0.4rem 0.8rem;
            font-weight: 600;
            color: var(--ocha-blue);
            font-size: 0.85rem;
        }

        .modal-sector-badge img {
            margin-right: 0.4rem;
        }

        .modal-status-badge {
            background: white;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            border: 2px solid #dee2e6;
        }

        .modal-field-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .modal-field-full {
            grid-column: 1 / -1;
        }

        .modal-field strong {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-field span {
            font-weight: 500;
            color: var(--ocha-dark-gray);
        }

        .text-ocha {
            color: var(--ocha-blue);
        }

        .activity-description {
            margin-top: 0.5rem;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            border-left: 4px solid var(--ocha-blue);
            line-height: 1.6;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .modal-field-group {
                grid-template-columns: 1fr;
            }
            
            .modal-header-info {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Footer */
        .footer {
            background: var(--ocha-dark-gray);
            color: white;
            padding: 2rem 0;
            margin-top: auto;
        }
        
        .footer-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 2rem;
            align-items: start;
        }

        .footer-section h3 {
            color: var(--ocha-orange);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .footer-section p, 
        .footer-section li {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #ccc;
        }

        .footer-section ul {
            list-style: none;
        }

        .footer-section ul li {
            margin-bottom: 0.5rem;
        }

        .footer-section a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-section a:hover {
            color: var(--ocha-orange);
        }

        .footer-bottom {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #555;
            color: #999;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .sidebar {
                position: relative;
                top: 0;
                max-height: none;
            }

            .map-charts-container {
                grid-template-columns: 1fr;
            }

            .charts-section {
                flex-direction: row;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .main-container {
                padding: 1rem;
            }
            
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: none;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .charts-section {
                flex-direction: column;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--ocha-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status indicators */
        .status-en-proyecto { color: var(--ocha-orange); font-weight: 600; }
        .status-en-ejecución { color: var(--ocha-green); font-weight: 600; }
        .status-terminado { color: var(--ocha-blue); font-weight: 600; }

        /* Custom Leaflet marker styles */
        .leaflet-popup-content-wrapper {
            border-radius: var(--border-radius);
        }
        .leaflet-popup-content {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--ocha-gray);
        }
        .leaflet-popup-content h4 {
            font-family: 'Roboto Slab', serif;
            color: var(--ocha-blue);
            font-size: 1.1rem;
        }
        .leaflet-popup-content p {
            margin-bottom: 0.3rem;
        }
        .leaflet-popup-content strong {
            color: var(--ocha-dark-gray);
        }
        .leaflet-popup-close-button {
            background-color: var(--ocha-red);
            color: white;
            font-size: 1rem;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            margin-top: -12px;
            margin-right: -12px;
        }
        .leaflet-popup-close-button:hover {
            background-color: #a30000;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-brand">
                <img src="https://images4.imagebam.com/f2/74/67/MEZQJH3_o.PNG" alt="OCHA Logo" class="header-logo">
                <div class="header-title">
                    <h1>Registro de Proyectos Humanitarios <span id="stateTitle">Zulia y Falcón</span></h1>
                    <div class="header-subtitle">
                        <span id="headerSubtitle">Sub Oficina OCHA Maracaibo - Autoridades Regionales y Municipales</span>
                        <span id="filterIndicator" style="margin-left: 1rem; font-size: 0.9rem; opacity: 0.9;"></span>
                    </div>
                </div>
            </div>
            <div class="header-actions" style="display: flex; gap: 0.5rem;">
                <button id="importJsonBtn" class="btn btn-primary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                    <i class="fas fa-file-import"></i> JSON
                </button>
                <button id="importExcelBtn" class="btn btn-primary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                    <i class="fas fa-file-upload"></i> Excel
                </button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar with Filters -->
        <aside class="sidebar">
            <!-- State Selector -->
            <div class="filter-section" style="background: var(--ocha-light-blue); border-radius: 8px; padding: 1rem;">
                <h3 class="filter-title">
                    <i class="fas fa-map"></i> Estado
                </h3>
                <div id="stateFilter" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="state" value="Zulia" checked> Zulia
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="state" value="Falcón"> Falcón
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="state" value="Lara"> Lara
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="state" value="Trujillo"> Trujillo
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="state" value="Todos"> Todos los Estados
                    </label>
                </div>
            </div>

            <!-- Traditional Filters -->
            <div class="filter-section">
                <h3 class="filter-title">
                    <i class="fas fa-filter"></i> Filtros Generales
                </h3>
                <select id="orgFilter" class="filter-select">
                    <option value="">Todas las Organizaciones</option>
                </select>
                <label style="display: block; font-weight: 600; color: #5a5a5a; margin-bottom: 0.5rem; font-size: 0.9rem;">Municipios</label>
                <div class="multi-select-container">
                    <div class="multi-select-display" id="municipioDisplay">
                        <span>Todos los Municipios</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="multi-select-dropdown" id="municipioDropdown">
                        <div class="multi-select-option">
                            <input type="checkbox" id="all-municipios" checked>
                            <label for="all-municipios">Todos los Municipios</label>
                        </div>
                    </div>
                </div>
                <select id="estatusFilter" class="filter-select">
                    <option value="">Todos los Estatus</option>
                </select>
                <button id="resetFilters" class="btn btn-secondary btn-block">
                    <i class="fas fa-refresh"></i> Limpiar Filtros
                </button>
            </div>

            <!-- Humanitarian Sectors -->
            <div class="filter-section">
                <h3 class="filter-title">
                    <i class="fas fa-hand-holding-heart"></i> Sectores Humanitarios
                </h3>
                <div id="sectorGrid" class="sector-grid"></div>
            </div>

            <!-- Date Filter Section -->
            <div class="date-filter-section">
                <h3 class="date-filter-title">
                    <i class="fas fa-calendar-alt"></i> Filtro por Fechas
                </h3>
                <div class="date-inputs">
                    <div class="date-input-group">
                        <label class="date-input-label">Fecha Inicio</label>
                        <input type="date" id="dateStart" class="date-input">
                    </div>
                    <div class="date-input-group">
                        <label class="date-input-label">Fecha Fin</label>
                        <input type="date" id="dateEnd" class="date-input">
                    </div>
                    <div class="date-slider-container">
                        <input type="range" id="dateRangeSlider" class="date-slider" min="0" max="365" value="30">
                        <div class="slider-labels">
                            <span id="sliderMinDate">Última semana</span>
                            <span id="sliderMaxDate">Último año</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- KPI Cards -->
            <section class="kpi-section">
                <div id="kpiContainer" class="kpi-grid"></div>
            </section>

            <!-- Map and Charts Section -->
            <section class="map-charts-container">
                <div class="map-section">
                    <div id="map"></div>
                    <div class="map-legend">
                        <div class="legend-title">Leyenda del Mapa</div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: var(--ocha-blue);"></div>
                            <span>En ejecución</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: var(--ocha-orange);"></div>
                            <span>En proyecto</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: var(--ocha-green);"></div>
                            <span>Terminado</span>
                        </div>
                    </div>
                </div>
                <div class="charts-section">
                    <div class="chart-container">
                        <h4 class="chart-title">Proyectos por Sector</h4>
                        <canvas id="sectorChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4 class="chart-title">Estatus de Proyectos</h4>
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>
            </section>
            
            <!-- Map Disclaimer moved closer to map -->
            <div style="font-size: 0.6rem; color: #777; text-align: left; margin-top: 0.25rem; padding: 0.2rem 0.4rem; background: rgba(255,255,255,0.9); border-radius: 3px; line-height: 1.2; max-width: 700px;">
                <strong>Disclaimer:</strong> Las denominaciones empleadas en este mapa y la forma en que aparecen presentados los datos que contienen no implican de parte de la Secretaría de Naciones Unidas juicio alguno sobre la condición jurídica de países, territorios, ciudades, zonas, o de sus autoridades, ni respecto a la delimitación de sus fronteras o límites.
            </div>

            <!-- Data Table -->
            <section class="table-container">
                <div class="table-header">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar proyectos, organizaciones, municipios...">
                    </div>
                    <div class="table-actions">
                        <button id="addProjectBtn" class="btn btn-success">
                            <i class="fas fa-plus"></i> Agregar Proyecto
                        </button>
                        <button id="exportFilteredExcel" class="btn btn-success">
                            <i class="fas fa-file-excel"></i> Exportar Filtrados
                        </button>
                        <button id="exportFilteredPdf" class="btn btn-primary">
                            <i class="fas fa-file-pdf"></i> PDF Filtrados
                        </button>
                        <button id="deleteSelectedBtn" class="btn btn-danger" style="display: none; background: #dc3545; border-color: #dc3545; color: white;">
                            <i class="fas fa-trash-alt"></i> Eliminar Seleccionados (<span id="selectedCount">0</span>)
                        </button>
                        <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="projects-table">
                        <thead>
                            <tr id="tableHeaders"></tr>
                        </thead>
                        <tbody id="projectsTableBody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal for Project Details -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="modal-title">Detalles del Proyecto</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div id="modalBody" class="modal-body"></div>
        </div>
    </div>

    <!-- Modal for Add/Edit Project -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="editModalTitle" class="modal-title">Agregar Proyecto</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm" style="display: grid; gap: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Código del proyecto *</label>
                            <input type="text" id="formCodigo" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Estatus *</label>
                            <select id="formEstatus" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">Seleccionar...</option>
                                <option value="En proyecto">En proyecto</option>
                                <option value="En ejecución">En ejecución</option>
                                <option value="Terminado">Terminado</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Nombre del proyecto *</label>
                        <input type="text" id="formNombre" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Organización Líder *</label>
                            <input type="text" id="formOrgLider" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Organización Implementadora</label>
                            <input type="text" id="formOrgImpl" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Sector Humanitario *</label>
                            <select id="formSector" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">Seleccionar Sector...</option>
                                <option value="Agua, saneamiento e higiene">ASH - Agua, saneamiento e higiene</option>
                                <option value="Alojamiento, energia y enseres">AEE - Alojamiento, energía y enseres</option>
                                <option value="Educación">EDU - Educación</option>
                                <option value="Logística">LOG - Logística</option>
                                <option value="Nutrición">NUT - Nutrición</option>
                                <option value="Protección (Incluidas las AdR de VbG y NNA)">PRO - Protección (VbG y NNA)</option>
                                <option value="Salud">SAL - Salud</option>
                                <option value="Seguridad Alimentaria">SAMV - Seguridad Alimentaria</option>
                                <option value="Coordinación">COO - Coordinación</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Área de intervención complementaria</label>
                            <input type="text" id="formArea" placeholder="Ej: Salud; Educación; Protección" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Estado *</label>
                            <select id="formEstado" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">Seleccionar Estado...</option>
                                <option value="Zulia">Zulia</option>
                                <option value="Falcón">Falcón</option>
                                <option value="Lara">Lara</option>
                                <option value="Trujillo">Trujillo</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Municipio *</label>
                            <select id="formMunicipio" required style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">Seleccionar Municipio...</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Parroquias</label>
                            <input type="text" id="formParroquias" placeholder="Ej: Bolívar; Chiquinquirá" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Fecha de Inicio</label>
                            <input type="date" id="formFechaInicio" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Fecha de Finalización</label>
                            <input type="date" id="formFechaFin" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Descripción de la Actividad</label>
                        <textarea id="formActividad" rows="4" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar Proyecto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal for Import Options -->
    <div id="importModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Importar Datos desde Excel</h2>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: var(--ocha-gray);">
                    Selecciona cómo deseas importar los datos del archivo Excel:
                </p>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button onclick="handleImport('replace')" class="btn btn-primary btn-block">
                        <i class="fas fa-sync-alt"></i> Reemplazar todos los datos
                    </button>
                    <button onclick="handleImport('merge')" class="btn btn-success btn-block">
                        <i class="fas fa-plus-circle"></i> Hacer merge (agregar nuevos)
                    </button>
                    <button onclick="closeImportModal()" class="btn btn-secondary btn-block">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
                <p style="margin-top: 1.5rem; font-size: 0.85rem; color: #777;">
                    <strong>Nota:</strong> El archivo Excel debe tener la misma estructura que el archivo de datos original.
                </p>
            </div>
        </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h2>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: var(--ocha-gray); font-size: 1rem;">
                    ¿Está seguro de que desea eliminar este proyecto? Esta acción <strong>no se puede deshacer</strong>.
                </p>
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
                    <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> El proyecto será eliminado de la base de datos de Supabase.
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button onclick="closeDeleteModal()" class="btn btn-secondary btn-block">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button onclick="confirmDeleteProject()" class="btn btn-danger btn-block" style="background: #dc3545; border-color: #dc3545; color: white;">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Contact Information -->
    <div id="contactModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-address-book"></i> Contactar a OCHA</h2>
                <button class="modal-close" onclick="closeContactModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: var(--ocha-light-blue); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--ocha-blue); margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-map-marker-alt"></i> Sub Oficina OCHA Maracaibo
                    </h3>
                </div>

                <div style="background: white; border: 2px solid var(--ocha-blue); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                    <h4 style="color: var(--ocha-dark-gray); margin-bottom: 0.75rem; font-size: 1rem;">
                        <i class="fas fa-user-circle"></i> Jefa de Sub Oficina OCHA
                    </h4>
                    <p style="margin-bottom: 0.5rem; font-weight: 600; color: var(--ocha-blue); font-size: 1.1rem;">Laura Solórzano</p>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                        <a href="https://wa.me/584126173878" target="_blank" class="btn btn-success" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fab fa-whatsapp" style="font-size: 1.2rem;"></i> WhatsApp: +58 412 6173878
                        </a>
                        <a href="mailto:solorzano2@un.org" class="btn btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-envelope"></i> solorzano2@un.org
                        </a>
                    </div>
                </div>

                <div style="background: white; border: 2px solid var(--ocha-gray); border-radius: 8px; padding: 1.5rem;">
                    <h4 style="color: var(--ocha-dark-gray); margin-bottom: 0.75rem; font-size: 1rem;">
                        <i class="fas fa-code"></i> Desarrollado por
                    </h4>
                    <p style="margin-bottom: 0.5rem; font-weight: 600; color: var(--ocha-gray); font-size: 1.1rem;">Jhozman Camacho</p>
                    <p style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--ocha-gray);">IMA Sub Oficina OCHA</p>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                        <a href="mailto:jhozman.camacho@un.org" class="btn btn-secondary" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-envelope"></i> jhozman.camacho@un.org
                        </a>
                    </div>
                </div>

                <div style="margin-top: 1.5rem; text-align: center;">
                    <button onclick="closeContactModal()" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Acerca de Este Dashboard</h3>
                <p>Dashboard Humanitario desarrollado para las autoridades regionales y municipales en colaboración con la <strong>Sub Oficina OCHA Maracaibo</strong>. Facilita el seguimiento y coordinación de proyectos humanitarios en los estados Zulia, Falcón, Lara y Trujillo.</p>
            </div>
            <div class="footer-section">
                <h3>Enlaces Útiles</h3>
                <ul>
                    <li><a href="#" onclick="showAbout()">Acerca del Sistema</a></li>
                    <li><a href="#" onclick="showHelp()">Ayuda y Soporte</a></li>
                    <li><a href="#" onclick="showContact()">Contactar OCHA</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Información Técnica</h3>
                <ul>
                    <li>Última actualización: <span id="lastUpdate"></span></li>
                    <li>Total de registros: <span id="totalRecords"></span></li>
                    <li>Versión del sistema: 2.1.1</li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Agosto 2025 Sub Oficina OCHA Maracaibo. Desarrollado para fines humanitarios.</p>
        </div>
    </footer>

    <script>
        // Global Variables and Configuration
        let map = null;
        let markers = [];
        let projectsData = []; // Original data from JSON
        let expandedData = []; // Expanded data for filtering (each semicolon-separated value becomes a row)
        let filteredData = []; // Currently filtered data
        let sectorChart = null;
        let timeChart = null;
        let currentFilters = {
            org: '',
            municipio: [],
            estatus: '',
            search: '',
            sector: '',
            dateStart: '',
            dateEnd: ''
        };
        
        // Function to expand semicolon-separated data for proper filtering
        function expandProjectData(projects) {
            const expanded = [];
            
            projects.forEach((project, originalIndex) => {
                // Extract semicolon-separated values
                const municipalities = extractAndNormalizeMunicipalities(project['Municipio']);
                const areas = project['Área de intervención complementaria'] 
                    ? project['Área de intervención complementaria'].split(';').map(s => s.trim()).filter(s => s)
                    : [''];
                
                // For each municipality, create one expanded row
                municipalities.forEach(municipality => {
                    expanded.push({
                        ...project,
                        'Municipio': municipality,
                        '_originalIndex': originalIndex,
                        '_expandedMunicipality': municipality,
                        '_expandedAreas': areas,
                        '_isExpanded': true
                    });
                });
            });
            
            return expanded;
        }

        // Humanitarian Sectors Configuration with OCHA official icons
        const humanitarianSectors = [
            { id: 'agua-saneamiento', name: 'Agua, saneamiento e higiene', shortName: 'ASH', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzlkXC80MzY2OTIwXC83MWE1OTcyMzkyYTJkM2VlNDgxNmQ1ODU0MGNmNTliYS0xNTkxNzIxMTgyLnN2ZyJ9:frontify:MgH6UY5xqyfKx77ec3VRFtR1lOv93RJDs8MqbwFkJpM?width=64', keywords: ['agua', 'saneamiento', 'higiene', 'wash', 'potable'] },
            { id: 'alojamiento', name: 'Alojamiento, energia y enseres', shortName: 'AEE', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2NmXC80MzY2ODEyXC8xZTI5NzQzMzcyOTE0YjE2MDkxNTI0N2NkZGMwY2E3NC0xNTkxNzE4OTIxLnN2ZyJ9:frontify:FUBxqK8yAh-cPqjcmhGA4pR442WpMZP8wrc1C9PJZn8?width=64', keywords: ['alojamiento', 'vivienda', 'shelter', 'refugio', 'energia', 'enseres'] },
            { id: 'educacion', name: 'Educación', shortName: 'EDU', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzJjXC80MzY0NjkwXC8xYTIwZTMxZTMzOTEwY2U3YTA4Yjg5ODVhOGU5Mjg0My0xNTkxNjkzNjA1LnN2ZyJ9:frontify:90NzWxvX_2V0BDPOGueYpIZfuSZvJfOer4Pkvq4dHBA?width=64', keywords: ['educación', 'educacion', 'escuela', 'capacitación'] },
            { id: 'logistica', name: 'Logística', shortName: 'LOG', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2I1XC80MzY1NjU4XC9lYWMwZTAwYTliOTAzNzE5MTg5ODVlOGQzODYxZjRkZi0xNTkxNzA1NzA4LnN2ZyJ9:frontify:7PGcDsrr0gOGydKDD5v7Aia13DteuetjkK0j4oKUqZI?width=64', keywords: ['logística', 'logistica', 'suministros', 'transporte'] },
            { id: 'nutricion', name: 'Nutrición', shortName: 'NUT', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzQzXC80MzY1NzM1XC82ODU2MWExNDAzMzc0NzBjNDE5MGFmYWY5NTFkNzU4Yi0xNTkxNzA2NjI1LnN2ZyJ9:frontify:3rsyLJgQXbU3Y015aKrjd1ohrB4PI_KPd723_KhjCWA?width=64', keywords: ['nutrición', 'nutricion', 'alimentación', 'malnutrición'] },
            { id: 'proteccion', name: 'Protección (Incluidas las AdR de VbG y NNA)', shortName: 'PRO', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2EyXC80MzY1OTYwXC8zYjFiMDY2MTAzYjIyMWY0MTI4YTVkNzkxYmRjOTE3YS0xNTkxNzA4MzI2LnN2ZyJ9:frontify:7lTtjGE2P2Nbz_525sMoZikLkHSh9tegag19Prx_SZc?width=64', keywords: ['protección', 'proteccion', 'derechos', 'legal', 'vbg', 'violencia', 'género', 'niños'] },
            { id: 'salud', name: 'Salud', shortName: 'SAL', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzQwXC80MzY1MDA0XC9jNDk5OWE4ZDk2ZDE1YjZhNzIxMTQ5ZWU4YTFiMTkwMy0xNTkxNzAxMjUzLnN2ZyJ9:frontify:R0CU010gVeFON_MaMY38IILJz2LXMajqem4P1TiGwQk?width=64', keywords: ['salud', 'médico', 'hospital', 'clínica'] },
            { id: 'seguridad-alimentaria', name: 'Seguridad Alimentaria', shortName: 'SAMV', ochaIcon: 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2I0XC80MzY0Nzc1XC8xYjhhNmIxNzZlZTQ4MThjZjJjOGE5NDQyN2FjMjNjYi0xNTkxNjk0MjY5LnN2ZyJ9:frontify:tXhekXovZmafEC1xe1vMSYzRz4aiC23x9HTHlGsrz4U?width=64', keywords: ['alimentaria', 'alimentos', 'seguridad alimentaria'] },
            { id: 'coordinacion', name: 'Coordinación', shortName: 'COO', ochaIcon: 'https://images4.imagebam.com/e8/c9/d9/ME15B6OI_o.jpg', keywords: ['coordinación', 'coordinacion', 'gestión', 'administración'] }
        ];

        // Municipal coordinates for Zulia State (corrected coordinates)
const zuliaCoordinates = {
  // Official 21 municipalities with correct names (with tildes)
  'Almirante Padilla': [11.081389, -71.678611],
  'Baralt': [9.073056, -71.088056],
  'Cabimas': [10.397050, -71.382909],
  'Catatumbo': [8.932051, -72.212489],
  'Colón': [8.910424, -71.889130],
  'Francisco Javier Pulgar': [8.876724, -71.579093],
  'Indígena Bolivariano Guajira': [11.293893, -71.954533],
  'Jesús Enrique Lossada': [10.627971, -71.941754],
  'Jesús María Semprún': [9.065695, -72.575965],
  'La Cañada de Urdaneta': [10.386725, -71.914161],
  'Lagunillas': [10.204995, -71.205749],
  'Machiques de Perijá': [9.786057, -72.506373],
  'Mara': [10.881860, -71.957233],
  'Maracaibo': [10.665127, -71.656126],
  'Miranda': [10.720599, -71.378252],
  'Páez': [9.342778, -71.263611],
  'Rosario de Perijá': [10.188122, -72.296170],
  'San Francisco': [10.547222, -71.672908],
  'Santa Rita': [10.528048, -71.420883],
  'Simón Bolívar': [10.293099, -71.315466],
  'Sucre': [9.151367, -71.148344],
  'Valmore Rodríguez': [10.073581, -71.039030],
  // Alternative names and variations for compatibility
  'Guajira': [11.293893, -71.954533],
  'Ciudad Ojeda': [10.204995, -71.205749],
  'Colon': [8.910424, -71.889130],
  'Jesus Enrique Lossada': [10.627971, -71.941754],
  'Jesus María Semprun': [9.065695, -72.575965],
  'Jesus María Semprún': [9.065695, -72.575965],
  'La Canada de Urdaneta': [10.386725, -71.914161],
  'Machiques': [9.786057, -72.506373],
  'Machiques de Perija': [9.786057, -72.506373],
  'Rosario de Perija': [10.188122, -72.296170],
  'Valmore Rodriguez': [10.073581, -71.039030],
  'Simon Bolivar': [10.293099, -71.315466]
};

// Falcón State Coordinates (25 municipalities - Official coordinates)
const falconCoordinates = {
  'Acosta': [11.1738, -68.4099],                    // San Juan de los Cayos
  'Bolívar': [11.1057, -69.7145],                   // San Luis
  'Buchivacoa': [11.1718, -70.6204],                // Capatárida
  'Cacique Manaure': [10.9739, -68.5468],           // Yaracal
  'Carirubana': [11.7086, -70.0056],                // Punto Fijo
  'Colina': [11.4589, -69.5648],                    // La Vela de Coro
  'Dabajuro': [11.0239, -70.6776],                  // Dabajuro
  'Democracia': [11.0240, -70.1206],                // Pedregal
  'Falcón': [11.9479, -69.9231],                    // Pueblo Nuevo
  'Federación': [10.8129, -69.5410],                // Churuguara
  'Iturriza': [10.9333, -68.2772],                  // Chichiriviche
  'Jacura': [11.0739, -68.8564],                    // Jacura
  'Los Taques': [11.8226, -70.2557],                // Santa Cruz de Los Taques
  'Mauroa': [10.6802, -71.0345],                    // Mene de Mauroa
  'Miranda': [11.4045, -69.6734],                   // Santa Ana de Coro
  'Palmasola': [10.5918, -68.5410],                 // Palmasola
  'Petit': [11.1296, -69.6089],                     // Cabure
  'Píritu': [11.3378, -69.0493],                    // Píritu
  'San Francisco': [11.1618, -68.7240],             // Mirimire
  'Silva': [10.7906, -68.3258],                     // Tucacas
  'Sucre': [11.0607, -69.7138],                     // La Cruz de Taratara
  'Tocópero': [11.5013, -69.2584],                  // Tocópero
  'Unión': [10.8342, -69.2699],                     // Santa Cruz de Bucaral
  'Urumaco': [11.2000, -70.2500],                   // Urumaco
  'Zamora': [11.4864, -69.3503]                     // Puerto Cumarebo
};

// Lara State Coordinates (9 municipalities - Official coordinates)
const laraCoordinates = {
  'Andrés Eloy Blanco': [9.7439, -69.6512],                // Sanare
  'Crespo': [9.8531, -69.5914],                             // Duaca
  'Iribarren': [10.0677, -69.3474],                         // Barquisimeto
  'Jiménez': [9.9287, -69.6201],                            // Quíbor
  'Morán': [9.7871, -69.7929],                              // El Tocuyo
  'Palavecino': [10.0266, -69.2620],                        // Cabudare
  'Simón Planas': [9.7836, -69.1626],                       // Sarare
  'Torres': [10.1695, -70.0728],                            // Carora
  'Urdaneta': [10.5703, -69.7083],                          // Siquisique
  // Alternative names and variations for compatibility
  'Sanare': [9.7439, -69.6512],
  'Duaca': [9.8531, -69.5914],
  'Barquisimeto': [10.0677, -69.3474],
  'Quíbor': [9.9287, -69.6201],
  'El Tocuyo': [9.7871, -69.7929],
  'Cabudare': [10.0266, -69.2620],
  'Sarare': [9.7836, -69.1626],
  'Carora': [10.1695, -70.0728],
  'Siquisique': [10.5703, -69.7083],
  'Simon Planas': [9.7836, -69.1626],
  'Andres Eloy Blanco': [9.7439, -69.6512]
};

// Trujillo State Coordinates (20 municipalities - Official coordinates)
const trujilloCoordinates = {
  'Andrés Bello': [9.6345, -70.8100],                       // Santa Isabel
  'Boconó': [9.2534, -70.2498],                             // Boconó
  'Bolívar': [9.7038, -70.5243],                            // Sabana Grande
  'Candelaria': [9.6219, -70.3522],                         // Chejendé
  'Carache': [9.7072, -70.1932],                            // Carache
  'Carvajal': [9.4006, -70.5622],                           // Carvajal (San Rafael de Carvajal)
  'Campo Elías': [9.5050, -70.4183],                        // Campo Elías
  'Escuque': [9.3053, -70.6729],                            // Escuque
  'La Ceiba': [9.4780, -71.0142],                           // Santa Apolonia
  'Márquez Cañizales': [9.7750, -70.6063],                  // El Paradero (José Felipe Márquez Cañizales)
  'Miranda': [9.4817, -70.7298],                            // El Dividive
  'Monte Carmelo': [9.1876, -70.8130],                      // Monte Carmelo
  'Motatán': [9.3931, -70.5934],                            // Motatán
  'Pampán': [9.4512, -70.4759],                             // Pampán
  'Pampanito': [9.4115, -70.4982],                          // Pampanito
  'Rangel': [9.3798, -70.7332],                             // Betijoque (Rafael Rangel)
  'Sucre': [9.4388, -70.7704],                              // Sabana de Mendoza
  'Trujillo': [9.3658, -70.4369],                           // Trujillo
  'Urdaneta': [9.1533, -70.5783],                           // La Quebrada
  'Valera': [9.3178, -70.6036],                             // Valera
  // Alternative names and variations for compatibility
  'Santa Isabel': [9.6345, -70.8100],
  'Sabana Grande': [9.7038, -70.5243],
  'Chejendé': [9.6219, -70.3522],
  'Santa Apolonia': [9.4780, -71.0142],
  'El Paradero': [9.7750, -70.6063],
  'El Dividive': [9.4817, -70.7298],
  'Betijoque': [9.3798, -70.7332],
  'Sabana de Mendoza': [9.4388, -70.7704],
  'La Quebrada': [9.1533, -70.5783],
  'San Rafael de Carvajal': [9.4006, -70.5622],
  'Rafael Rangel': [9.3798, -70.7332],
  'Jose Felipe Marquez Canizales': [9.7750, -70.6063],
  'Marquez Canizales': [9.7750, -70.6063],
  'Juan Vicente Campo Elias': [9.5050, -70.4183],
  'Andres Bello': [9.6345, -70.8100]
};

// Current state variable
let currentState = 'Zulia';

// Centers for maps
const ZULIA_CENTER = [10.0, -72.0];
const FALCON_CENTER = [11.3, -69.2];
const LARA_CENTER = [10.0, -69.6];
const TRUJILLO_CENTER = [9.4, -70.5];
const ALL_STATES_CENTER = [9.9, -70.3];

// Function to get active coordinates based on selected state
function getActiveCoordinates() {
  if (currentState === 'Falcón') return falconCoordinates;
  if (currentState === 'Lara') return laraCoordinates;
  if (currentState === 'Trujillo') return trujilloCoordinates;
  if (currentState === 'Todos') return { ...zuliaCoordinates, ...falconCoordinates, ...laraCoordinates, ...trujilloCoordinates };
  return zuliaCoordinates;
}

// Function to get active municipalities list
function getActiveMunicipalities() {
  const coords = getActiveCoordinates();
  return Object.keys(coords).filter(m => !m.includes('Alternative') && !m.includes('Colon') && !m.includes('Simon') && !m.includes('Jesus') && !m.includes('Valmore') && !m.includes('Machiques') && !m.includes('Rosario') && !m.includes('La') && !m.includes('Guajira') && !m.includes('Ciudad'));
}

// Get official municipalities only
function getOfficialMunicipalities(state) {
  // If state is provided as parameter, use it; otherwise use currentState
  const activeState = state || currentState;

  // Return municipalities based on current state
  if (activeState === 'Falcón') {
    return [
      'Acosta', 'Bolívar', 'Buchivacoa', 'Cacique Manaure', 'Carirubana',
      'Colina', 'Dabajuro', 'Democracia', 'Falcón', 'Federación',
      'Iturriza', 'Jacura', 'Los Taques', 'Mauroa', 'Miranda',
      'Palmasola', 'Petit', 'Píritu', 'San Francisco', 'Silva',
      'Sucre', 'Tocópero', 'Unión', 'Urumaco', 'Zamora'
    ];
  }

  if (activeState === 'Lara') {
    return [
      'Andrés Eloy Blanco', 'Crespo', 'Iribarren', 'Jiménez', 'Morán',
      'Palavecino', 'Simón Planas', 'Torres', 'Urdaneta'
    ];
  }

  if (activeState === 'Trujillo') {
    return [
      'Andrés Bello', 'Boconó', 'Bolívar', 'Candelaria', 'Carache',
      'Carvajal', 'Campo Elías', 'Escuque', 'La Ceiba', 'Márquez Cañizales',
      'Miranda', 'Monte Carmelo', 'Motatán', 'Pampán', 'Pampanito',
      'Rangel', 'Sucre', 'Trujillo', 'Urdaneta', 'Valera'
    ];
  }

  if (activeState === 'Todos') {
    return [
      // Zulia (22 municipios)
      'Almirante Padilla', 'Baralt', 'Cabimas', 'Catatumbo', 'Colón',
      'Francisco Javier Pulgar', 'Indígena Bolivariano Guajira',
      'Jesús Enrique Lossada', 'Jesús María Semprún',
      'La Cañada de Urdaneta', 'Lagunillas', 'Machiques de Perijá',
      'Mara', 'Maracaibo', 'Miranda', 'Páez', 'Rosario de Perijá',
      'San Francisco', 'Santa Rita', 'Simón Bolívar', 'Sucre',
      'Valmore Rodríguez',
      // Falcón (25 municipios)
      'Acosta', 'Bolívar', 'Buchivacoa', 'Cacique Manaure', 'Carirubana',
      'Colina', 'Dabajuro', 'Democracia', 'Falcón', 'Federación',
      'Iturriza', 'Jacura', 'Los Taques', 'Mauroa', 'Miranda',
      'Palmasola', 'Petit', 'Píritu', 'San Francisco', 'Silva',
      'Sucre', 'Tocópero', 'Unión', 'Urumaco', 'Zamora',
      // Lara (9 municipios)
      'Andrés Eloy Blanco', 'Crespo', 'Iribarren', 'Jiménez', 'Morán',
      'Palavecino', 'Simón Planas', 'Torres', 'Urdaneta',
      // Trujillo (20 municipios)
      'Andrés Bello', 'Boconó', 'Bolívar', 'Candelaria', 'Carache',
      'Carvajal', 'Campo Elías', 'Escuque', 'La Ceiba', 'Márquez Cañizales',
      'Miranda', 'Monte Carmelo', 'Motatán', 'Pampán', 'Pampanito',
      'Rangel', 'Sucre', 'Trujillo', 'Urdaneta', 'Valera'
    ];
  }

  // Default: Zulia (22 municipios)
  return [
    'Almirante Padilla', 'Baralt', 'Cabimas', 'Catatumbo', 'Colón',
    'Francisco Javier Pulgar', 'Indígena Bolivariano Guajira',
    'Jesús Enrique Lossada', 'Jesús María Semprún',
    'La Cañada de Urdaneta', 'Lagunillas', 'Machiques de Perijá',
    'Mara', 'Maracaibo', 'Miranda', 'Páez', 'Rosario de Perijá',
    'San Francisco', 'Santa Rita', 'Simón Bolívar', 'Sucre',
    'Valmore Rodríguez'
  ];
}

// Update map center based on state
function getMapCenter() {
  if (currentState === 'Falcón') return FALCON_CENTER;
  if (currentState === 'Lara') return LARA_CENTER;
  if (currentState === 'Trujillo') return TRUJILLO_CENTER;
  if (currentState === 'Todos') return ALL_STATES_CENTER;
  return ZULIA_CENTER;
}

// Update map zoom based on state
function getMapZoom() {
  if (currentState === 'Todos') return 6;
  return 8;
}

        // Load data from external JSON
        let sampleProjectsData = [];

        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://mrptjbktrcxatnibuhvq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ycHRqYmt0cmN4YXRuaWJ1aHZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzI0OTksImV4cCI6MjA3NzE0ODQ5OX0.5NmNN3AeXs8pL-I_fWb6wgNdaoRbdBi1jvK_6XTvf3Y';

        // Initialize Supabase client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Function to load data from JSON file
        async function loadDataFromJSON() {
            try {
                const response = await fetch('proyectos-zulia-falcon.json');
                if (response.ok) {
                    sampleProjectsData = await response.json();
                    console.log('✓ Data loaded from JSON:', sampleProjectsData.length, 'projects');
                    return true;
                }
            } catch (e) {
                console.warn('Could not load JSON, using fallback...');
            }
            return false;
        }

        // Function to load data from Supabase
        async function loadDataFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('proyectos')
                    .select('*')
                    .in('Estado', ['Zulia', 'Falcón', 'Lara', 'Trujillo']);

                if (error) {
                    console.warn('Supabase error:', error);
                    return false;
                }

                if (data && data.length > 0) {
                    sampleProjectsData = data;
                    console.log('✓ Data loaded from Supabase:', sampleProjectsData.length, 'projects');
                    return true;
                }
            } catch (e) {
                console.warn('Supabase connection error:', e);
            }
            return false;
        }

        // Function to insert projects into Supabase
        async function insertProjectsToSupabase(projects) {
            try {
                if (!projects || projects.length === 0) {
                    console.warn('No projects to insert');
                    return false;
                }

                // Remove id field if exists (will be auto-generated)
                const projectsToInsert = projects.map(p => {
                    const { id, ...rest } = p;
                    return rest;
                });

                const { data, error } = await supabaseClient
                    .from('proyectos')
                    .insert(projectsToInsert)
                    .select();

                if (error) {
                    console.error('Supabase insert error:', error);
                    alert('Error al guardar en Supabase: ' + error.message);
                    return false;
                }

                console.log('✓ Inserted', data.length, 'projects to Supabase');
                return true;
            } catch (e) {
                console.error('Supabase insert error:', e);
                return false;
            }
        }

        // Function to reload data from Supabase
        async function reloadDataFromSupabase() {
            const loaded = await loadDataFromSupabase();
            if (loaded) {
                projectsData = sampleProjectsData;
                expandedData = expandProjectData(projectsData);
                applyFilters();
                initializeCharts();
                updateTable();
                updateMapMarkers();
            }
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            // Try to load data from Supabase first, then fall back to JSON
            const supabaseLoaded = await loadDataFromSupabase();
            if (!supabaseLoaded) {
                await loadDataFromJSON();
            }

            // If no data loaded, show message
            if (sampleProjectsData.length === 0) {
                console.warn('⚠️  No data loaded. Using fallback...');
                // Add fallback data here if needed
            }

            projectsData = sampleProjectsData;

            // Expand data for proper filtering
            expandedData = expandProjectData(projectsData);
            console.log('✓ Loaded', projectsData.length, 'original projects');
            console.log('✓ Expanded to', expandedData.length, 'filterable rows');

            // Setup state selector listeners
            setupStateListeners();

            // Initialize dashboard
            initializeDashboard();
        });

        // Function to setup state radio button listeners
        function setupStateListeners() {
            document.querySelectorAll('input[name="state"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentState = e.target.value;

                    // Update title
                    const stateNames = {
                        'Zulia': 'Zulia',
                        'Falcón': 'Falcón',
                        'Lara': 'Lara',
                        'Trujillo': 'Trujillo',
                        'Todos': 'Zulia, Falcón, Lara y Trujillo'
                    };
                    document.getElementById('stateTitle').textContent = stateNames[currentState];

                    // Update filter indicator in header
                    updateHeaderFilterIndicator();

                    // Update map center and zoom
                    if (map) {
                        map.setView(getMapCenter(), getMapZoom());
                    }

                    // Update municipality list
                    updateMunicipalityList();

                    // Filter data by state and apply other filters
                    filterDataByState();

                    console.log('✓ State changed to:', currentState);
                });
            });
        }

        // Function to update header filter indicator
        function updateHeaderFilterIndicator() {
            const indicator = document.getElementById('filterIndicator');
            const municipios = getSelectedMunicipalities();

            let indicatorText = '';

            if (municipios.length > 0) {
                if (municipios.length === 1) {
                    indicatorText = `📍 ${municipios[0]}`;
                } else {
                    indicatorText = `📍 ${municipios.length} municipios seleccionados`;
                }
            }

            indicator.textContent = indicatorText;
        }

        // Function to filter data by current state
        function filterDataByState() {
            // Just call applyFilters which now handles state filtering
            applyFilters();
        }

        // Function to update municipality list based on state
        function updateMunicipalityList() {
            const municipiosContainer = document.getElementById('municipioDropdown');
            const municipalities = getOfficialMunicipalities();

            municipiosContainer.innerHTML = `
                <div class="multi-select-option">
                    <input type="checkbox" id="all-municipios" checked>
                    <label for="all-municipios">Todos los Municipios</label>
                </div>
            `;

            municipalities.forEach(municipio => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';
                optionDiv.innerHTML = `
                    <input type="checkbox" class="municipio-checkbox" value="${municipio}" checked>
                    <label style="cursor: pointer;">${municipio}</label>
                `;
                municipiosContainer.appendChild(optionDiv);
            });

            console.log('✓ Municipality list updated with', municipalities.length, 'municipalities');

            // Reinitialize event listeners after DOM is updated
            setTimeout(() => {
                setupMunicipalityEventListeners();
            }, 50);
        }

        function setupMunicipalityEventListeners() {
            const dropdown = document.getElementById('municipioDropdown');
            const display = document.getElementById('municipioDisplay');
            const allCheckbox = dropdown.querySelector('#all-municipios');

            if (!display || !dropdown || !allCheckbox) return;

            // Toggle dropdown visibility
            display.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('open');
                display.classList.toggle('open');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.multi-select-container')) {
                    dropdown.classList.remove('open');
                    display.classList.remove('open');
                }
            });

            // Handle "Todos" checkbox - event delegation
            allCheckbox.addEventListener('change', () => {
                const allCheckboxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#all-municipios)');
                allCheckboxes.forEach(cb => {
                    cb.checked = allCheckbox.checked;
                });
                updateMunicipioDisplay();
                applyFilters();
                zoomToSelectedMunicipalities();
            });

            // Handle individual municipality checkboxes - event delegation via dropdown container
            dropdown.addEventListener('change', (e) => {
                if (e.target.classList.contains('municipio-checkbox')) {
                    const allCheckboxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#all-municipios)');
                    const checkedBoxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#all-municipios):checked');

                    // Update "Todos" state based on selections
                    if (checkedBoxes.length === 0) {
                        allCheckbox.checked = false;
                        allCheckbox.indeterminate = false;
                    } else if (checkedBoxes.length === allCheckboxes.length) {
                        allCheckbox.checked = true;
                        allCheckbox.indeterminate = false;
                    } else {
                        allCheckbox.checked = false;
                        allCheckbox.indeterminate = true;
                    }

                    updateMunicipioDisplay();
                    applyFilters();
                    zoomToSelectedMunicipalities();
                }
            });

            console.log('✓ Municipality event listeners initialized');
        }

        function initializeDashboard() {
            console.log('Inicializando dashboard...');

            // Initialize components FIRST
            initializeMap();
            populateFilters();
            createSectorGrid();
            initializeCharts();
            setupEventListeners();

            // Filter by current state (default is Zulia) AFTER components are ready
            filterDataByState();

            // Update displays
            updateKPIs();
            updateTable();
            updateMapMarkers();
            updateCharts();
            updateFooterInfo();

            console.log('Dashboard inicializado correctamente');
        }

        function initializeMap() {
            // Initialize Leaflet map
            map = L.map('map').setView(ZULIA_CENTER, 8);
            
            // Add Mapbox tile layer with OCHA style
            L.tileLayer('https://api.mapbox.com/styles/v1/escenarios/cmd9kqnmv008d01s2fuc4dqe4/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXNjZW5hcmlvcyIsImEiOiJjbWQ5Z2hvOWswODduMmxxMGZvYmV0eXMyIn0.1mIaAW55j4IePp400vyyRA', {
                attribution: '&copy; <a href="https://www.mapbox.com/">Mapbox</a> | &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> | OCHA',
                tileSize: 512,
                zoomOffset: -1
            }).addTo(map);

            // Add a control to recenter map
            const recenterControl = L.Control.extend({
                options: {
                    position: 'topright'
                },
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                    container.style.backgroundColor = 'white';
                    container.style.width = '30px';
                    container.style.height = '30px';
                    container.style.cursor = 'pointer';
                    container.innerHTML = '<i class="fas fa-crosshairs" style="line-height: 30px; text-align: center; display: block; color: #005a8a;"></i>';
                    container.onclick = function() {
                        map.setView(ZULIA_CENTER, 8);
                    };
                    return container;
                }
            });
            
            map.addControl(new recenterControl());
        }

        function initializeCharts() {
            // Initialize Sector Chart (Vertical Bar Chart)
            const sectorCtx = document.getElementById('sectorChart').getContext('2d');
            sectorChart = new Chart(sectorCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Número de Proyectos',
                        data: [],
                        backgroundColor: '#007DBC',
                        borderColor: '#005A8A',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Changed to 'y' for vertical bars
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: { // Changed from y to x for horizontal bars
                            beginAtZero: true,
                            display: false, // Hide horizontal axis completely
                            grid: {
                                display: false
                            }
                        },
                        y: { // Changed from x to y for horizontal bars
                            ticks: {
                                color: '#5A5A5A',
                                maxRotation: 45,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Initialize Time Chart (Doughnut Chart)
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            timeChart = new Chart(timeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['En proyecto', 'En ejecución', 'Terminado'],
                    datasets: [{
                        label: 'Estatus de Proyectos',
                        data: [],
                        backgroundColor: [
                            '#ECA154',    // En proyecto (naranja OCHA)
                            '#007DBC',    // En ejecución (azul OCHA)
                            '#7DBA00'     // Terminado (verde OCHA)
                        ],
                        borderColor: [
                            '#ECA154',
                            '#007DBC', 
                            '#7DBA00'
                        ],
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#5A5A5A',
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return `${context.label}: ${context.parsed} proyectos (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function populateFilters() {
            const orgFilter = document.getElementById('orgFilter');
            const estatusFilter = document.getElementById('estatusFilter');

            // Get unique normalized organization values
            const organizations = [...new Set(
                projectsData.map(p => normalizeOrganizationName(p['Organización Líder']))
                    .filter(Boolean)
            )].sort();

            const statuses = [...new Set(projectsData.map(p => p['Estatus']))].filter(Boolean);

            // Populate organization dropdown
            organizations.sort().forEach(org => {
                const option = document.createElement('option');
                option.value = org;
                option.textContent = org;
                orgFilter.appendChild(option);
            });

            // NOTE: Municipality filter is handled by updateMunicipalityList()
            // which is called when state changes and during dashboard initialization

            // Use normalized status values consistently
            const estatus = ['En proyecto', 'En ejecución', 'Terminado'];
            estatus.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                estatusFilter.appendChild(option);
            });

            // Update municipality list for current state (this will also initialize the multi-select)
            updateMunicipalityList();
        }

        
        function updateMunicipioDisplay() {
            const display = document.getElementById('municipioDisplay');
            const span = display.querySelector('span');
            const allCheckbox = document.getElementById('all-municipios');
            const checkboxes = document.querySelectorAll('#municipioDropdown input[type="checkbox"]:not(#all-municipios):checked');

            if (allCheckbox.checked || checkboxes.length === 0) {
                span.textContent = 'Todos los Municipios';
            } else if (checkboxes.length === 1) {
                span.textContent = checkboxes[0].value;
            } else {
                span.textContent = `${checkboxes.length} municipios seleccionados`;
            }

            // Also update the header filter indicator
            updateHeaderFilterIndicator();
        }
        
        function getSelectedMunicipalities() {
            const allCheckbox = document.getElementById('all-municipios');
            if (allCheckbox.checked) return [];
            
            const checkboxes = document.querySelectorAll('#municipioDropdown input[type="checkbox"]:not(#all-municipios):checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function zoomToSelectedMunicipalities() {
            const selectedMunicipalities = getSelectedMunicipalities();
            
            if (selectedMunicipalities.length === 0) {
                // If no specific municipalities selected, zoom to full state
                map.setView(ZULIA_CENTER, 8);
                return;
            }
            
            // Get coordinates of selected municipalities
            const activeCoords = getActiveCoordinates();
            const validCoordinates = selectedMunicipalities
                .map(municipio => activeCoords[municipio])
                .filter(coords => coords);
            
            if (validCoordinates.length === 0) {
                map.setView(ZULIA_CENTER, 8);
                return;
            }
            
            if (validCoordinates.length === 1) {
                // Zoom to single municipality
                map.setView(validCoordinates[0], 11);
            } else {
                // Fit bounds to all selected municipalities
                const bounds = L.latLngBounds(validCoordinates);
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        function normalizeStatus(status) {
            if (!status || status === 'nan' || status === '' || status === 'NaN') return 'En proyecto';
            
            const statusLower = status.toLowerCase().trim();
            
            // Map to "En ejecución" - including common variations from data
            if (statusLower.includes('ejecución') || statusLower === 'activo' || statusLower.includes('activo') ||
                statusLower.includes('proceso') || statusLower.includes('desarrollo') ||
                statusLower.includes('implementación') || statusLower.includes('iniciando') ||
                statusLower.includes('ejecución') || statusLower.includes('en ejecucion') ||
                statusLower.includes('en ejecución')) {
                return 'En ejecución';
            }
            
            // Map to "Terminado" 
            if (statusLower.includes('finalizando') || statusLower.includes('cierre') ||
                statusLower.includes('terminado') || statusLower.includes('finalizado') ||
                statusLower.includes('completado') || statusLower.includes('próximos al cierre') ||
                statusLower.includes('completado')) {
                return 'Terminado';
            }
            
            // Map to "En proyecto" - including planificado, preparacion, etc.
            if (statusLower.includes('proyecto') || statusLower.includes('planificado') ||
                statusLower.includes('preparación') || statusLower.includes('preparacion') ||
                statusLower.includes('iniciación') || statusLower.includes('iniciacion') ||
                statusLower.includes('diseño') || statusLower.includes('fase de iniciación') ||
                statusLower.includes('planificado')) {
                return 'En proyecto';
            }
            
            // Log unmapped statuses for debugging
            console.log('Unmapped status:', status);
            
            // Default to "En proyecto"
            return 'En proyecto';
        }

        function createSectorGrid() {
            const sectorGrid = document.getElementById('sectorGrid');
            
            humanitarianSectors.forEach(sector => {
                const sectorItem = document.createElement('div');
                sectorItem.className = 'sector-item';
                sectorItem.dataset.sector = sector.id;
                
                sectorItem.innerHTML = `
                    <div class="sector-icon" style="background-image: url('${sector.ochaIcon}');"></div>
                    <div class="sector-name">${sector.name}</div>
                `;
                
                sectorItem.addEventListener('click', () => toggleSectorFilter(sector.id));
                sectorGrid.appendChild(sectorItem);
            });
        }

        function toggleSectorFilter(sectorId) {
            const sectorItem = document.querySelector(`.sector-item[data-sector="${sectorId}"]`);
            
            if (currentFilters.sector === sectorId) {
                // Deselect current sector
                currentFilters.sector = '';
                sectorItem.classList.remove('active');
            } else {
                // Select new sector
                document.querySelectorAll('.sector-item.active').forEach(item => 
                    item.classList.remove('active')
                );
                currentFilters.sector = sectorId;
                sectorItem.classList.add('active');
            }
            
            applyFilters();
        }

        function matchesSector(project, sectorId) {
            if (!sectorId) return true;
            
            const sector = humanitarianSectors.find(s => s.id === sectorId);
            if (!sector) return false;

            const searchText = (
                (project['Área de intervención complementaria'] || '') + ' ' +
                (project['Actividad'] || '') + ' ' +
                (project['Nombre del proyecto'] || '')
            ).toLowerCase();

            // More precise sector matching with exact word boundaries
            return sector.keywords.some(keyword => {
                const keywordLower = keyword.toLowerCase();
                const regex = new RegExp('\\b' + keywordLower + '\\b', 'i');
                return regex.test(searchText);
            });
        }

        function setupEventListeners() {
            const orgFilter = document.getElementById('orgFilter');
            const estatusFilter = document.getElementById('estatusFilter');
            const searchInput = document.getElementById('searchInput');
            const resetFiltersBtn = document.getElementById('resetFilters');
            const dateStart = document.getElementById('dateStart');
            const dateEnd = document.getElementById('dateEnd');
            const modal = document.getElementById('detailModal');
            const modalClose = document.querySelector('.modal-close');

            // Filter event listeners
            [orgFilter, estatusFilter].forEach(filter =>
                filter.addEventListener('change', applyFilters)
            );

            searchInput.addEventListener('input', applyFilters);
            dateStart.addEventListener('change', applyFilters);
            dateEnd.addEventListener('change', applyFilters);

            // Date range slider functionality
            const dateRangeSlider = document.getElementById('dateRangeSlider');
            const sliderMinDate = document.getElementById('sliderMinDate');
            const sliderMaxDate = document.getElementById('sliderMaxDate');

            dateRangeSlider.addEventListener('input', function() {
                const days = parseInt(this.value);
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - days);

                dateStart.value = startDate.toISOString().split('T')[0];
                dateEnd.value = endDate.toISOString().split('T')[0];

                // Update slider labels
                if (days <= 7) {
                    sliderMinDate.textContent = 'Última semana';
                } else if (days <= 30) {
                    sliderMinDate.textContent = 'Último mes';
                } else if (days <= 90) {
                    sliderMinDate.textContent = 'Últimos 3 meses';
                } else if (days <= 180) {
                    sliderMinDate.textContent = 'Últimos 6 meses';
                } else {
                    sliderMinDate.textContent = 'Último año';
                }

                applyFilters();
            });

            // Re-apply filters when municipality filter changes to handle zoom

            // Reset filters
            resetFiltersBtn.addEventListener('click', () => {
                orgFilter.value = '';
                // Reset municipality multi-select
                const allCheckbox = document.getElementById('all-municipios');
                const municipioCheckboxes = document.querySelectorAll('#municipioDropdown input[type="checkbox"]:not(#all-municipios)');
                allCheckbox.checked = true;
                municipioCheckboxes.forEach(cb => cb.checked = false);
                updateMunicipioDisplay();
                estatusFilter.value = '';
                searchInput.value = '';
                dateStart.value = '';
                dateEnd.value = '';
                currentFilters = {
                    org: '', municipio: [], estatus: '', search: '', 
                    sector: '', dateStart: '', dateEnd: ''
                };
                document.querySelectorAll('.sector-item.active').forEach(item => 
                    item.classList.remove('active')
                );
                applyFilters();
                map.setView(ZULIA_CENTER, 8); // Reset map view on filter reset
            });

            // Export functionality (only filtered exports since header buttons were removed)
            document.getElementById('exportFilteredExcel').addEventListener('click', () => exportToExcel(filteredData, 'proyectos_filtrados'));
            document.getElementById('exportFilteredPdf').addEventListener('click', () => exportToPDF(filteredData, 'proyectos_filtrados'));

            // Modal close
            modalClose.addEventListener('click', () => modal.classList.remove('active'));
            window.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('active');
            });
        }

        function applyFilters() {
            // Update filter values
            currentFilters.org = document.getElementById('orgFilter').value;
            currentFilters.municipio = getSelectedMunicipalities();
            currentFilters.estatus = document.getElementById('estatusFilter').value;
            currentFilters.search = document.getElementById('searchInput').value.toLowerCase();
            currentFilters.dateStart = document.getElementById('dateStart').value;
            currentFilters.dateEnd = document.getElementById('dateEnd').value;


            // Filter expanded data, respecting state filter
            let dataToFilter = expandedData;

            // First filter by state if not "Todos" (Todos means all states)
            if (currentState !== 'Todos') {
                dataToFilter = expandedData.filter(p => p['Estado'] === currentState);
            }

            // Then apply other filters
            filteredData = dataToFilter.filter(project => {
                // Organization filter - use normalized names
                if (currentFilters.org) {
                    const normalizedOrgLeader = normalizeOrganizationName(project['Organización Líder']);
                    if (normalizedOrgLeader !== currentFilters.org) {
                        return false;
                    }
                }

                // Municipality filter - exact match only to distinguish "Mara" from "Maracaibo"
                if (currentFilters.municipio && currentFilters.municipio.length > 0) {
                    const projectMunicipality = project['Municipio'];

                    // Check if project municipality matches any selected municipality
                    const hasMatch = currentFilters.municipio.some(filterMunicipio => {
                        // Exact match first
                        if (projectMunicipality === filterMunicipio) {
                            return true;
                        }
                        // Case-insensitive fallback
                        if (projectMunicipality && filterMunicipio &&
                            projectMunicipality.toLowerCase().trim() === filterMunicipio.toLowerCase().trim()) {
                            return true;
                        }
                        return false;
                    });

                    if (!hasMatch) {
                        return false;
                    }
                }

                // Status filter
                if (currentFilters.estatus && normalizeStatus(project['Estatus']) !== currentFilters.estatus) {
                    return false;
                }

                // Search filter - comprehensive and intelligent
                if (currentFilters.search) {
                    const searchableText = (
                        (project['Organización Líder'] || '') + ' ' +
                        (project['Organización implementadora'] || '') + ' ' +
                        (project['Nombre del proyecto'] || '') + ' ' +
                        (project['Área de intervención complementaria'] || '') + ' ' +
                        (project['Actividad'] || '') + ' ' +
                        (project['Municipio'] || '') + ' ' +
                        (project['Parroquias'] || '') + ' ' +
                        normalizeStatus(project['Estatus'] || '')
                    ).toLowerCase();
                    
                    // Split search terms and check if all terms are present
                    const searchTerms = currentFilters.search.split(/\s+/).filter(term => term.length > 0);
                    const allTermsMatch = searchTerms.every(term => 
                        searchableText.includes(term.toLowerCase())
                    );
                    
                    if (!allTermsMatch) {
                        return false;
                    }
                }

                // Sector filter - works with expanded areas
                if (currentFilters.sector) {
                    const areas = project._expandedAreas || [project['Área de intervención complementaria']];
                    const matchesAnySector = areas.some(area => {
                        if (!area) return false;
                        const sector = humanitarianSectors.find(s => s.id === currentFilters.sector);
                        if (!sector) return false;
                        return sector.keywords.some(keyword => {
                            const regex = new RegExp('\\b' + keyword + '\\b', 'i');
                            return regex.test(area.toLowerCase());
                        });
                    });
                    if (!matchesAnySector) return false;
                }

                // Date filters
                if (currentFilters.dateStart || currentFilters.dateEnd) {
                    const projectStart = new Date(project['Fecha de Inicio']);
                    const projectEnd = new Date(project['Fecha Prevista de Finalización']);
                    const filterStart = currentFilters.dateStart ? new Date(currentFilters.dateStart) : null;
                    const filterEnd = currentFilters.dateEnd ? new Date(currentFilters.dateEnd) : null;

                    if (filterStart && projectEnd < filterStart) return false;
                    if (filterEnd && projectStart > filterEnd) return false;
                }

                return true;
            });


            // Update components
            updateKPIs();
            updateTable();
            updateMapMarkers();
            updateCharts();
        }

        // Helper function to extract and normalize municipality names
        function extractAndNormalizeMunicipalities(municipioString) {
            if (!municipioString || typeof municipioString !== 'string') {
                return [];
            }

            // Official list of municipalities in Zulia (22) and Falcón (17)
            const officialMunicipalities = [
                // Zulia (22)
                'Almirante Padilla', 'Baralt', 'Cabimas', 'Catatumbo', 'Colón',
                'Francisco Javier Pulgar', 'Indígena Bolivariano Guajira',
                'Jesús Enrique Lossada', 'Jesús María Semprún', 'La Cañada de Urdaneta',
                'Lagunillas', 'Machiques de Perijá', 'Mara', 'Maracaibo', 'Miranda',
                'Páez', 'Rosario de Perijá', 'San Francisco', 'Santa Rita',
                'Simón Bolívar', 'Sucre', 'Valmore Rodríguez',
                // Falcón (17)
                'Acosta', 'Cacique Manaure', 'Carirubana', 'Colina', 'Democracia',
                'Falcón', 'Iturriza', 'Mauroa', 'Palmasola', 'Píritu',
                'Silva', 'Tocópero', 'Urumaco', 'Zamora'
            ];

            // Comprehensive mapping with variations
            const municipalityMapping = {
                'almirante padilla': 'Almirante Padilla',
                'baralt': 'Baralt',
                'cabimas': 'Cabimas',
                'catatumbo': 'Catatumbo',
                'colon': 'Colón',
                'colón': 'Colón',
                'francisco javier pulgar': 'Francisco Javier Pulgar',
                'indígena bolivariano guajira': 'Indígena Bolivariano Guajira',
                'indigena bolivariano guajira': 'Indígena Bolivariano Guajira',
                'guajira': 'Indígena Bolivariano Guajira',
                'jesus enrique lossada': 'Jesús Enrique Lossada',
                'jesús enrique lossada': 'Jesús Enrique Lossada',
                'jesus maría semprun': 'Jesús María Semprún',
                'jesús maría semprún': 'Jesús María Semprún',
                'jesus maría semprún': 'Jesús María Semprún',
                'jesus maria semprun': 'Jesús María Semprún',
                'la cañada de urdaneta': 'La Cañada de Urdaneta',
                'la canada de urdaneta': 'La Cañada de Urdaneta',
                'lagunillas': 'Lagunillas',
                'ciudad ojeda': 'Lagunillas',
                'machiques de perijá': 'Machiques de Perijá',
                'machiques de perija': 'Machiques de Perijá',
                'machiques': 'Machiques de Perijá',
                'mara': 'Mara',
                'maracaibo': 'Maracaibo',
                'miranda': 'Miranda',
                'paez': 'Páez',
                'páez': 'Páez',
                'rosario de perijá': 'Rosario de Perijá',
                'rosario de perija': 'Rosario de Perijá',
                'san francisco': 'San Francisco',
                'santa rita': 'Santa Rita',
                'simon bolivar': 'Simón Bolívar',
                'simón bolivar': 'Simón Bolívar',
                'sucre': 'Sucre',
                'valmore rodriguez': 'Valmore Rodríguez',
                'valmore rodríguez': 'Valmore Rodríguez',
                // Falcón municipalities
                'acosta': 'Acosta',
                'cacique manaure': 'Cacique Manaure',
                'carirubana': 'Carirubana',
                'colina': 'Colina',
                'democracia': 'Democracia',
                'falcón': 'Falcón',
                'falcon': 'Falcón',
                'iturriza': 'Iturriza',
                'mauroa': 'Mauroa',
                'palmasola': 'Palmasola',
                'píritu': 'Píritu',
                'piritu': 'Píritu',
                'silva': 'Silva',
                'tocópero': 'Tocópero',
                'tocopero': 'Tocópero',
                'urumaco': 'Urumaco',
                'zamora': 'Zamora'
            };

            // Split by semicolon and clean
            let municipalities = municipioString.split(';')
                .map(m => m.trim())
                .filter(m => m && m.length > 2); // Filter out very short strings

            // Normalize each municipality
            const normalized = [];
            const seen = new Set();

            municipalities.forEach(m => {
                let name = m.toLowerCase().trim();

                // Filter out invalid municipalities
                if (name === 'sin definir' || name === 'no especificado' || name === 'n/a' || name === 'nan') {
                    return; // Skip invalid municipalities
                }

                // Remove prefixes
                name = name.replace(/^municipio\s+/i, '');
                name = name.replace(/^bolivariano\s+/i, '');

                // Try to match with mapping
                const mapped = municipalityMapping[name];
                if (mapped && !seen.has(mapped)) {
                    normalized.push(mapped);
                    seen.add(mapped);
                } else if (!mapped) {
                    // Check if it's in the official list (case-insensitive)
                    const officialMatch = officialMunicipalities.find(
                        om => om.toLowerCase() === name
                    );
                    if (officialMatch && !seen.has(officialMatch)) {
                        normalized.push(officialMatch);
                        seen.add(officialMatch);
                    }
                }
            });

            return normalized;
        }

        // Helper function to normalize organization names
        function normalizeOrganizationName(orgName) {
            if (!orgName || typeof orgName !== 'string') {
                return null;
            }
            
            let name = orgName.trim();
            
            // Handle empty or invalid organization names
            if (name === '' || name.toLowerCase() === 'nan' || name === 'No especificado') {
                return null;
            }
            
            // Mapping based on CSV data analysis for common variations
            const organizationMapping = {
                // Leading organizations from CSV
                'A. C Concentroccidente': 'CONCENTROCCIDENTE',
                'ACEAM': 'ACEAM',
                'ACNUR': 'ACNUR',
                'ASONACOP': 'ASONACOP',
                'ASociacion civil ATRAVEZANDO': 'ATRAVEZANDO',
                'AZUL POSITIVO': 'AZUL POSITIVO',
                'Acción Campesina': 'ACCIÓN CAMPESINA',
                'Acción contra el Hambre': 'ACCIÓN CONTRA EL HAMBRE',
                'Asociacion civil ATRAVEZANDO': 'ATRAVEZANDO',
                'CARITAS VENEZUELA': 'CÁRITAS VENEZUELA',
                'CESVI': 'CESVI',
                'CIR': 'CIR',
                'CIR VENEZUELA': 'CIR',
                'CIR Venezuela': 'CIR',
                'Consejo Noruego para Refugiados': 'NRC',
                'DRC': 'DRC',
                'ECHO': 'ECHO',
                'ECHO- Caritas Suiza': 'ECHO-CÁRITAS SUIZA',
                'FAO': 'FAO',
                'FUDEP': 'FUDEP',
                'Funvape': 'FUNVAPE',
                'Grupo Social Cesap': 'CESAP',
                'HIAS VENEZUELA': 'HIAS',
                'HIAS-ALIADAS': 'HIAS-ALIADAS',
                'Malteser': 'MALTESER',
                'NRC': 'NRC',
                'Nuevo Amanecer': 'NUEVO AMANECER',
                'OIM': 'OIM',
                'PALUZ': 'PALUZ',
                'PALUZ-ALIADAS': 'PALUZ-ALIADAS',
                'Save The Children': 'SAVE THE CHILDREN',
                'Save the Children': 'SAVE THE CHILDREN',
                'Save the Children Venezuela': 'SAVE THE CHILDREN',
                'Servicio Jesuita a Refugiados; Venezuela': 'SJR VENEZUELA',
                'UNFPA': 'UNFPA',
                'UNICEF': 'UNICEF',
                'UNICEF 2021': 'UNICEF'
            };
            
            return organizationMapping[name] || name;
        }

        function updateKPIs() {
            const kpiContainer = document.getElementById('kpiContainer');
            
            // Real data limits based on CSV analysis (actual unique counts from data)
            const REAL_DATA_LIMITS = {
                projects: 99, // From CSV: total project entries
                leaders: 19, // From CSV: actual unique leading organizations  
                municipalities: 19, // From CSV: actual unique municipalities
                implementers: 48 // From CSV: actual unique implementing organizations
            };
            
            // Calculate unique projects by extracting base code (without correlativo suffix)
            // Example: PRJ002-1, PRJ002-2 → PRJ002 (counts as 1 unique project)
            // This handles the correlativo structure used to avoid unique constraint violations
            const uniqueFilteredProjects = new Set(
                filteredData
                    .map(p => {
                        const code = p['Código del proyecto'];
                        if (!code || code.trim() === '') return null;

                        // Extract base code by removing correlativo suffix (-1, -2, -3, etc.)
                        // Matches pattern like PRJ002-1 and extracts PRJ002
                        const baseCode = code.replace(/-\d+$/, '');
                        return baseCode;
                    })
                    .filter(code => code !== null)
            );
            const totalProjects = uniqueFilteredProjects.size;

            // Calculate unique leader organizations from filtered unique projects with normalization
            const filteredLeaderOrgs = new Set();
            // Get unique projects by base code (without correlativo)
            const uniqueProjectsArray = filteredData.filter(p => {
                const code = p['Código del proyecto'];
                const baseCode = code ? code.replace(/-\d+$/, '') : '';
                return baseCode && uniqueFilteredProjects.has(baseCode);
            });
            // Use a Map to get one project per unique base code
            const projectsByCode = new Map();
            uniqueProjectsArray.forEach(p => {
                const code = p['Código del proyecto'];
                const baseCode = code ? code.replace(/-\d+$/, '') : '';
                if (!projectsByCode.has(baseCode)) {
                    projectsByCode.set(baseCode, p);
                }
            });
            const uniqueProjectsList = Array.from(projectsByCode.values());

            uniqueProjectsList.forEach(p => {
                const leader = p['Organización Líder'];
                const normalizedLeader = normalizeOrganizationName(leader);
                if (normalizedLeader) {
                    filteredLeaderOrgs.add(normalizedLeader);
                }
            });
            const totalOrganizations = filteredLeaderOrgs.size;

            // Calculate unique municipalities from filtered data with proper normalization
            const filteredMunicipalities = new Set();
            filteredData.forEach(p => {
                const municipio = p['Municipio'];
                if (municipio && municipio !== 'N/A' && municipio.trim() !== '' && municipio !== 'No especificado') {
                    // For already expanded data, just add the municipality
                    filteredMunicipalities.add(municipio);
                }
            });
            const totalMunicipalities = filteredMunicipalities.size;

            // Calculate implementing organizations from filtered unique projects with normalization
            const filteredImplementingOrgs = new Set();
            uniqueProjectsList.forEach(p => {
                const implOrg = p['Organización implementadora'];
                if (implOrg && implOrg !== 'N/A' && implOrg !== '' && implOrg !== null && implOrg.toLowerCase() !== 'nan') {
                    // Handle multiple organizations separated by semicolon
                    if (implOrg.includes(';')) {
                        implOrg.split(';').forEach(org => {
                            const normalizedOrg = normalizeOrganizationName(org.trim());
                            if (normalizedOrg) {
                                filteredImplementingOrgs.add(normalizedOrg);
                            }
                        });
                    } else {
                        const normalizedOrg = normalizeOrganizationName(implOrg.trim());
                        if (normalizedOrg) {
                            filteredImplementingOrgs.add(normalizedOrg);
                        }
                    }
                }
            });
            const totalImplementingOrgs = filteredImplementingOrgs.size;

            kpiContainer.innerHTML = `
                <div class="kpi-card">
                    <i class="fas fa-project-diagram kpi-icon"></i>
                    <div class="kpi-value">${totalProjects}</div>
                    <div class="kpi-label">Proyectos</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-users kpi-icon"></i>
                    <div class="kpi-value">${totalOrganizations}</div>
                    <div class="kpi-label">Org. Líderes</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-map-marked-alt kpi-icon"></i>
                    <div class="kpi-value">${totalMunicipalities}</div>
                    <div class="kpi-label">Municipios</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-handshake kpi-icon"></i>
                    <div class="kpi-value">${totalImplementingOrgs}</div>
                    <div class="kpi-label">Org. Implementadoras</div>
                </div>
            `;
        }

        function updateTable() {
            const tableHeaders = document.getElementById('tableHeaders');
            const tableBody = document.getElementById('projectsTableBody');

            // Clear existing content
            tableHeaders.innerHTML = '';
            tableBody.innerHTML = '';

            // Define headers
            const headers = [
                { key: 'select', text: '', type: 'checkbox' },
                { key: 'org', text: 'Organización Líder', type: 'text' }, 
                { key: 'project', text: 'Nombre del proyecto', type: 'text' }, 
                { key: 'municipality', text: 'Municipio', type: 'text' }, 
                { key: 'status', text: 'Estatus', type: 'text' },
                { key: 'startDate', text: 'Fecha Inicio', type: 'text' },
                { key: 'endDate', text: 'Fecha Fin', type: 'text' },
                { key: 'actions', text: 'Acciones', type: 'text' }
            ];

            // Create header row
            headers.forEach(header => {
                const th = document.createElement('th');
                if (header.type === 'checkbox') {
                    th.innerHTML = `
                        <input type="checkbox" id="selectAll" style="cursor: pointer;">
                        <label for="selectAll" style="cursor: pointer; margin-left: 5px;">Todos</label>
                    `;
                } else if (header.key === 'actions') {
                    th.textContent = header.text;
                } else {
                    th.className = 'sortable-header';
                    th.innerHTML = `${header.text}<span class="sort-indicator" data-sort="${header.key}"></span>`;
                    th.addEventListener('click', () => toggleSort(header.key));
                }
                tableHeaders.appendChild(th);
            });

            // Get unique projects from filtered expanded data for table display
            const uniqueFilteredProjects = new Map();
            filteredData.forEach(expandedProject => {
                if (expandedProject._originalIndex !== undefined) {
                    const originalProject = projectsData[expandedProject._originalIndex];
                    // Collect all municipalities that match the filter for this project
                    if (!uniqueFilteredProjects.has(expandedProject._originalIndex)) {
                        uniqueFilteredProjects.set(expandedProject._originalIndex, {
                            ...originalProject,
                            _matchedMunicipalities: []
                        });
                    }
                    uniqueFilteredProjects.get(expandedProject._originalIndex)._matchedMunicipalities.push(expandedProject['Municipio']);
                }
            });
            
            const uniqueProjectsArray = Array.from(uniqueFilteredProjects.values());
            
            // Create data rows
            if (uniqueProjectsArray.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = headers.length;
                cell.style.textAlign = 'center';
                cell.style.padding = '2rem';
                cell.style.color = '#666';
                cell.innerHTML = '<i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>No se encontraron proyectos que coincidan con los filtros aplicados.';
                return;
            }

            uniqueProjectsArray.forEach((project, index) => {
                const row = tableBody.insertRow();
                row.dataset.projectIndex = index;
                
                // Checkbox
                const checkboxCell = row.insertCell();
                checkboxCell.innerHTML = `<input type="checkbox" class="project-checkbox" data-index="${index}" style="cursor: pointer;">`;
                
                // Organization
                const orgCell = row.insertCell();
                orgCell.textContent = project['Organización Líder'] || 'N/A';
                
                // Project name
                const nameCell = row.insertCell();
                nameCell.textContent = project['Nombre del proyecto'] || 'N/A';
                nameCell.style.maxWidth = '300px';
                nameCell.title = project['Nombre del proyecto'] || 'N/A';
                
                // Municipality - show matched municipalities or original, properly normalized
                const munCell = row.insertCell();
                let displayMunicipalities;
                if (project._matchedMunicipalities && project._matchedMunicipalities.length > 0) {
                    // Use matched municipalities from filter
                    displayMunicipalities = [...new Set(project._matchedMunicipalities)].join('; ');
                } else {
                    // Extract and normalize from original data
                    const municipalities = extractAndNormalizeMunicipalities(project['Municipio']);
                    displayMunicipalities = municipalities.length > 0 ? municipalities.join('; ') : 'N/A';
                }
                munCell.textContent = displayMunicipalities;
                munCell.title = displayMunicipalities; // Add tooltip for long names
                
                // Status
                const statusCell = row.insertCell();
                const status = normalizeStatus(project['Estatus']) || 'N/A';
                statusCell.innerHTML = `<span class="status-${status.toLowerCase().replace(/\s+/g, '-')}">${status}</span>`;
                
                // Start date
                const dateCell = row.insertCell();
                const startDate = project['Fecha de Inicio'];
                dateCell.textContent = startDate ? new Date(startDate).toLocaleDateString('es-ES') : 'N/A';
                
                // End date
                const endDateCell = row.insertCell();
                const endDate = project['Fecha Prevista de Finalización'];
                endDateCell.textContent = endDate ? new Date(endDate).toLocaleDateString('es-ES') : 'N/A';
                
                // Actions
                const actionsCell = row.insertCell();
                let projectIndex;
                if (project._originalIndex !== undefined) {
                    projectIndex = project._originalIndex;
                } else {
                    // Find the project in the original data
                    projectIndex = projectsData.findIndex(p => 
                        p['Nombre del proyecto'] === project['Nombre del proyecto'] && 
                        p['Organización Líder'] === project['Organización Líder']
                    );
                }
                actionsCell.innerHTML = `
                    <div class="actions-container">
                        <button class="action-btn primary" onclick="showProjectDetails(${projectIndex})" title="Ver detalles del proyecto">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        <button class="action-btn secondary" onclick="editProject(${projectIndex})" title="Editar proyecto">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="action-btn danger" onclick="deleteProject(${projectIndex})" title="Eliminar proyecto">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                `;
            });

            // Add checkbox functionality
            initializeCheckboxFunctionality();
        }

        function initializeCheckboxFunctionality() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const projectCheckboxes = document.querySelectorAll('.project-checkbox');

            // Select All functionality
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    projectCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateCheckboxState();
                });
            }

            // Individual checkbox functionality
            projectCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateCheckboxState();
                });
            });
        }

        function updateCheckboxState() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const projectCheckboxes = document.querySelectorAll('.project-checkbox');
            const checkedBoxes = document.querySelectorAll('.project-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const selectedCount = document.getElementById('selectedCount');

            if (selectAllCheckbox) {
                if (checkedBoxes.length === 0) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = false;
                } else if (checkedBoxes.length === projectCheckboxes.length) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.indeterminate = true;
                    selectAllCheckbox.checked = false;
                }
            }

            // Show/hide delete button based on selection
            if (deleteBtn) {
                if (checkedBoxes.length > 0) {
                    deleteBtn.style.display = 'inline-flex';
                    selectedCount.textContent = checkedBoxes.length;
                } else {
                    deleteBtn.style.display = 'none';
                }
            }
        }

        function getSelectedProjects() {
            const checkedBoxes = document.querySelectorAll('.project-checkbox:checked');
            return Array.from(checkedBoxes).map(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                return filteredData[index];
            });
        }

        // Sorting state
        let currentSort = { key: null, direction: null };

        function toggleSort(sortKey) {
            // Update sort state
            if (currentSort.key === sortKey) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = sortKey;
                currentSort.direction = 'asc';
            }

            // Sort filteredData
            filteredData.sort((a, b) => {
                let aValue, bValue;
                
                switch(sortKey) {
                    case 'org':
                        aValue = (a['Organización Líder'] || '').toLowerCase();
                        bValue = (b['Organización Líder'] || '').toLowerCase();
                        break;
                    case 'project':
                        aValue = (a['Nombre del proyecto'] || '').toLowerCase();
                        bValue = (b['Nombre del proyecto'] || '').toLowerCase();
                        break;
                    case 'municipality':
                        aValue = (a['Municipio'] || '').toLowerCase();
                        bValue = (b['Municipio'] || '').toLowerCase();
                        break;
                    case 'status':
                        aValue = normalizeStatus(a['Estatus']).toLowerCase();
                        bValue = normalizeStatus(b['Estatus']).toLowerCase();
                        break;
                    case 'startDate':
                        aValue = a['Fecha de Inicio'] ? new Date(a['Fecha de Inicio']) : new Date(0);
                        bValue = b['Fecha de Inicio'] ? new Date(b['Fecha de Inicio']) : new Date(0);
                        break;
                    case 'endDate':
                        aValue = a['Fecha Prevista de Finalización'] ? new Date(a['Fecha Prevista de Finalización']) : new Date(0);
                        bValue = b['Fecha Prevista de Finalización'] ? new Date(b['Fecha Prevista de Finalización']) : new Date(0);
                        break;
                    default:
                        return 0;
                }

                if (aValue < bValue) {
                    return currentSort.direction === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return currentSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });

            // Update sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.className = 'sort-indicator';
            });
            
            const currentIndicator = document.querySelector(`[data-sort="${sortKey}"]`);
            if (currentIndicator) {
                currentIndicator.className = `sort-indicator ${currentSort.direction}`;
            }

            // Re-render table
            updateTable();
        }

        // Enhanced action functions
        function exportProjectToCSV(projectIndex) {
            const project = filteredData[projectIndex];
            if (!project) return;

            const csvData = [
                ['Campo', 'Valor'],
                ['Organización Líder', project['Organización Líder'] || ''],
                ['Organización implementadora', project['Organización implementadora'] || ''],
                ['Nombre del proyecto', project['Nombre del proyecto'] || ''],
                ['Área de intervención', project['Área de intervención complementaria'] || ''],
                ['Actividad', project['Actividad'] || ''],
                ['Municipio', project['Municipio'] || ''],
                ['Parroquias', project['Parroquias'] || ''],
                ['Estatus', normalizeStatus(project['Estatus']) || ''],
                ['Fecha de Inicio', project['Fecha de Inicio'] || ''],
                ['Fecha de Finalización', project['Fecha Prevista de Finalización'] || '']
            ];

            const csvContent = csvData.map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `proyecto_${(project['Nombre del proyecto'] || 'sin_nombre').replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
            link.click();
        }

        function copyProjectLink(projectIndex) {
            const project = filteredData[projectIndex];
            if (!project) return;

            const projectId = projectsData.indexOf(project);
            const currentUrl = window.location.href.split('#')[0];
            const projectLink = `${currentUrl}#proyecto=${projectId}`;

            navigator.clipboard.writeText(projectLink).then(() => {
                // Show success message
                showToast('Enlace copiado al portapapeles', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = projectLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Enlace copiado al portapapeles', 'success');
            });
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? 'var(--ocha-green)' : 'var(--ocha-blue)'};
                color: white;
                border-radius: 6px;
                z-index: 10000;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Add CSS animations for toast
        const toastStyle = document.createElement('style');
        toastStyle.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(toastStyle);

        function updateMapMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Group projects by municipality using expanded data (each row already has single municipality)
            const projectsByMunicipality = {};
            const uniqueProjectIndices = new Set();
            
            console.log('UpdateMapMarkers: filteredData length:', filteredData.length);
            
            filteredData.forEach(expandedProject => {
                const municipio = expandedProject['Municipio'];
                const originalIndex = expandedProject._originalIndex;
                
                console.log('Processing municipality:', municipio, 'originalIndex:', originalIndex);
                
                if (municipio && originalIndex !== undefined) {
                    if (!projectsByMunicipality[municipio]) {
                        projectsByMunicipality[municipio] = new Set();
                    }
                    // Use original project data but track which municipalities are represented
                    projectsByMunicipality[municipio].add(originalIndex);
                    uniqueProjectIndices.add(originalIndex);
                }
            });
            
            console.log('Municipalities found:', Object.keys(projectsByMunicipality));
            console.log('Total unique municipalities:', Object.keys(projectsByMunicipality).length);
            
            // Convert sets to arrays with original project data
            Object.keys(projectsByMunicipality).forEach(municipio => {
                projectsByMunicipality[municipio] = Array.from(projectsByMunicipality[municipio])
                    .map(index => projectsData[index]);
            });

            // Add markers for filtered projects with proportional sizing
            const activeCoords = getActiveCoordinates();
            Object.keys(projectsByMunicipality).forEach(municipio => {
                const coords = activeCoords[municipio];
                const projectsInMunicipio = projectsByMunicipality[municipio];

                // Debug missing coordinates
                if (!coords) {
                    console.warn(`Missing coordinates for municipality: "${municipio}"`);
                }
                
                if (coords && projectsInMunicipio.length > 0) {
                    // Calculate marker size based on number of projects (min 6, max 20)
                    const markerSize = Math.min(Math.max(6 + projectsInMunicipio.length * 2, 6), 20);
                    
                    // Determine primary status (most common)
                    const statusCounts = {};
                    projectsInMunicipio.forEach(p => {
                        const status = p['Estatus'] || 'N/A';
                        statusCounts[status] = (statusCounts[status] || 0) + 1;
                    });
                    const primaryStatus = Object.keys(statusCounts).reduce((a, b) => 
                        statusCounts[a] > statusCounts[b] ? a : b
                    );

                    let color = '#005a8a'; // Default blue
                    // Use normalized status for consistent coloring
                    const normalizedPrimaryStatus = normalizeStatus(primaryStatus);
                    switch (normalizedPrimaryStatus.toLowerCase()) {
                        case 'en ejecución':
                        case 'en ejecucion':
                            color = '#007DBC'; // OCHA Blue
                            break;
                        case 'en proyecto':
                            color = '#ECA154'; // OCHA Orange
                            break;
                        case 'terminado':
                            color = '#7DBA00'; // OCHA Green
                            break;
                        default:
                            color = '#5A5A5A'; // OCHA Gray for unknown status
                            break;
                    }

                    const marker = L.circleMarker(coords, {
                        radius: markerSize,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    // Create popup content with project summary
                    const organizations = [...new Set(projectsInMunicipio.map(p => p['Organización Líder']))];
                    const sectors = [...new Set(projectsInMunicipio.map(p => p['Área de intervención complementaria']))];
                    
                    const popupContent = `
                        <div style="max-width: 300px;">
                            <h4 style="color: var(--ocha-blue); margin-bottom: 0.5rem;">${municipio}</h4>
                            <p><strong>Proyectos:</strong> ${projectsInMunicipio.length}</p>
                            <p><strong>Organizaciones:</strong> ${organizations.length}</p>
                            <p><strong>Sectores:</strong> ${sectors.length}</p>
                            <p><strong>Estatus Principal:</strong> <span class="status-${normalizeStatus(primaryStatus).toLowerCase().replace(/\s+/g, '-')}">${normalizeStatus(primaryStatus)}</span></p>
                            ${projectsInMunicipio.slice(0, 3).map((p, idx) => `
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; font-size: 0.85rem;">
                                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-circle" style="font-size: 0.6rem; color: ${getStatusColor(p['Estatus'])};"></i>
                                        <strong>${p['Nombre del proyecto'] || 'Sin nombre'}</strong>
                                    </span>
                                    <small>${p['Organización Líder'] || 'N/A'}</small>
                                    <button class="btn btn-primary btn-sm" style="margin-top: 0.5rem; font-size: 0.7rem; padding: 0.2rem 0.5rem;" onclick="showProjectDetails(${projectsData.indexOf(p)})">Ver Detalles</button>
                                </div>
                            `).join('')}
                            ${projectsInMunicipio.length > 3 ? `<p style="margin-top: 0.5rem; font-size: 0.85rem; font-style: italic;">y ${projectsInMunicipio.length - 3} más...</p>` : ''}
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    markers.push(marker);
                }
            });
        }

        function updateCharts() {
            updateSectorChart();
            updateTimeChart();
        }

        function updateSectorChart() {
            // Count unique projects by sector from filtered data
            const sectorCounts = {};
            const uniqueProjects = new Map();
            
            // Get unique projects from filtered expanded data
            filteredData.forEach(expandedProject => {
                if (expandedProject._originalIndex !== undefined) {
                    uniqueProjects.set(expandedProject._originalIndex, projectsData[expandedProject._originalIndex]);
                }
            });
            
            // Count sectors from unique projects
            uniqueProjects.forEach(project => {
                const areas = project['Área de intervención complementaria'] || 'Sin clasificar';
                const areaList = areas.includes(';') ? areas.split(';').map(a => a.trim()) : [areas];
                
                areaList.forEach(area => {
                    // Try to match to humanitarian sectors
                    let matchedSector = null;
                    for (const sector of humanitarianSectors) {
                        if (sector.keywords.some(keyword => 
                            area.toLowerCase().includes(keyword.toLowerCase())
                        )) {
                            matchedSector = sector;
                            break;
                        }
                    }
                    
                    const sectorKey = matchedSector ? matchedSector.id : 'sin-clasificar';
                    if (!sectorCounts[sectorKey]) {
                        sectorCounts[sectorKey] = {
                            count: 0,
                            sector: matchedSector || { 
                                id: 'sin-clasificar', 
                                name: 'Sin clasificar', 
                                shortName: 'Sin Clasificar',
                                ochaIcon: null 
                            }
                        };
                    }
                    sectorCounts[sectorKey].count++;
                });
            });

            // Sort sectors by count and take top 8
            const sortedSectors = Object.values(sectorCounts)
                .sort((a, b) => b.count - a.count)
                .slice(0, 8);

            // Update chart with abbreviated sector names
            sectorChart.data.labels = sortedSectors.map(item => item.sector.shortName || 'N/A');
            sectorChart.data.datasets[0].data = sortedSectors.map(item => item.count);
            
            sectorChart.update();
        }

        function updateTimeChart() {
            // Count unique projects by normalized status - must match filter options exactly
            const statusCounts = {
                'En proyecto': 0,
                'En ejecución': 0,
                'Terminado': 0
            };
            
            const uniqueProjects = new Map();
            
            // Get unique projects from filtered expanded data
            filteredData.forEach(expandedProject => {
                if (expandedProject._originalIndex !== undefined) {
                    uniqueProjects.set(expandedProject._originalIndex, projectsData[expandedProject._originalIndex]);
                }
            });
            
            // Count status from unique projects
            uniqueProjects.forEach(project => {
                const normalizedStatus = normalizeStatus(project['Estatus']);
                // Ensure we're using exact same values as filter dropdown
                if (statusCounts.hasOwnProperty(normalizedStatus)) {
                    statusCounts[normalizedStatus]++;
                } else {
                    // Log for debugging and default to En proyecto
                    console.warn('Unmapped status in chart:', project['Estatus'], 'normalized to:', normalizedStatus);
                    statusCounts['En proyecto']++;
                }
            });

            const totalProjects = uniqueProjects.size;
            const data = Object.values(statusCounts);
            
            // Calculate percentages for tooltips
            const percentages = data.map(count => totalProjects > 0 ? ((count / totalProjects) * 100).toFixed(1) : 0);

            // Update chart with percentages in tooltips
            timeChart.data.datasets[0].data = data;
            timeChart.options.plugins.tooltip.callbacks.label = function(context) {
                const label = context.label || '';
                const value = context.parsed;
                const percentage = percentages[context.dataIndex];
                return `${label}: ${value} proyectos (${percentage}%)`;
            };
            timeChart.update();
        }

        function showProjectDetails(index) {
            console.log('showProjectDetails called with index:', index);
            
            if (!projectsData || index >= projectsData.length || index < 0) {
                console.error('Invalid project index:', index);
                alert('Error: No se puede mostrar el detalle del proyecto');
                return;
            }
            
            const project = projectsData[index];
            const modal = document.getElementById('detailModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            if (!modal || !modalTitle || !modalBody) {
                console.error('Modal elements not found');
                return;
            }

            modalTitle.textContent = project['Nombre del proyecto'] || 'Proyecto sin nombre';

            // Find ALL matching sectors based on keywords in the intervention area
            const area = project['Área de intervención complementaria'] || '';
            const matchedSectors = [];
            for (const sector of humanitarianSectors) {
                if (sector.keywords.some(keyword =>
                    area.toLowerCase().includes(keyword.toLowerCase())
                )) {
                    matchedSectors.push(sector);
                }
            }

            modalBody.innerHTML = `
                <div class="modal-header-info">
                    ${matchedSectors.length > 0 ? `
                        <div class="modal-sector-badges">
                            ${matchedSectors.map(sector => `
                                <div class="modal-sector-badge" title="${sector.name}">
                                    <img src="${sector.ochaIcon}" alt="${sector.name}" width="24" height="24">
                                    <span>${sector.shortName}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="modal-status-badge">
                        <span class="status-${normalizeStatus(project['Estatus']).toLowerCase().replace(/\s+/g, '-')}">${normalizeStatus(project['Estatus']).charAt(0).toUpperCase() + normalizeStatus(project['Estatus']).slice(1) || 'No especificado'}</span>
                    </div>
                </div>
                
                <div class="modal-field-group">
                    <div class="modal-field">
                        <strong><i class="fas fa-building text-ocha"></i> Organización Líder</strong>
                        <span>${project['Organización Líder'] || 'No especificado'}</span>
                    </div>
                    <div class="modal-field">
                        <strong><i class="fas fa-handshake text-ocha"></i> Organización Implementadora</strong>
                        <span>${project['Organización implementadora'] || 'No especificado'}</span>
                    </div>
                </div>

                <div class="modal-field">
                    <strong><i class="fas fa-crosshairs text-ocha"></i> Área de Intervención</strong>
                    <span>${project['Área de intervención complementaria'] || 'No especificado'}</span>
                </div>

                <div class="modal-field-group">
                    <div class="modal-field">
                        <strong><i class="fas fa-map-marker-alt text-ocha"></i> Municipio</strong>
                        <span>${extractAndNormalizeMunicipalities(project['Municipio']).join(', ') || 'No especificado'}</span>
                    </div>
                    <div class="modal-field">
                        <strong><i class="fas fa-map-pin text-ocha"></i> Parroquias</strong>
                        <span>${project['Parroquias'] || 'No especificado'}</span>
                    </div>
                </div>

                <div class="modal-field-group">
                    <div class="modal-field">
                        <strong><i class="fas fa-calendar-alt text-ocha"></i> Fecha de Inicio</strong>
                        <span>${project['Fecha de Inicio'] ? new Date(project['Fecha de Inicio']).toLocaleDateString('es-ES') : 'No especificado'}</span>
                    </div>
                    <div class="modal-field">
                        <strong><i class="fas fa-calendar-check text-ocha"></i> Fecha de Finalización</strong>
                        <span>${project['Fecha Prevista de Finalización'] ? new Date(project['Fecha Prevista de Finalización']).toLocaleDateString('es-ES') : 'No especificado'}</span>
                    </div>
                </div>

                <div class="modal-field modal-field-full">
                    <strong><i class="fas fa-tasks text-ocha"></i> Descripción de la Actividad</strong>
                    <div class="activity-description">${project['Actividad'] || 'No especificado'}</div>
                </div>
            `;

            modal.classList.add('active');
        }

        function exportToExcel(data, filename) {
            if (data.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            // Get unique projects from expanded data to avoid duplicates
            const uniqueProjects = [];
            const seenProjectIndices = new Set();
            
            data.forEach(expandedProject => {
                const originalIndex = expandedProject._originalIndex;
                if (originalIndex !== undefined && !seenProjectIndices.has(originalIndex)) {
                    seenProjectIndices.add(originalIndex);
                    uniqueProjects.push(projectsData[originalIndex]);
                }
            });

            // If no expanded data available, use data directly but ensure unique projects
            const uniqueData = uniqueProjects.length > 0 ? uniqueProjects : 
                data.filter((project, index, self) => 
                    index === self.findIndex(p => p['Nombre del proyecto'] === project['Nombre del proyecto'] && 
                                                 p['Organización Líder'] === project['Organización Líder'])
                );

            // Prepare data for export with normalized names
            const exportData = uniqueData.map(project => {
                const municipalities = extractAndNormalizeMunicipalities(project['Municipio']);
                return {
                    'Organización Líder': normalizeOrganizationName(project['Organización Líder']) || '',
                    'Organización Implementadora': normalizeOrganizationName(project['Organización implementadora']) || '',
                    'Nombre del Proyecto': project['Nombre del proyecto'] || '',
                    'Área de Intervención': project['Área de intervención complementaria'] || '',
                    'Actividad': project['Actividad'] || '',
                    'Municipio': municipalities.join(', ') || '',
                    'Parroquias': project['Parroquias'] || '',
                    'Estatus': normalizeStatus(project['Estatus']) || '',
                    'Fecha de Inicio': project['Fecha de Inicio'] || '',
                    'Fecha de Finalización': project['Fecha Prevista de Finalización'] || ''
                };
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Proyectos');

            const now = new Date();
            const timestamp = now.toISOString().split('T')[0];
            XLSX.writeFile(wb, `${filename}_${timestamp}.xlsx`);
        }

        function exportToPDF(data, filename) {
            if (data.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

            // Add header with dynamic state/filter info
            const stateNames = {
                'Zulia': 'Zulia',
                'Falcón': 'Falcón',
                'Lara': 'Lara',
                'Trujillo': 'Trujillo',
                'Todos': 'Zulia, Falcón, Lara y Trujillo'
            };
            const selectedState = stateNames[currentState] || 'Zulia, Falcón, Lara y Trujillo';
            const municipios = getSelectedMunicipalities();

            // Build title based on filters
            let mainTitle = 'Registro de Proyectos Humanitarios ';
            if (municipios.length === 1) {
                mainTitle += `- Municipio ${municipios[0]}`;
            } else if (municipios.length > 1) {
                mainTitle += `- ${municipios.length} Municipios Seleccionados`;
            } else {
                mainTitle += `- ${selectedState}`;
            }

            doc.setFontSize(16);
            doc.setTextColor(0, 93, 146); // OCHA Blue
            doc.text(mainTitle, 15, 15);

            doc.setFontSize(12);
            doc.setTextColor(90, 90, 90); // OCHA Gray
            doc.text('Sub Oficina OCHA Maracaibo', 15, 23);

            // Get unique projects from expanded data to avoid duplicates
            const uniqueProjects = [];
            const seenProjectIndices = new Set();
            
            data.forEach(expandedProject => {
                const originalIndex = expandedProject._originalIndex;
                if (originalIndex !== undefined && !seenProjectIndices.has(originalIndex)) {
                    seenProjectIndices.add(originalIndex);
                    uniqueProjects.push(projectsData[originalIndex]);
                }
            });

            // If no expanded data available, use data directly but ensure unique projects
            const uniqueData = uniqueProjects.length > 0 ? uniqueProjects : 
                data.filter((project, index, self) => 
                    index === self.findIndex(p => p['Nombre del proyecto'] === project['Nombre del proyecto'] && 
                                                 p['Organización Líder'] === project['Organización Líder'])
                );

            // Add filters summary - improved formatting
            const activeFilters = [];
            if (currentFilters.org) activeFilters.push(`Organización: ${currentFilters.org}`);
            if (currentFilters.municipio && currentFilters.municipio.length > 0) {
                if (currentFilters.municipio.length === 1) {
                    activeFilters.push(`Municipio: ${currentFilters.municipio[0]}`);
                } else {
                    activeFilters.push(`Municipios (${currentFilters.municipio.length}): ${currentFilters.municipio.join(', ')}`);
                }
            }
            if (currentFilters.estatus) activeFilters.push(`Estatus: ${currentFilters.estatus}`);
            if (currentFilters.dateStart || currentFilters.dateEnd) {
                activeFilters.push(`Período: ${currentFilters.dateStart || 'N/A'} - ${currentFilters.dateEnd || 'N/A'}`);
            }

            if (activeFilters.length > 0) {
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                let yPos = 28;
                activeFilters.forEach((filter, index) => {
                    doc.text(`• ${filter}`, 15, yPos);
                    yPos += 4;
                });
                // Reset color for table
                doc.setTextColor(0, 0, 0);
            }

            // Prepare table data with normalized municipality names and sectors
            const tableData = uniqueData.map(project => {
                const municipalities = extractAndNormalizeMunicipalities(project['Municipio']);

                // Extract sector short names from intervention area
                const area = project['Área de intervención complementaria'] || '';
                const matchedSectors = [];
                for (const sector of humanitarianSectors) {
                    if (sector.keywords.some(keyword =>
                        area.toLowerCase().includes(keyword.toLowerCase())
                    )) {
                        matchedSectors.push(sector.shortName);
                    }
                }
                const sectorText = matchedSectors.length > 0 ? matchedSectors.join(', ') : 'N/A';

                return [
                    sectorText, // Sectores
                    normalizeOrganizationName(project['Organización Líder']) || '',
                    project['Nombre del proyecto'] || '',
                    municipalities.join(', ') || '',
                    normalizeStatus(project['Estatus']) || '',
                    project['Fecha de Inicio'] ? new Date(project['Fecha de Inicio']).toLocaleDateString('es-ES') : '',
                    project['Fecha Prevista de Finalización'] ? new Date(project['Fecha Prevista de Finalización']).toLocaleDateString('es-ES') : ''
                ];
            });

            // Calculate optimal column widths for landscape A4
            // Page width = 297mm, margins = 6mm each side = 285mm usable
            const pageWidth = doc.internal.pageSize.getWidth();
            const usableWidth = pageWidth - 12; // 6mm margins on each side

            // Column widths proportionally distributed across usable width
            // Total ratio: 20 + 24 + 80 + 28 + 16 + 16 + 16 = 200 parts
            const columnRatio = [20, 24, 80, 28, 16, 16, 16];
            const columnWidths = columnRatio.map(ratio => (ratio / 200) * usableWidth);

            doc.autoTable({
                head: [['Sectores', 'Organización', 'Proyecto', 'Municipio', 'Estatus', 'F. Inicio', 'F. Fin']],
                body: tableData,
                startY: activeFilters.length > 0 ? 45 : 33,
                styles: {
                    fontSize: 7,
                    cellPadding: 1.8,
                    overflow: 'linebreak',
                    cellWidth: 'wrap',
                    valign: 'middle',
                    halign: 'left',
                    lineColor: [220, 220, 220],
                    lineWidth: 0.1,
                    minCellHeight: 8
                },
                columnStyles: {
                    0: { cellWidth: columnWidths[0], fontSize: 6.5, halign: 'center' }, // Sectores
                    1: { cellWidth: columnWidths[1], fontStyle: 'bold', fontSize: 6.5 }, // Organización
                    2: { cellWidth: columnWidths[2] }, // Proyecto - el más ancho
                    3: { cellWidth: columnWidths[3] }, // Municipio
                    4: { cellWidth: columnWidths[4], halign: 'center', fontSize: 6.5 }, // Estatus
                    5: { cellWidth: columnWidths[5], halign: 'center', fontSize: 6 }, // Fecha Inicio
                    6: { cellWidth: columnWidths[6], halign: 'center', fontSize: 6 }  // Fecha Fin
                },
                headStyles: {
                    fillColor: [0, 93, 146],
                    textColor: [255, 255, 255],
                    fontSize: 7.5,
                    fontStyle: 'bold',
                    halign: 'center',
                    valign: 'middle',
                    cellPadding: 2.2
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                },
                rowPageBreak: 'avoid',
                margin: { left: 6, right: 6, top: 10, bottom: 12 },
                tableWidth: usableWidth,
                didDrawPage: function(data) {
                    // Add page number footer
                    const pageCount = doc.internal.getNumberOfPages();
                    const pageSize = doc.internal.pageSize;
                    const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                    const pageWidth = pageSize.width ? pageSize.width : pageSize.getWidth();

                    doc.setFontSize(7);
                    doc.setTextColor(150);

                    // Page info
                    doc.text(
                        `Página ${data.pageNumber} de ${pageCount}`,
                        6,
                        pageHeight - 8
                    );

                    // Generation date and time
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('es-ES');
                    const timeStr = now.toLocaleTimeString('es-ES');
                    doc.text(
                        `Generado: ${dateStr} ${timeStr}`,
                        pageWidth - 60,
                        pageHeight - 8
                    );
                }
            });

            const now = new Date();
            const timestamp = now.toISOString().split('T')[0];
            doc.save(`${filename}_${timestamp}.pdf`);
        }

        function updateFooterInfo() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleDateString('es-ES') + ' ' + now.toLocaleTimeString('es-ES');
            document.getElementById('totalRecords').textContent = projectsData.length;
        }

        // Helper to get status color for map popups
        function getStatusColor(status) {
            switch (status?.toLowerCase()) {
                case 'activo': return '#7DBA00'; // Green
                case 'en desarrollo': return '#ECA154'; // Orange
                case 'completado': return '#007DBC'; // Blue
                case 'suspendido': return '#CD3A1F'; // Red
                default: return '#5A5A5A'; // Gray
            }
        }

        // Utility functions for footer links
        function showAbout() {
            alert('Proyectos Humanitarios en Zulia\n\nSistema desarrollado para facilitar el seguimiento y coordinación de proyectos humanitarios en los estados de cobertura de la Sub Oficina OCHA Maracaibo (Zulia, Falcón, Lara y Trujillo).');
        }

        function showHelp() {
            alert('Ayuda del Sistema\n\n1. Use los filtros del panel izquierdo para refinar los datos\n2. Haga clic en los sectores humanitarios para filtrar por área\n3. Use el filtro de fechas para ver proyectos en períodos específicos\n4. Haga clic en los marcadores del mapa para ver detalles\n5. Use los botones de exportación para descargar los datos');
        }

        function showContact() {
            document.getElementById('contactModal').classList.add('active');
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
        }

        // Global function to make it accessible from popup buttons
        window.showProjectDetails = showProjectDetails;

        // ========== NEW FUNCTIONALITY: ADD/EDIT PROJECTS AND IMPORT EXCEL ==========

        let editingProjectIndex = -1;
        let importMode = null;

        // Function to update municipalities dropdown based on selected state
        function updateMunicipalitiesInForm(state) {
            const municipioSelect = document.getElementById('formMunicipio');
            const municipalities = getOfficialMunicipalities(state);

            // Clear existing options
            municipioSelect.innerHTML = '<option value="">Seleccionar Municipio...</option>';

            // Add municipalities as options
            municipalities.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio;
                option.textContent = municipio;
                municipioSelect.appendChild(option);
            });
        }

        // Function to detect which state a municipality belongs to
        function detectStateFromMunicipality(municipio) {
            if (!municipio) return 'Zulia'; // Default to Zulia

            const zuliaList = getOfficialMunicipalities('Zulia');
            const falconList = getOfficialMunicipalities('Falcón');
            const laraList = getOfficialMunicipalities('Lara');
            const trujilloList = getOfficialMunicipalities('Trujillo');

            if (zuliaList.includes(municipio)) return 'Zulia';
            if (falconList.includes(municipio)) return 'Falcón';
            if (laraList.includes(municipio)) return 'Lara';
            if (trujilloList.includes(municipio)) return 'Trujillo';

            return 'Zulia'; // Default fallback
        }

        // Setup event listener for state dropdown in form
        function setupFormStateListener() {
            const stateSelect = document.getElementById('formEstado');
            if (stateSelect) {
                stateSelect.addEventListener('change', (e) => {
                    updateMunicipalitiesInForm(e.target.value);
                    // Reset municipality selection when state changes
                    document.getElementById('formMunicipio').value = '';
                });
            }
        }

        // Function to open add project modal
        function openAddProjectModal() {
            editingProjectIndex = -1;
            document.getElementById('editModalTitle').textContent = 'Agregar Proyecto';
            document.getElementById('projectForm').reset();

            // Initialize state dropdown with Zulia as default
            const stateSelect = document.getElementById('formEstado');
            stateSelect.value = 'Zulia';
            updateMunicipalitiesInForm('Zulia');

            // Setup event listener for state changes
            setupFormStateListener();

            document.getElementById('editProjectModal').classList.add('active');
        }

        // Function to edit existing project
        function editProject(index) {
            if (!projectsData || index >= projectsData.length || index < 0) {
                console.error('Invalid project index:', index);
                alert('Error: No se puede editar el proyecto');
                return;
            }

            editingProjectIndex = index;
            const project = projectsData[index];

            document.getElementById('editModalTitle').textContent = 'Editar Proyecto';
            document.getElementById('formCodigo').value = project['Código del proyecto'] || '';
            document.getElementById('formNombre').value = project['Nombre del proyecto'] || '';
            document.getElementById('formOrgLider').value = project['Organización Líder'] || '';
            document.getElementById('formOrgImpl').value = project['Organización implementadora'] || '';
            document.getElementById('formSector').value = project['Área de intervención complementaria'] || '';
            document.getElementById('formArea').value = project['Área de intervención complementaria'] || '';

            // Determine state from municipality
            const municipio = project['Municipio'] || '';
            const state = detectStateFromMunicipality(municipio);
            const stateSelect = document.getElementById('formEstado');
            stateSelect.value = state;

            // Update municipalities dropdown based on detected state
            updateMunicipalitiesInForm(state);

            // Set municipality value
            document.getElementById('formMunicipio').value = municipio;

            document.getElementById('formParroquias').value = project['Parroquias'] || '';
            document.getElementById('formEstatus').value = normalizeStatus(project['Estatus']) || '';
            document.getElementById('formFechaInicio').value = project['Fecha de Inicio'] || '';
            document.getElementById('formFechaFin').value = project['Fecha Prevista de Finalización'] || '';
            document.getElementById('formActividad').value = project['Actividad'] || '';

            // Setup event listener for state changes
            setupFormStateListener();

            document.getElementById('editProjectModal').classList.add('active');
        }

        // Function to close edit modal
        function closeEditModal() {
            document.getElementById('editProjectModal').classList.remove('active');
            document.getElementById('projectForm').reset();
            editingProjectIndex = -1;
        }

        // Variable to store the project index for deletion
        let projectToDeleteIndex = -1;

        // Function to delete project (show confirmation)
        function deleteProject(index) {
            if (!projectsData || index >= projectsData.length || index < 0) {
                console.error('Invalid project index:', index);
                alert('Error: No se puede eliminar el proyecto');
                return;
            }
            projectToDeleteIndex = index;
            document.getElementById('deleteModal').classList.add('active');
        }

        // Function to close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            projectToDeleteIndex = -1;
        }

        // Function to confirm and execute deletion
        async function confirmDeleteProject() {
            if (projectToDeleteIndex < 0) {
                alert('Error: Proyecto no encontrado');
                return;
            }

            const project = projectsData[projectToDeleteIndex];
            const projectCode = project['Código del proyecto'];

            try {
                // Delete from Supabase
                const { error } = await supabaseClient
                    .from('proyectos')
                    .delete()
                    .eq('Código del proyecto', projectCode);

                if (error) {
                    console.error('Supabase delete error:', error);
                    alert('Error al eliminar en Supabase: ' + error.message);
                    return;
                }

                // Remove from local data
                projectsData.splice(projectToDeleteIndex, 1);

                // Update UI
                expandedData = expandProjectData(projectsData);
                applyFilters();
                updateTable();
                updateMapMarkers();
                initializeCharts();

                alert('✓ Proyecto eliminado exitosamente de Supabase');
                closeDeleteModal();
            } catch (e) {
                console.error('Delete error:', e);
                alert('Error al eliminar el proyecto: ' + e.message);
            }
        }

        // Function to delete multiple selected projects
        async function deleteSelectedProjects() {
            const checkedBoxes = document.querySelectorAll('.project-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('Por favor, selecciona al menos un proyecto para eliminar');
                return;
            }

            const confirmDelete = confirm(
                `¿Está seguro de que desea eliminar ${checkedBoxes.length} proyectos seleccionados?\n\nEsta acción no se puede deshacer.`
            );

            if (!confirmDelete) return;

            try {
                let deleted = 0;
                let failed = 0;

                for (const checkbox of checkedBoxes) {
                    const index = parseInt(checkbox.dataset.index);
                    const project = projectsData[index];
                    const projectCode = project['Código del proyecto'];

                    try {
                        const { error } = await supabaseClient
                            .from('proyectos')
                            .delete()
                            .eq('Código del proyecto', projectCode);

                        if (error) {
                            console.error('Error deleting:', projectCode, error);
                            failed++;
                        } else {
                            deleted++;
                        }
                    } catch (e) {
                        console.error('Error deleting:', e);
                        failed++;
                    }
                }

                // Remove deleted projects from local data
                const indicesToRemove = Array.from(checkedBoxes)
                    .map(cb => parseInt(cb.dataset.index))
                    .sort((a, b) => b - a);

                indicesToRemove.forEach(index => {
                    projectsData.splice(index, 1);
                });

                // Update UI
                expandedData = expandProjectData(projectsData);
                applyFilters();
                updateTable();
                updateMapMarkers();
                initializeCharts();

                let message = `✓ Se eliminaron ${deleted} proyecto(s)`;
                if (failed > 0) {
                    message += ` (${failed} fallaron)`;
                }
                alert(message);

            } catch (e) {
                console.error('Bulk delete error:', e);
                alert('Error al eliminar proyectos: ' + e.message);
            }
        }

        // Function to handle form submission
        document.getElementById('projectForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // Combine sector and area for 'Área de intervención complementaria' field
            const selectedSector = document.getElementById('formSector').value || '';
            const additionalArea = document.getElementById('formArea').value.trim() || '';
            const fullArea = selectedSector + (additionalArea ? '; ' + additionalArea : '');

            const projectData = {
                'Código del proyecto': document.getElementById('formCodigo').value.trim(),
                'Nombre del proyecto': document.getElementById('formNombre').value.trim(),
                'Organización Líder': document.getElementById('formOrgLider').value.trim(),
                'Organización implementadora': document.getElementById('formOrgImpl').value.trim(),
                'Área de intervención complementaria': fullArea.trim(),
                'Estado': document.getElementById('formEstado').value,
                'Municipio': document.getElementById('formMunicipio').value.trim(),
                'Parroquias': document.getElementById('formParroquias').value.trim(),
                'Estatus': document.getElementById('formEstatus').value,
                'Fecha de Inicio': document.getElementById('formFechaInicio').value,
                'Fecha Prevista de Finalización': document.getElementById('formFechaFin').value,
                'Actividad': document.getElementById('formActividad').value.trim()
            };

            if (editingProjectIndex >= 0) {
                // Edit existing project
                projectsData[editingProjectIndex] = projectData;
                alert('Proyecto actualizado exitosamente');
            } else {
                // Add new project
                projectsData.push(projectData);
                alert('Proyecto agregado exitosamente');
            }

            // Refresh data and update UI
            expandedData = expandProjectData(projectsData);
            applyFilters();
            updateTable();
            updateMapMarkers();
            initializeCharts();
            closeEditModal();
        });

        // Function to open import modal
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        // Function to close import modal
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            importMode = null;
        }

        // Function to handle import option selection
        function handleImport(mode) {
            importMode = mode;
            closeImportModal();
            document.getElementById('excelFileInput').click();
        }

        // Function to process JSON file
        document.getElementById('jsonFileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);

                    if (!Array.isArray(jsonData)) {
                        alert('El archivo JSON debe contener un array de proyectos');
                        return;
                    }

                    if (jsonData.length === 0) {
                        alert('El archivo JSON está vacío');
                        return;
                    }

                    // Validate that JSON has the required fields
                    const requiredFields = ['Código del proyecto', 'Nombre del proyecto', 'Organización Líder'];
                    const firstRow = jsonData[0];
                    const hasRequiredFields = requiredFields.every(field => field in firstRow);

                    if (!hasRequiredFields) {
                        alert('El archivo JSON no tiene los campos requeridos. Debe incluir: ' + requiredFields.join(', '));
                        return;
                    }

                    // Insert to Supabase
                    const inserted = await insertProjectsToSupabase(jsonData);

                    if (inserted) {
                        alert(`✓ Datos cargados exitosamente en Supabase. Se importaron ${jsonData.length} proyectos desde JSON.`);
                        // Reload from Supabase to sync
                        await reloadDataFromSupabase();
                    } else {
                        alert('⚠️ Error al guardar en Supabase. Intenta de nuevo.');
                    }

                } catch (error) {
                    console.error('Error al procesar el archivo JSON:', error);
                    alert('Error al procesar el archivo JSON. Por favor, verifica que el archivo tenga un formato JSON válido.');
                }
            };

            reader.readAsText(file);

            // Reset file input
            e.target.value = '';
        });

        // Function to process Excel file
        document.getElementById('excelFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        alert('El archivo Excel está vacío o no tiene el formato correcto');
                        return;
                    }

                    // Validate that the Excel has the required columns
                    const requiredColumns = ['Código del proyecto', 'Nombre del proyecto', 'Organización Líder'];
                    const firstRow = jsonData[0];
                    const hasRequiredColumns = requiredColumns.every(col => col in firstRow);

                    if (!hasRequiredColumns) {
                        alert('El archivo Excel no tiene las columnas requeridas. Debe incluir: ' + requiredColumns.join(', '));
                        return;
                    }

                    // Insert to Supabase
                    const inserted = await insertProjectsToSupabase(jsonData);

                    if (inserted) {
                        if (importMode === 'replace') {
                            // Replace all data
                            projectsData = jsonData;
                            alert(`✓ Datos reemplazados exitosamente en Supabase. Se importaron ${jsonData.length} proyectos.`);
                        } else if (importMode === 'merge') {
                            // Merge data (add only new projects based on project code)
                            const existingCodes = new Set(projectsData.map(p => p['Código del proyecto']));
                            let addedCount = 0;

                            jsonData.forEach(project => {
                                if (!existingCodes.has(project['Código del proyecto'])) {
                                    projectsData.push(project);
                                    addedCount++;
                                }
                            });

                            alert(`✓ Merge completado exitosamente en Supabase. Se agregaron ${addedCount} nuevos proyectos.`);
                        }

                        // Reload from Supabase to sync
                        await reloadDataFromSupabase();
                    } else {
                        alert('⚠️ Error al guardar en Supabase. Intenta de nuevo.');
                    }

                } catch (error) {
                    console.error('Error al procesar el archivo Excel:', error);
                    alert('Error al procesar el archivo Excel. Por favor, verifica que el archivo tenga el formato correcto.');
                }
            };

            reader.readAsArrayBuffer(file);

            // Reset file input
            e.target.value = '';
        });

        // Add event listeners for new buttons
        document.getElementById('addProjectBtn').addEventListener('click', openAddProjectModal);
        document.getElementById('importExcelBtn').addEventListener('click', openImportModal);
        document.getElementById('importJsonBtn').addEventListener('click', function() {
            document.getElementById('jsonFileInput').click();
        });
        document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedProjects);

        // Close modals when clicking outside
        document.getElementById('editProjectModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        document.getElementById('importModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImportModal();
            }
        });

        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        document.getElementById('contactModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeContactModal();
            }
        });

        // Make functions globally accessible
        window.editProject = editProject;
        window.deleteProject = deleteProject;
        window.deleteSelectedProjects = deleteSelectedProjects;
        window.closeEditModal = closeEditModal;
        window.closeDeleteModal = closeDeleteModal;
        window.confirmDeleteProject = confirmDeleteProject;
        window.closeImportModal = closeImportModal;
        window.closeContactModal = closeContactModal;
        window.handleImport = handleImport;

    </script>
</body>
</html>
